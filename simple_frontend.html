<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxaid.gov - Your Trusted Tax Filing Partner</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
            --input-bg: #ffffff;
            --input-border: #d1d5db;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-secondary: rgba(45, 55, 72, 0.95);
            --bg-card: rgba(45, 55, 72, 0.95);
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
            --input-bg: #2d3748;
            --input-border: #4a5568;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .header h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        /* Process Steps Styles */
        .process-steps {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 20px;
            margin: 0 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 120px;
        }
        
        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .step.completed {
            background: #10b981;
            color: white;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .step.active .step-number {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .step-title {
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        
        /* Tax Calculation Styles */
        .summary-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .summary-item.highlight {
            font-weight: bold;
            font-size: 1.1em;
            color: #2d3748;
            border-bottom: 2px solid #667eea;
        }
        
        .tax-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .tax-regime {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }
        
        .tax-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #2d3748;
            margin: 10px 0;
        }
        
        .tax-breakdown {
            font-size: 0.9em;
            color: #666;
        }
        
        .recommendation {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        
        .recommendation.old-regime {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .recommendation.new-regime {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #1976d2;
        }
        
        .hidden {
            display: none !important;
        }
        
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-display {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .data-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-item:last-child {
            margin-bottom: 0;
        }
        
        .data-item-header {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .data-item-details {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .data-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
            min-width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-edit {
            background: #4299e1;
            color: white;
            border: none;
        }
        
        .btn-edit:hover {
            background: #3182ce;
        }
        
        .btn-delete {
            background: #e53e3e;
            color: white;
            border: none;
        }
        
        .btn-delete:hover {
            background: #c53030;
        }
        
        .locked-status {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: pulse 2s infinite;
        }
        
        .locked-status.locked {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            border-color: #fc8181;
            color: #c53030;
            border-width: 3px;
        }
        
        .locked-status.verified {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            border-color: #68d391;
            color: #2f855a;
            border-width: 3px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .locked-status h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .locked-status p {
            font-size: 1.1rem;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .locked-status .action-button {
            display: inline-block;
            background: #e53e3e;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .locked-status .action-button:hover {
            background: #c53030;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .theme-toggle i {
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover i {
            transform: rotate(180deg);
        }

        /* Tax Calendar Styles */
        .calendar-content {
            margin-top: 20px;
        }

        .calendar-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .calendar-events {
            display: grid;
            gap: 15px;
        }

        .calendar-event {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .calendar-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .calendar-event.urgent {
            border-left: 5px solid #e53e3e;
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        }

        .calendar-event.warning {
            border-left: 5px solid #f6ad55;
            background: linear-gradient(135deg, #fef5e7 0%, #fbd38d 100%);
        }

        .calendar-event.info {
            border-left: 5px solid #4299e1;
            background: linear-gradient(135deg, #ebf8ff 0%, #90cdf4 100%);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .event-date {
            background: var(--bg-primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .event-description {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .event-actions {
            display: flex;
            gap: 10px;
        }

        .event-actions button {
            padding: 5px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-remind {
            background: #4299e1;
            color: white;
        }

        .btn-remind:hover {
            background: #3182ce;
        }

        .btn-complete {
            background: #38a169;
            color: white;
        }

        .btn-complete:hover {
            background: #2f855a;
        }
        
        .btn-undo {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .btn-undo:hover {
            background: #4b5563;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease;
        }
        
        .notification-success {
            border-left: 4px solid #10b981;
        }
        
        .notification-error {
            border-left: 4px solid #ef4444;
        }
        
        .notification-info {
            border-left: 4px solid #3b82f6;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .notification-content i {
            font-size: 18px;
        }
        
        .notification-success .notification-content i {
            color: #10b981;
        }
        
        .notification-error .notification-content i {
            color: #ef4444;
        }
        
        .notification-info .notification-content i {
            color: #3b82f6;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Payment Gateway Styles */
        .payment-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .payment-amount {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 10px;
        }

        .payment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .payment-detail:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .payment-method {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .payment-method:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .payment-method.selected {
            border-color: #4299e1;
            background: linear-gradient(135deg, #ebf8ff 0%, #90cdf4 100%);
        }

        .payment-method i {
            font-size: 2rem;
            color: var(--text-primary);
        }

        .payment-method span {
            font-weight: bold;
            color: var(--text-primary);
        }

        .payment-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .payment-form h4 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .payment-receipt {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .receipt-success {
            color: #38a169;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .receipt-details {
            background: var(--bg-primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .receipt-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Analytics Dashboard Styles */
        .analytics-content {
            margin-top: 20px;
        }

        .analytics-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-placeholder {
            height: 200px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
            border: 2px dashed var(--border-color);
        }

        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .summary-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Reports Section Styles */
        .reports-content {
            margin-top: 20px;
        }

        .reports-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .report-category {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .report-category:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #4299e1;
        }

        .report-category i {
            font-size: 3rem;
            color: #4299e1;
            margin-bottom: 15px;
        }

        .report-category h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .report-category p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Refund Processing Styles */
        .refund-content {
            margin-top: 20px;
        }

        .refund-eligibility {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .refund-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .refund-status {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .refund-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #38a169;
            text-align: center;
            margin: 20px 0;
        }

        .refund-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .refund-detail {
            background: var(--bg-primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .refund-detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .refund-detail-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Validation Styles */
        .form-help {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
            display: block;
        }

        .validation-error {
            color: #e53e3e;
            font-size: 0.8rem;
            margin-top: 5px;
            display: block;
        }

        .form-control:invalid {
            border-color: #e53e3e;
            background-color: #fed7d7;
        }

        .form-control:valid {
            border-color: #38a169;
            background-color: #f0fff4;
        }

        .form-control:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        /* Input limits styling */
        .input-limit {
            position: relative;
        }

        .input-limit::after {
            content: attr(data-limit);
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.8rem;
            pointer-events: none;
        }

        /* Admin Panel Styles */
        .user-role {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Notification System Styles */
        .notification-badge {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            text-align: center;
            line-height: 14px;
            animation: pulse 2s infinite;
            z-index: 10;
        }

        .notification-badge.hidden {
            display: none;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .notification-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .notification-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--bg-secondary);
        }

        .notification-content {
            min-height: 400px;
        }

        .notification-tab-content {
            display: none;
        }

        .notification-tab-content.active {
            display: block;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .notifications-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .notification-item.unread {
            border-left: 4px solid var(--primary-color);
            background: linear-gradient(90deg, rgba(52, 152, 219, 0.1) 0%, var(--bg-secondary) 100%);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .notification-icon.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .notification-icon.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .notification-icon.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .notification-icon.deadline {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .notification-content-item {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .notification-message {
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .notification-time {
            font-size: 0.8rem;
        }

        .notification-actions-item {
            display: flex;
            gap: 5px;
        }

        .notification-action-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .notification-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .settings-section h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .setting-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }

        .setting-label input[type="checkbox"]:checked + .checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .setting-label input[type="checkbox"]:checked + .checkmark::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .setting-description {
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-left: 30px;
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            position: relative;
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid #3498db;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: #27ae60;
        }

        .toast.error .toast-icon {
            color: #e74c3c;
        }

        .toast.warning .toast-icon {
            color: #f39c12;
        }

        .toast.info .toast-icon {
            color: #3498db;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .toast-message {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.slide-out {
            animation: slideOutRight 0.3s ease forwards;
        }

        /* Enhanced Deadline Styles */
        .deadline-item.urgent {
            border-left: 4px solid #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.1) 0%, var(--bg-secondary) 100%);
        }

        .deadline-item.warning {
            border-left: 4px solid #f39c12;
            background: linear-gradient(90deg, rgba(243, 156, 18, 0.1) 0%, var(--bg-secondary) 100%);
        }

        .deadline-item.normal {
            border-left: 4px solid #27ae60;
            background: linear-gradient(90deg, rgba(39, 174, 96, 0.1) 0%, var(--bg-secondary) 100%);
        }

        .deadline-filters label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
        }

        .deadline-filters input[type="radio"] {
            accent-color: var(--primary-color);
        }

        .btn-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .admin-content {
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .admin-tab {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .admin-tab:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }

        .admin-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-card:nth-child(1) .stat-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:nth-child(2) .stat-icon {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card:nth-child(4) .stat-icon {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            color: var(--text-primary);
        }

        .stat-content p {
            margin: 5px 0 0 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .admin-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .chart-container h3 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-actions {
            display: flex;
            gap: 10px;
        }

        .admin-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-filters input,
        .admin-filters select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .admin-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-primary);
        }

        .admin-table th {
            background: var(--accent-color);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .admin-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .admin-table tr:hover {
            background: var(--bg-secondary);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .analytics-card h4 {
            margin: 0 0 15px 0;
            color: var(--text-primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analytics-card h4 i {
            color: var(--primary-color);
        }

        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .summary-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .summary-card:nth-child(1) .summary-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .summary-card:nth-child(2) .summary-icon {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .summary-card:nth-child(3) .summary-icon {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .summary-card:nth-child(4) .summary-icon {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .summary-content {
            flex: 1;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .settings-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .settings-card h4 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .logs-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.error {
            color: #e53e3e;
        }

        .log-entry.warning {
            color: #d69e2e;
        }

        .log-entry.info {
            color: #3182ce;
        }

        .log-entry.success {
            color: #38a169;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-verified {
            background: #bee3f8;
            color: #2a4365;
        }

        .status-unverified {
            background: #faf089;
            color: #744210;
        }

        .status-pending {
            background: #faf089;
            color: #744210;
        }

        .status-approved {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-rejected {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Ticket Details Modal Styles */
        .ticket-details {
            padding: 0;
        }

        .ticket-details .detail-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .ticket-details .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .ticket-details .detail-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ticket-details .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .ticket-details .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .ticket-details .detail-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .ticket-details .detail-value {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .ticket-details .ticket-description {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .ticket-details .ticket-description p {
            margin: 0;
            line-height: 1.6;
        }

        .conversation-thread {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .conversation-thread .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .conversation-thread .user-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .conversation-thread .agent-message {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }

        .conversation-thread .system-message {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            font-style: italic;
        }

        .conversation-thread .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .conversation-thread .sender-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .conversation-thread .message-time {
            font-size: 0.8rem;
            color: #666;
        }

        .conversation-thread .message-text {
            line-height: 1.5;
            color: var(--text-primary);
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-badge.medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .priority-badge.low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.open {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-badge.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-badge.resolved {
            background: #e8f5e8;
            color: #388e3c;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 0 0 12px 12px;
        }

        /* Return Details Styles */
        .return-details {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .detail-section {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .detail-section h4 {
            margin: 0 0 15px 0;
            color: var(--text-primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-item label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-item span {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .highlight-amount {
            font-weight: bold;
            color: #e53e3e !important;
            font-size: 1.1rem !important;
        }

        .monospace {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* Communication System Styles */
        .support-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .support-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .support-tab.active {
            color: var(--text-primary);
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .support-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .support-content {
            padding: 20px 0;
        }

        /* Tickets Styles */
        .tickets-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tickets-filters select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .tickets-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ticket-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .ticket-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .ticket-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .ticket-id {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .ticket-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ticket-status.open {
            background: #e6f3ff;
            color: #0066cc;
        }

        .ticket-status.in-progress {
            background: #fff3cd;
            color: #856404;
        }

        .ticket-status.resolved {
            background: #d4edda;
            color: #155724;
        }

        .ticket-status.closed {
            background: #f8d7da;
            color: #721c24;
        }

        .ticket-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .ticket-priority {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ticket-priority.low {
            background: #e8f5e8;
            color: #2e7d2e;
        }

        .ticket-priority.medium {
            background: #fff3cd;
            color: #856404;
        }

        .ticket-priority.high {
            background: #f8d7da;
            color: #721c24;
        }

        .ticket-priority.urgent {
            background: #dc3545;
            color: white;
        }

        /* Ticket Form Styles */
        .ticket-form {
            max-width: 600px;
        }

        .ticket-form .form-group {
            margin-bottom: 20px;
        }

        .ticket-form textarea {
            resize: vertical;
            min-height: 120px;
        }

        .ticket-form small {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        /* Chat Styles */
        .chat-container {
            max-width: 800px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-header {
            background: var(--bg-secondary);
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.online {
            background: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: var(--bg-primary);
        }

        .chat-message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .chat-message.user .message-avatar {
            background: #28a745;
        }

        .message-content {
            flex: 1;
            max-width: 70%;
        }

        .message-header {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .chat-message.user .message-header {
            flex-direction: row-reverse;
        }

        .sender-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-time {
            color: var(--text-secondary);
        }

        .message-text {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            line-height: 1.4;
        }

        .chat-message.user .message-text {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chat-input {
            padding: 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .chat-input button {
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Help Desk Styles */
        .help-search {
            margin-bottom: 25px;
        }

        .search-container {
            position: relative;
            max-width: 500px;
        }

        .search-container input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .search-container input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-tab {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .category-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .category-tab:hover {
            border-color: #667eea;
            color: var(--text-primary);
        }

        .help-articles {
            display: grid;
            gap: 15px;
        }

        .help-article {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .help-article:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .help-article-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-article-summary {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .help-article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .help-article-category {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 3px 8px;
            border-radius: 12px;
        }

        /* FAQ Styles */
        .faq-search {
            margin-bottom: 25px;
        }

        .faq-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .faq-category-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .faq-category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .faq-category-btn:hover {
            border-color: #667eea;
            color: var(--text-primary);
        }

        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .faq-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .faq-question {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border: none;
            width: 100%;
            text-align: left;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .faq-question:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .faq-question.active {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .faq-icon {
            transition: transform 0.2s ease;
        }

        .faq-question.active .faq-icon {
            transform: rotate(180deg);
        }

        .faq-answer {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .faq-answer.active {
            padding: 20px;
            max-height: 500px;
        }

        .faq-answer-content {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Article Content Styles */
        .article-content {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .article-category {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .article-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .article-content h4 {
            color: var(--text-primary);
            margin: 25px 0 15px 0;
            font-size: 1.2rem;
            font-weight: 600;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }

        .article-content h5 {
            color: var(--text-primary);
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .article-content p {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .article-content ul, .article-content ol {
            margin: 15px 0 15px 20px;
            color: var(--text-primary);
        }

        .article-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .article-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .article-tips {
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }

        .article-tips h5 {
            color: #667eea;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .article-tips ul {
            margin-bottom: 0;
        }

        .article-tips li {
            color: var(--text-primary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .support-tabs {
                flex-direction: column;
            }
            
            .tickets-filters {
                flex-direction: column;
            }
            
            .category-tabs {
                flex-direction: column;
            }
            
            .faq-categories {
                flex-direction: column;
            }
            
            .chat-messages {
                height: 300px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .article-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .status-filed {
            background: #bee3f8;
            color: #2a4365;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-action {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .btn-view {
            background: #667eea;
            color: white;
        }

        .btn-edit {
            background: #3182ce;
            color: white;
        }

        .btn-delete {
            background: #e53e3e;
            color: white;
        }

        .btn-suspend {
            background: #d69e2e;
            color: white;
        }

        .btn-activate {
            background: #38a169;
            color: white;
        }

        .btn-action:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .admin-charts {
                grid-template-columns: 1fr;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-filters {
                flex-direction: column;
            }
            
            .admin-section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
        
        .status {
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s ease;
        }
        
        .password-toggle:hover {
            color: #374151;
        }
        
        .password-container {
            position: relative;
        }
        
        .password-container input {
            padding-right: 40px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .auth-form {
            max-width: 500px;
            margin: 0 auto;
            padding: 40px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .user-info span {
            color: #4a5568;
            font-weight: 600;
        }
        
        .otp-input {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            font-weight: bold;
        }
        
        .admin-panel {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .admin-panel h3 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .otp-display {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            text-align: center;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .profile-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .profile-form {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .profile-info {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .profile-field:last-child {
            border-bottom: none;
        }
        
        .profile-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .profile-value {
            color: #2d3748;
        }
        
        .otp-timer {
            color: #f56565;
            font-weight: bold;
        }
        
        .otp-success {
            color: #48bb78;
        }
        
        .form-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-section h3 i {
            color: #667eea;
        }
        
        .readonly-field {
            background-color: #f7fafc;
            color: #718096;
            cursor: not-allowed;
        }
        
        .pin-help {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 5px;
            display: block;
        }
        
        input[readonly] {
            background-color: #f7fafc;
            color: #718096;
            cursor: not-allowed;
        }
        
        .auto-fill-field {
            background-color: #f0fff4;
            border-color: #68d391;
        }
        
        .conditional-field {
            display: none;
        }
        
        .conditional-field.show {
            display: block;
        }
        
        #employerGroup, #employerCategoryGroup, #profileEmployerGroup, #profileEmployerCategoryGroup {
            display: none;
        }
        
        #employerGroup.show, #employerCategoryGroup.show, #profileEmployerGroup.show, #profileEmployerCategoryGroup.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .form-section {
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Authentication Section -->
        <div id="authSection" class="card full-width">
            <div class="header">
                <h1><i class="fas fa-calculator"></i> Taxaid.gov</h1>
                <p>Your Trusted Tax Filing Partner</p>
                <div id="connectionStatus" class="status info">
                    <div class="loading"></div> Connecting to database...
                </div>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2><i class="fas fa-sign-in-alt"></i> Login</h2>
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        <button type="button" onclick="togglePassword('loginPassword')" class="password-toggle">ðŸ‘ï¸</button>
                    </div>
                </div>
                <div>
                    <button class="btn" onclick="login()">Login</button>
                    <button class="btn btn-info" onclick="showSignupForm()">Create Account</button>
                </div>
                <div id="loginStatus" class="status hidden"></div>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form hidden">
                <h2><i class="fas fa-user-plus"></i> Create Account</h2>
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3><i class="fas fa-user"></i> Basic Information</h3>
                    <div class="form-group">
                        <label for="signupName">Full Name (as per PAN):</label>
                        <input type="text" id="signupName" placeholder="Enter your full name as per PAN" required>
                    </div>
                    <div class="form-group">
                        <label for="signupDOB">Date of Birth:</label>
                        <input type="date" id="signupDOB" required>
                    </div>
                    <div class="form-group">
                        <label for="signupGender">Gender:</label>
                        <select id="signupGender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="signupPhone">Phone Number:</label>
                        <input type="tel" id="signupPhone" placeholder="e.g., 9876543210" maxlength="10" pattern="[6-9][0-9]{9}" required>
                        <small class="form-help">10-digit mobile number starting with 6-9</small>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email Address:</label>
                        <input type="email" id="signupEmail" placeholder="e.g., john.doe@example.com" required>
                        <small class="form-help">Valid email address</small>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password:</label>
                        <div class="password-container">
                            <input type="password" id="signupPassword" placeholder="Enter password" required>
                            <button type="button" onclick="togglePassword('signupPassword')" class="password-toggle">ðŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword">Confirm Password:</label>
                        <div class="password-container">
                            <input type="password" id="signupConfirmPassword" placeholder="Confirm password" required>
                            <button type="button" onclick="togglePassword('signupConfirmPassword')" class="password-toggle">ðŸ‘ï¸</button>
                        </div>
                    </div>
                </div>

                <!-- Identity Information -->
                <div class="form-section">
                    <h3><i class="fas fa-id-card"></i> Identity Information</h3>
                    <div class="form-group">
                        <label for="signupPAN">PAN Number:</label>
                        <input type="text" id="signupPAN" placeholder="e.g., ABCDE1234F" maxlength="10" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" required>
                        <small class="form-help">Format: ABCDE1234F (5 letters + 4 digits + 1 letter)</small>
                    </div>
                    <div class="form-group">
                        <label for="signupAadhaar">Aadhaar Number:</label>
                        <input type="text" id="signupAadhaar" placeholder="e.g., 1234 5678 9012" maxlength="14" pattern="[0-9\s]{12,14}" required oninput="formatAadhaar(this)" onkeypress="return isNumberKey(event)">
                        <small class="form-help">12 digits (spaces optional)</small>
                    </div>
                    <div class="form-group">
                        <label for="signupPassport">Passport Number (Optional - for NRIs):</label>
                        <input type="text" id="signupPassport" placeholder="Enter passport number if applicable">
                    </div>
                </div>

                <!-- Address Information -->
                <div class="form-section">
                    <h3><i class="fas fa-home"></i> Address Information</h3>
                    <div class="form-group">
                        <label for="signupStreetAddress">Street Address (House No, Street, Area):</label>
                        <textarea id="signupStreetAddress" placeholder="Enter house number, street name, area" rows="2" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="signupPinCode">PIN Code:</label>
                        <input type="text" id="signupPinCode" placeholder="e.g., 560001" maxlength="6" pattern="[0-9]{6}" required>
                        <small class="form-help">6-digit PIN code (auto-fetches city/state)</small>
                    </div>
                    <div class="form-group">
                        <label for="signupCity">City:</label>
                        <input type="text" id="signupCity" placeholder="City will be auto-filled or enter manually">
                    </div>
                    <div class="form-group">
                        <label for="signupState">State:</label>
                        <input type="text" id="signupState" placeholder="State will be auto-filled or enter manually">
                    </div>
                    <div class="form-group">
                        <label for="signupPermanentAddress">Permanent Address (if different):</label>
                        <textarea id="signupPermanentAddress" placeholder="Permanent address if different from residential" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="signupCountry">Country:</label>
                        <select id="signupCountry" required>
                            <option value="India" selected>India</option>
                            <option value="USA">USA</option>
                            <option value="UK">UK</option>
                            <option value="Canada">Canada</option>
                            <option value="Australia">Australia</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Employment & Tax Details -->
                <div class="form-section">
                    <h3><i class="fas fa-briefcase"></i> Employment & Tax Details</h3>
                    <div class="form-group">
                        <label for="signupOccupation">Occupation Type:</label>
                        <select id="signupOccupation" required>
                            <option value="">Select Occupation</option>
                            <option value="Salaried">Salaried</option>
                            <option value="Business">Business</option>
                            <option value="Self-Employed">Self-Employed</option>
                            <option value="Retired">Retired</option>
                            <option value="Student">Student</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="employerGroup">
                        <label for="signupEmployer">Employer Name:</label>
                        <input type="text" id="signupEmployer" placeholder="Enter employer name">
                    </div>
                    <div class="form-group" id="employerCategoryGroup">
                        <label for="signupEmployerCategory">Employer Category:</label>
                        <select id="signupEmployerCategory">
                            <option value="">Select Category</option>
                            <option value="Government">Government</option>
                            <option value="Private">Private</option>
                            <option value="PSU">PSU</option>
                            <option value="NGO">NGO</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="signupTaxpayerStatus">Taxpayer Status:</label>
                        <select id="signupTaxpayerStatus" required>
                            <option value="">Select Status</option>
                            <option value="Resident">Resident</option>
                            <option value="Non-Resident">Non-Resident</option>
                            <option value="Senior Citizen">Senior Citizen</option>
                            <option value="Super Senior Citizen">Super Senior Citizen</option>
                        </select>
                    </div>
                </div>

                <!-- Bank Details Section -->
                <div class="form-section">
                    <h3><i class="fas fa-university"></i> Bank Details (Optional - for refunds)</h3>
                    <div class="form-group">
                        <label for="signupBankName">Bank Name:</label>
                        <input type="text" id="signupBankName" placeholder="Enter bank name">
                    </div>
                <div class="form-group">
                    <label for="signupAccountNumber">Account Number:</label>
                    <input type="text" id="signupAccountNumber" placeholder="e.g., 1234567890123456" maxlength="18" pattern="[0-9]{9,18}">
                    <small class="form-help">9-18 digits only</small>
                </div>
                <div class="form-group">
                    <label for="signupIFSC">IFSC Code:</label>
                    <input type="text" id="signupIFSC" placeholder="e.g., SBIN0001234" maxlength="11" pattern="[A-Z]{4}0[A-Z0-9]{6}" oninput="formatIFSC(this)">
                    <small class="form-help">Format: XXXX0XXXXXX (4 letters + 0 + 6 alphanumeric)</small>
                </div>
                    <div class="form-group">
                        <label for="signupAccountHolder">Account Holder Name:</label>
                        <input type="text" id="signupAccountHolder" placeholder="Enter account holder name">
                    </div>
                </div>

                <div>
                    <button class="btn" onclick="signup()">Create Account</button>
                    <button class="btn btn-info" onclick="showLoginForm()">Back to Login</button>
                </div>
                <div id="signupStatus" class="status hidden"></div>
            </div>
            
            <!-- OTP Verification Form -->
            <div id="otpForm" class="auth-form hidden">
                <h2><i class="fas fa-key"></i> Verify Email</h2>
                <p>We've sent a verification code to your email. Please enter it below:</p>
                <div class="otp-display" id="otpDisplay">
                    <div><strong>Email:</strong> <span id="otpEmail"></span></div>
                    <div><strong>OTP Code:</strong> <span id="otpCodeDisplay"></span></div>
                    <div><strong>Expires in:</strong> <span id="otpTimer">10:00</span></div>
                </div>
                <div class="form-group">
                    <label for="otpCode">Verification Code:</label>
                    <input type="text" id="otpCode" placeholder="Enter 6-digit code" maxlength="6" required class="otp-input">
                </div>
                <div>
                    <button class="btn" onclick="verifyOTP()">Verify</button>
                    <button class="btn btn-info" onclick="resendOTP()">Resend Code</button>
                    <button class="btn btn-danger" onclick="cancelSignup()">Cancel</button>
                </div>
                <div id="otpStatus" class="status hidden"></div>
            </div>
        </div>
        
        <!-- Main Application (Hidden until authenticated) -->
        <div id="mainApp" class="hidden">
            <!-- Header -->
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="user-info">
                    <span id="userWelcome">Welcome, <span id="userName"></span>!</span>
                        <span id="userRole" class="user-role hidden"></span>
                    <button class="btn btn-info" onclick="showProfile()">Profile</button>
                    <button class="btn btn-warning" onclick="showNotificationCenter()" id="notificationBtn" style="position: relative;">
                        <i class="fas fa-bell"></i> Notifications
                        <span id="notificationBadge" class="notification-badge hidden">0</span>
                    </button>
                        <button id="adminPanelBtn" class="btn btn-admin hidden" onclick="showAdminPanel()">
                            <i class="fas fa-cog"></i> Admin Panel
                        </button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
                    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                </div>
                <h1><i class="fas fa-calculator"></i> Taxaid.gov</h1>
                <p>Your Trusted Tax Filing Partner</p>
            </div>
            
            <!-- Profile Section -->
            <div id="profileSection" class="card full-width hidden">
                <h2><i class="fas fa-user"></i> User Profile</h2>
                <div class="profile-content">
                    <div class="profile-form">
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Basic Information</h3>
                            <div class="form-group">
                                <label for="profileName">Full Name (as per PAN):</label>
                                <input type="text" id="profileName" placeholder="Enter your full name as per PAN" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div class="form-group">
                                <label for="profileDOB">Date of Birth:</label>
                                <input type="date" id="profileDOB">
                            </div>
                            <div class="form-group">
                                <label for="profileGender">Gender:</label>
                                <select id="profileGender">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="profilePhone">Phone Number:</label>
                                <input type="tel" id="profilePhone" placeholder="e.g., 9876543210" maxlength="10" pattern="[6-9][0-9]{9}">
                                <small class="form-help">10-digit mobile number starting with 6-9</small>
                            </div>
                            <div class="form-group">
                                <label for="profileEmail">Email Address:</label>
                                <input type="email" id="profileEmail" placeholder="e.g., john.doe@example.com" readonly>
                                <small class="form-help">Valid email address (read-only)</small>
                            </div>
                        </div>

                        <!-- Identity Information -->
                        <div class="form-section">
                            <h3><i class="fas fa-id-card"></i> Identity Information</h3>
                            <div class="form-group">
                                <label for="profilePAN">PAN Number:</label>
                                <input type="text" id="profilePAN" placeholder="e.g., ABCDE1234F" maxlength="10" readonly>
                                <small class="form-help">Format: ABCDE1234F (read-only)</small>
                            </div>
                            <div class="form-group">
                                <label for="profileAadhaar">Aadhaar Number:</label>
                                <input type="text" id="profileAadhaar" placeholder="e.g., 1234 5678 9012" maxlength="14" readonly>
                                <small class="form-help">12 digits (read-only)</small>
                            </div>
                            <div class="form-group">
                                <label for="profilePassport">Passport Number:</label>
                                <input type="text" id="profilePassport" placeholder="Enter passport number if applicable" oninput="this.value = this.value.toUpperCase()">
                            </div>
                        </div>

                        <!-- Address Information -->
                        <div class="form-section">
                            <h3><i class="fas fa-home"></i> Address Information</h3>
                            <div class="form-group">
                                <label for="profileStreetAddress">Street Address (House No, Street, Area):</label>
                                <textarea id="profileStreetAddress" placeholder="Enter house number, street name, area" rows="2" oninput="this.value = this.value.toUpperCase()"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="profilePinCode">PIN Code:</label>
                                <input type="text" id="profilePinCode" placeholder="e.g., 560001" maxlength="6" pattern="[0-9]{6}">
                                <small class="form-help">6-digit PIN code (auto-fetches city/state)</small>
                            </div>
                            <div class="form-group">
                                <label for="profileCity">City:</label>
                                <input type="text" id="profileCity" placeholder="City will be auto-filled or enter manually" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div class="form-group">
                                <label for="profileState">State:</label>
                                <input type="text" id="profileState" placeholder="State will be auto-filled or enter manually" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div class="form-group">
                                <label for="permanentAddressOption">Permanent Address:</label>
                                <select id="permanentAddressOption" onchange="togglePermanentAddressFields()">
                                    <option value="same">Same as Residential Address</option>
                                    <option value="different">Different Address</option>
                                </select>
                            </div>
                            <div id="permanentAddressFields" class="hidden">
                                <div class="form-group">
                                    <label for="profilePermanentStreetAddress">Permanent Street Address:</label>
                                    <input type="text" id="profilePermanentStreetAddress" placeholder="Enter permanent street address" oninput="this.value = this.value.toUpperCase()">
                                </div>
                                <div class="form-group">
                                    <label for="profilePermanentPinCode">Permanent PIN Code:</label>
                                    <input type="text" id="profilePermanentPinCode" placeholder="Enter permanent PIN code" maxlength="6" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                </div>
                                <div class="form-group">
                                    <label for="profilePermanentCity">Permanent City:</label>
                                    <input type="text" id="profilePermanentCity" placeholder="Enter permanent city" oninput="this.value = this.value.toUpperCase()">
                                </div>
                                <div class="form-group">
                                    <label for="profilePermanentState">Permanent State:</label>
                                    <input type="text" id="profilePermanentState" placeholder="Enter permanent state" oninput="this.value = this.value.toUpperCase()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="profilePermanentAddress">Permanent Address (Auto-generated):</label>
                                <textarea id="profilePermanentAddress" placeholder="Permanent address will be auto-generated" rows="2" readonly></textarea>
                            </div>
                            <div class="form-group">
                                <label for="profileCountry">Country:</label>
                                <select id="profileCountry">
                                    <option value="India" selected>India</option>
                                    <option value="USA">USA</option>
                                    <option value="UK">UK</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Employment & Tax Details -->
                        <div class="form-section">
                            <h3><i class="fas fa-briefcase"></i> Employment & Tax Details</h3>
                            <div class="form-group">
                                <label for="profileOccupation">Occupation Type:</label>
                                <select id="profileOccupation">
                                    <option value="">Select Occupation</option>
                                    <option value="Salaried">Salaried</option>
                                    <option value="Business">Business</option>
                                    <option value="Self-Employed">Self-Employed</option>
                                    <option value="Retired">Retired</option>
                                    <option value="Student">Student</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group" id="profileEmployerGroup">
                                <label for="profileEmployer">Employer Name:</label>
                                <input type="text" id="profileEmployer" placeholder="Enter employer name" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div class="form-group" id="profileEmployerCategoryGroup">
                                <label for="profileEmployerCategory">Employer Category:</label>
                                <select id="profileEmployerCategory">
                                    <option value="">Select Category</option>
                                    <option value="Government">Government</option>
                                    <option value="Private">Private</option>
                                    <option value="PSU">PSU</option>
                                    <option value="NGO">NGO</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="profileTaxpayerStatus">Taxpayer Status:</label>
                                <select id="profileTaxpayerStatus">
                                    <option value="">Select Status</option>
                                    <option value="Resident">Resident</option>
                                    <option value="Non-Resident">Non-Resident</option>
                                    <option value="Senior Citizen">Senior Citizen</option>
                                    <option value="Super Senior Citizen">Super Senior Citizen</option>
                                </select>
                            </div>
                        </div>

                        <!-- Bank Details Section -->
                        <div class="form-section">
                            <h3><i class="fas fa-university"></i> Bank Details (for refunds)</h3>
                            <div class="form-group">
                                <label for="profileBankName">Bank Name:</label>
                                <input type="text" id="profileBankName" placeholder="Enter bank name">
                            </div>
                <div class="form-group">
                    <label for="profileAccountNumber">Account Number:</label>
                    <input type="text" id="profileAccountNumber" placeholder="e.g., 1234567890123456" maxlength="18" pattern="[0-9]{9,18}">
                    <small class="form-help">9-18 digits only</small>
                </div>
                <div class="form-group">
                    <label for="profileIFSC">IFSC Code:</label>
                    <input type="text" id="profileIFSC" placeholder="e.g., SBIN0001234" maxlength="11" pattern="[A-Z]{4}0[A-Z0-9]{6}" oninput="formatIFSC(this)">
                    <small class="form-help">Format: XXXX0XXXXXX (4 letters + 0 + 6 alphanumeric)</small>
                </div>
                            <div class="form-group">
                                <label for="profileAccountHolder">Account Holder Name:</label>
                                <input type="text" id="profileAccountHolder" placeholder="Enter account holder name">
                            </div>
                        </div>

                        <div>
                            <button class="btn" onclick="updateProfile()">Update Profile</button>
                            <button class="btn btn-info" onclick="hideProfile()">Close</button>
                        </div>
                        <div id="profileStatus" class="status hidden"></div>
                    </div>
                </div>
            </div>
        
        <!-- Stats Dashboard -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="usersCount">-</div>
                <div class="stat-label">Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="incomeCount">-</div>
                <div class="stat-label">Income Sources</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="taxReturnsCount">-</div>
                <div class="stat-label">Tax Returns</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deductionsCount">-</div>
                <div class="stat-label">Deductions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="documentsCount">-</div>
                <div class="stat-label">Documents</div>
            </div>
        </div>
        
        <!-- Process Steps Indicator -->
        <div class="process-steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-title">File Return</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-title">Income Details</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-title">Deductions</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-title">Review & Calculate</div>
            </div>
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <div class="step-title">Submit Return</div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Step 1: File Return Management (First) -->
            <div class="card" id="fileReturnCard">
                <h2><i class="fas fa-file-download"></i> File Income Tax Return</h2>
                <div class="form-group">
                    <label for="assessmentYear">Assessment Year:</label>
                    <select id="assessmentYear">
                        <option value="2024-25">2024-25</option>
                        <option value="2025-26">2025-26</option>
                        <option value="2026-27">2026-27</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="financialYear">Financial Year:</label>
                    <select id="financialYear">
                        <option value="2023-24">2023-24</option>
                        <option value="2024-25">2024-25</option>
                        <option value="2025-26">2025-26</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="returnType">ITR Form Type:</label>
                    <select id="returnType">
                        <option value="ITR1">ITR-1 (Salaried Individuals)</option>
                        <option value="ITR2">ITR-2 (Individuals & HUFs)</option>
                        <option value="ITR3">ITR-3 (Business Income)</option>
                        <option value="ITR4">ITR-4 (Presumptive Business)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taxRegime">Tax Regime:</label>
                    <select id="taxRegime" onchange="onTaxRegimeChange()">
                        <option value="old">Old Tax Regime (with deductions)</option>
                        <option value="new">New Tax Regime (with standard deduction)</option>
                    </select>
                </div>
                <div>
                    <button class="btn" onclick="proceedToIncome()">Proceed to Income Details</button>
                    <button class="btn btn-info" onclick="loadFileReturns()">View Previous Returns</button>
                </div>
                <div id="fileReturnsData" class="data-display hidden"></div>
            </div>
            
            <!-- Step 2: Income Management -->
            <div class="card hidden" id="incomeCard">
                <h2><i class="fas fa-money-bill-wave"></i> Income Details</h2>
                <div class="form-group">
                    <label for="incomeType">Income Type:</label>
                    <select id="incomeType">
                        <option value="Salary">Salary</option>
                        <option value="Business">Business/Profession</option>
                        <option value="House Property">House Property</option>
                        <option value="Capital Gains">Capital Gains</option>
                        <option value="Other Sources">Other Sources</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="incomeAmount">Amount (â‚¹):</label>
                    <input type="number" id="incomeAmount" placeholder="e.g., 500000" min="0" max="999999999" step="0.01" onchange="calculateTaxableIncome()" onblur="validateIncomeAmount()">
                    <small class="form-help">Maximum: â‚¹99,99,99,999</small>
                </div>
                <div class="form-group">
                    <label for="incomeYear">Financial Year:</label>
                    <input type="text" id="incomeYear" placeholder="2023-24" value="2023-24" readonly>
                </div>
                <div>
                    <button class="btn" onclick="addIncome()" id="addIncomeBtn">Add Income</button>
                    <button class="btn btn-info" onclick="loadIncome()">View Income</button>
                    <button class="btn btn-secondary" onclick="proceedToDeductions()">Proceed to Deductions</button>
                    <button class="btn btn-secondary" onclick="goBackToFileReturn()">
                        <i class="fas fa-arrow-left"></i> Back to File Return
                    </button>
                </div>
                <div id="incomeLockedWarning" class="locked-status locked hidden" style="margin-top: 15px;">
                    <h4><i class="fas fa-lock"></i> Income Editing Locked</h4>
                    <p>Your return has been submitted. Income sources cannot be modified.</p>
                    <p>Use "File Revised Return" to make changes.</p>
                </div>
                <div id="incomeData" class="data-display hidden"></div>
            </div>
            
            <!-- Step 3: Deductions -->
            <div class="card hidden" id="deductionsCard">
                <h2><i class="fas fa-receipt"></i> Deductions</h2>
                <div class="form-group">
                    <label for="deductionSection">Section Code:</label>
                    <select id="deductionSection">
                        <!-- Options will be populated dynamically based on tax regime -->
                    </select>
                    <div id="deductionRegimeInfo" class="info-box hidden">
                        <small>Deductions shown are specific to the selected tax regime</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="deductionAmount">Amount (â‚¹):</label>
                    <input type="number" id="deductionAmount" placeholder="e.g., 150000" min="0" max="150000" step="0.01" onchange="validateDeductionLimit()" onblur="validateDeductionAmount()">
                    <small class="form-help">Maximum: â‚¹1,50,000 (80C limit)</small>
                </div>
                <div class="form-group">
                    <label for="deductionYear">Financial Year:</label>
                    <input type="text" id="deductionYear" placeholder="2023-24" value="2023-24" readonly>
                </div>
                <div id="deductionLimitInfo" class="info-box hidden"></div>
                <div>
                    <button class="btn" onclick="addDeduction()" id="addDeductionBtn">Add Deduction</button>
                    <button class="btn btn-info" onclick="loadDeductions()">View Deductions</button>
                    <button class="btn btn-warning" onclick="goBackToIncome()">â† Back to Income</button>
                    <button class="btn btn-secondary" onclick="proceedToReview()">Proceed to Review</button>
                </div>
                <div id="deductionLockedWarning" class="locked-status locked hidden" style="margin-top: 15px;">
                    <h4><i class="fas fa-lock"></i> Deduction Editing Locked</h4>
                    <p>Your return has been submitted. Deductions cannot be modified.</p>
                    <p>Use "File Revised Return" to make changes.</p>
                </div>
                <div id="deductionsData" class="data-display hidden"></div>
            </div>
            
            <!-- Payment Gateway -->
            <div class="card hidden" id="paymentCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-credit-card"></i> Payment Gateway</h2>
                    <button class="btn btn-secondary" onclick="goBackToReview()">
                        <i class="fas fa-arrow-left"></i> Back to Review
                    </button>
                </div>
                <div id="paymentSummary" class="payment-summary">
                    <!-- Payment summary will be populated here -->
                </div>
                <div id="paymentOptions" class="payment-options hidden">
                    <h3>Select Payment Method</h3>
                    <div class="payment-methods">
                        <div class="payment-method" onclick="selectPaymentMethod('netbanking')">
                            <i class="fas fa-university"></i>
                            <span>Net Banking</span>
                        </div>
                        <div class="payment-method" onclick="selectPaymentMethod('upi')">
                            <i class="fas fa-mobile-alt"></i>
                            <span>UPI</span>
                        </div>
                        <div class="payment-method" onclick="selectPaymentMethod('card')">
                            <i class="fas fa-credit-card"></i>
                            <span>Debit/Credit Card</span>
                        </div>
                        <div class="payment-method" onclick="selectPaymentMethod('neft')">
                            <i class="fas fa-exchange-alt"></i>
                            <span>NEFT/RTGS</span>
                        </div>
                        <div class="payment-method" onclick="selectPaymentMethod('challan')">
                            <i class="fas fa-file-invoice"></i>
                            <span>Tax Challan (280)</span>
                        </div>
                    </div>
                    <div id="paymentForm" class="payment-form hidden">
                        <!-- Payment form will be populated based on selected method -->
                    </div>
                </div>
                <div id="paymentReceipt" class="payment-receipt hidden">
                    <!-- Payment receipt will be shown here -->
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="card hidden" id="analyticsCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>
                    <button class="btn btn-secondary" onclick="goBackToDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
                <div class="analytics-content">
                    <div class="analytics-filters">
                        <button class="btn btn-info" onclick="showIncomeAnalytics()">Income Trends</button>
                        <button class="btn btn-warning" onclick="showTaxAnalytics()">Tax Analysis</button>
                        <button class="btn btn-success" onclick="showDeductionAnalytics()">Deduction Insights</button>
                        <button class="btn btn-secondary" onclick="showYearlyComparison()">Yearly Comparison</button>
                    </div>
                    <div id="analyticsCharts" class="analytics-charts">
                        <!-- Charts will be populated here -->
                    </div>
                    <div id="analyticsSummary" class="analytics-summary">
                        <!-- Summary statistics will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div class="card hidden" id="reportsCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-file-alt"></i> Reports & Documents</h2>
                    <button class="btn btn-secondary" onclick="goBackToDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
                <div class="reports-content">
                    <div class="reports-categories">
                        <div class="report-category" onclick="generateTaxReport()">
                            <i class="fas fa-calculator"></i>
                            <h3>Tax Summary Report</h3>
                            <p>Comprehensive tax calculation and breakdown</p>
                        </div>
                        <div class="report-category" onclick="generateIncomeReport()">
                            <i class="fas fa-rupee-sign"></i>
                            <h3>Income Statement</h3>
                            <p>Detailed income sources and analysis</p>
                        </div>
                        <div class="report-category" onclick="generateDeductionReport()">
                            <i class="fas fa-receipt"></i>
                            <h3>Deduction Report</h3>
                            <p>All deductions and savings analysis</p>
                        </div>
                        <div class="report-category" onclick="generateRefundReport()">
                            <i class="fas fa-undo"></i>
                            <h3>Refund Application</h3>
                            <p>Tax refund request and processing</p>
                        </div>
                        <div class="report-category" onclick="generateComplianceReport()">
                            <i class="fas fa-shield-alt"></i>
                            <h3>Compliance Report</h3>
                            <p>Tax compliance and filing status</p>
                        </div>
                        <div class="report-category" onclick="generateAllReports()">
                            <i class="fas fa-download"></i>
                            <h3>All Reports (ZIP)</h3>
                            <p>Download all reports in a single package</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Refund Processing -->
            <div class="card hidden" id="refundCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-undo"></i> Tax Refund Processing</h2>
                    <button class="btn btn-secondary" onclick="goBackToDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
                <div class="refund-content">
                    <div id="refundEligibility" class="refund-eligibility">
                        <!-- Refund eligibility will be shown here -->
                    </div>
                    <div id="refundForm" class="refund-form hidden">
                        <!-- Refund application form will be shown here -->
                    </div>
                    <div id="refundStatus" class="refund-status hidden">
                        <!-- Refund status will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Notification Center -->
            <div id="notificationCenterCard" class="card full-width hidden">
                <div class="notification-header">
                    <h2><i class="fas fa-bell"></i> Notification Center</h2>
                    <button class="btn btn-secondary" onclick="hideNotificationCenter()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
                
                <div class="notification-tabs">
                    <button class="notification-tab active" onclick="showNotificationTab('all')">
                        <i class="fas fa-list"></i> All Notifications
                    </button>
                    <button class="notification-tab" onclick="showNotificationTab('unread')">
                        <i class="fas fa-envelope"></i> Unread
                    </button>
                    <button class="notification-tab" onclick="showNotificationTab('deadlines')">
                        <i class="fas fa-calendar-alt"></i> Deadlines
                    </button>
                    <button class="notification-tab" onclick="showNotificationTab('alerts')">
                        <i class="fas fa-exclamation-triangle"></i> Alerts
                    </button>
                    <button class="notification-tab" onclick="showNotificationTab('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>
                
                <div class="notification-content">
                    <!-- All Notifications Tab -->
                    <div id="allNotifications" class="notification-tab-content active">
                        <div class="notification-actions">
                            <button class="btn btn-primary" onclick="markAllAsRead()">
                                <i class="fas fa-check-double"></i> Mark All as Read
                            </button>
                            <button class="btn btn-danger" onclick="clearAllNotifications()">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                        <div id="notificationsList" class="notifications-list">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Unread Notifications Tab -->
                    <div id="unreadNotifications" class="notification-tab-content">
                        <div class="notification-actions">
                            <button class="btn btn-primary" onclick="markAllAsRead()">
                                <i class="fas fa-check-double"></i> Mark All as Read
                            </button>
                        </div>
                        <div id="unreadList" class="notifications-list">
                            <!-- Unread notifications will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Deadlines Tab -->
                    <div id="deadlineNotifications" class="notification-tab-content">
                        <div class="notification-actions">
                            <button class="btn btn-info" onclick="checkUpcomingDeadlines()">
                                <i class="fas fa-calendar-check"></i> Check Upcoming Deadlines
                            </button>
                            <button class="btn btn-success" onclick="setDeadlineReminder()">
                                <i class="fas fa-bell"></i> Set Reminder
                            </button>
                            <button class="btn btn-secondary" onclick="viewTaxCalendar()">
                                <i class="fas fa-calendar-alt"></i> View Tax Calendar
                            </button>
                        </div>
                        <div class="deadline-filters" style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <label style="margin-right: 15px;">
                                <input type="radio" name="deadlineFilter" value="upcoming" checked onchange="filterDeadlines(this.value)"> Upcoming
                            </label>
                            <label style="margin-right: 15px;">
                                <input type="radio" name="deadlineFilter" value="overdue" onchange="filterDeadlines(this.value)"> Overdue
                            </label>
                            <label style="margin-right: 15px;">
                                <input type="radio" name="deadlineFilter" value="completed" onchange="filterDeadlines(this.value)"> Completed
                            </label>
                            <label>
                                <input type="radio" name="deadlineFilter" value="all" onchange="filterDeadlines(this.value)"> All
                            </label>
                        </div>
                        <div id="deadlineList" class="notifications-list">
                            <!-- Deadline notifications will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Alerts Tab -->
                    <div id="alertNotifications" class="notification-tab-content">
                        <div id="alertList" class="notifications-list">
                            <!-- Alert notifications will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="notificationSettings" class="notification-tab-content">
                        <div class="settings-section">
                            <h3><i class="fas fa-bell"></i> Notification Preferences</h3>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="emailNotifications" checked>
                                    <span class="checkmark"></span>
                                    Email Notifications
                                </label>
                                <p class="setting-description">Receive notifications via email for important updates</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="browserNotifications" checked>
                                    <span class="checkmark"></span>
                                    Browser Notifications
                                </label>
                                <p class="setting-description">Show desktop notifications for real-time updates</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="smsNotifications">
                                    <span class="checkmark"></span>
                                    SMS Notifications
                                </label>
                                <p class="setting-description">Receive SMS alerts for critical deadlines</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="deadlineReminders" checked>
                                    <span class="checkmark"></span>
                                    Deadline Reminders
                                </label>
                                <p class="setting-description">Get reminded about upcoming tax deadlines</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="paymentAlerts" checked>
                                    <span class="checkmark"></span>
                                    Payment Alerts
                                </label>
                                <p class="setting-description">Notifications for payment confirmations and failures</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="refundUpdates" checked>
                                    <span class="checkmark"></span>
                                    Refund Updates
                                </label>
                                <p class="setting-description">Updates about refund status and processing</p>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h3><i class="fas fa-clock"></i> Reminder Settings</h3>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <span>Deadline Reminder:</span>
                                    <select id="deadlineReminderDays">
                                        <option value="7">7 days before</option>
                                        <option value="3" selected>3 days before</option>
                                        <option value="1">1 day before</option>
                                        <option value="0">On the day</option>
                                    </select>
                                </label>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <span>Quiet Hours:</span>
                                    <input type="time" id="quietStart" value="22:00">
                                    <span>to</span>
                                    <input type="time" id="quietEnd" value="08:00">
                                </label>
                                <p class="setting-description">No notifications during these hours</p>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h3><i class="fas fa-user"></i> Profile Settings</h3>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <span>Notification Frequency:</span>
                                    <select id="notificationFrequency">
                                        <option value="realtime">Real-time</option>
                                        <option value="hourly" selected>Hourly</option>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                    </select>
                                </label>
                                <p class="setting-description">How often to receive notifications</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <span>Email Address:</span>
                                    <input type="email" id="notificationEmail" value="user@example.com" class="form-control">
                                </label>
                                <p class="setting-description">Email address for notifications</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <span>Phone Number:</span>
                                    <input type="tel" id="notificationPhone" value="+91 98765 43210" class="form-control">
                                </label>
                                <p class="setting-description">Phone number for SMS notifications</p>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h3><i class="fas fa-shield-alt"></i> Privacy & Security</h3>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="dataSharing" checked>
                                    <span class="checkmark"></span>
                                    Allow Data Sharing
                                </label>
                                <p class="setting-description">Share anonymous data to improve our services</p>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="marketingEmails">
                                    <span class="checkmark"></span>
                                    Marketing Emails
                                </label>
                                <p class="setting-description">Receive promotional emails and updates</p>
                            </div>
                        </div>
                        
                        <div class="settings-actions">
                            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="testNotification()">
                                <i class="fas fa-bell"></i> Test Notification
                            </button>
                            <button class="btn btn-info" onclick="resetNotificationSettings()">
                                <i class="fas fa-undo"></i> Reset to Default
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Panel Card -->
            <div id="adminPanelCard" class="card hidden">
                <div class="admin-content">
                    <div class="admin-header">
                        <h2><i class="fas fa-cog"></i> Admin Panel</h2>
                        <button class="btn btn-secondary" onclick="hideAdminPanel()">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </button>
                    </div>
                    
                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="showAdminTab('dashboard')">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </button>
                        <button class="admin-tab" onclick="showAdminTab('users')">
                            <i class="fas fa-users"></i> User Management
                        </button>
                        <button class="admin-tab" onclick="showAdminTab('analytics')">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </button>
                        <button class="admin-tab" onclick="showAdminTab('returns')">
                            <i class="fas fa-file-alt"></i> Tax Returns
                        </button>
                        <button class="admin-tab" onclick="showAdminTab('settings')">
                            <i class="fas fa-cog"></i> System Settings
                        </button>
                        <button class="admin-tab" onclick="showAdminTab('logs')">
                            <i class="fas fa-list"></i> System Logs
                        </button>
                    </div>
                    
                    <!-- Admin Dashboard Tab -->
                    <div id="adminDashboard" class="admin-tab-content active">
                        <div class="admin-stats">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="totalUsers">0</h3>
                                    <p>Total Users</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="totalReturns">0</h3>
                                    <p>Tax Returns</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="approvedReturns">0</h3>
                                    <p>Approved Returns</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-rupee-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="totalRevenue">â‚¹0</h3>
                                    <p>Total Revenue</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="admin-charts">
                            <div class="chart-container">
                                <h3>User Registration Trends</h3>
                                <canvas id="userTrendChart" width="400" height="200"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Tax Return Status Distribution</h3>
                                <canvas id="returnStatusChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Management Tab -->
                    <div id="adminUsers" class="admin-tab-content">
                        <div class="admin-section-header">
                            <h3><i class="fas fa-users"></i> User Management</h3>
                            <div class="admin-actions">
                                <button class="btn btn-primary" onclick="addNewUser()">
                                    <i class="fas fa-plus"></i> Add User
                                </button>
                                <button class="btn btn-info" onclick="exportUsers()">
                                    <i class="fas fa-download"></i> Export Users
                                </button>
                            </div>
                        </div>
                        
                        <div class="admin-filters">
                            <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                            <select id="userStatusFilter" onchange="filterUsers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="verified">Verified</option>
                                <option value="unverified">Unverified</option>
                            </select>
                            <select id="userRoleFilter" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="user">User</option>
                            </select>
                        </div>
                        
                        <div class="admin-table-container">
                            <table class="admin-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Analytics Tab -->
                    <div id="adminAnalytics" class="admin-tab-content">
                        <div class="admin-section-header">
                            <h3><i class="fas fa-chart-bar"></i> System Analytics</h3>
                            <div class="admin-actions">
                                <button class="btn btn-primary" onclick="generateAnalyticsReport()">
                                    <i class="fas fa-file-pdf"></i> Generate Report
                                </button>
                            </div>
                        </div>
                        
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h4><i class="fas fa-chart-pie"></i> Income Sources Distribution</h4>
                                <canvas id="incomeDistributionChart" width="300" height="200"></canvas>
                            </div>
                            <div class="analytics-card">
                                <h4><i class="fas fa-chart-line"></i> Monthly Tax Collection Trends</h4>
                                <canvas id="taxCollectionChart" width="300" height="200"></canvas>
                            </div>
                            <div class="analytics-card">
                                <h4><i class="fas fa-chart-bar"></i> Weekly User Activity</h4>
                                <canvas id="userActivityChart" width="300" height="200"></canvas>
                            </div>
                            <div class="analytics-card">
                                <h4><i class="fas fa-globe"></i> Geographic Distribution</h4>
                                <canvas id="geoDistributionChart" width="300" height="200"></canvas>
                            </div>
                            <div class="analytics-card">
                                <h4><i class="fas fa-trending-up"></i> Monthly Processing Trends</h4>
                                <canvas id="monthlyTrendsChart" width="300" height="200"></canvas>
                            </div>
                            <div class="analytics-card">
                                <h4><i class="fas fa-server"></i> System Performance</h4>
                                <canvas id="systemPerformanceChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                        
                        <!-- Analytics Summary Cards -->
                        <div class="analytics-summary">
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-value">2,847</div>
                                    <div class="summary-label">Total Users</div>
                                </div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-value">1,234</div>
                                    <div class="summary-label">Returns Filed</div>
                                </div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="fas fa-rupee-sign"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-value">â‚¹45.2M</div>
                                    <div class="summary-label">Tax Collected</div>
                                </div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="summary-content">
                                    <div class="summary-value">98.5%</div>
                                    <div class="summary-label">System Uptime</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tax Returns Tab -->
                    <div id="adminReturns" class="admin-tab-content">
                        <div class="admin-section-header">
                            <h3><i class="fas fa-file-alt"></i> Tax Return Management</h3>
                            <div class="admin-actions">
                                <button class="btn btn-success" onclick="approveSelectedReturns()">
                                    <i class="fas fa-check"></i> Approve Selected
                                </button>
                                <button class="btn btn-warning" onclick="rejectSelectedReturns()">
                                    <i class="fas fa-times"></i> Reject Selected
                                </button>
                            </div>
                        </div>
                        
                        <div class="admin-filters">
                            <select id="returnStatusFilter" onchange="filterReturns()">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Filed">Filed</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                            <input type="date" id="returnDateFrom" onchange="filterReturns()">
                            <input type="date" id="returnDateTo" onchange="filterReturns()">
                        </div>
                        
                        <div class="admin-table-container">
                            <table class="admin-table" id="returnsTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllReturns" onchange="toggleAllReturns()"></th>
                                        <th>User</th>
                                        <th>Financial Year</th>
                                        <th>Total Income</th>
                                        <th>Tax Liability</th>
                                        <th>Status</th>
                                        <th>Filing Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="returnsTableBody">
                                    <!-- Returns will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- System Settings Tab -->
                    <div id="adminSettings" class="admin-tab-content">
                        <div class="admin-section-header">
                            <h3><i class="fas fa-cog"></i> System Settings</h3>
                        </div>
                        
                        <div class="settings-grid">
                            <div class="settings-card">
                                <h4>Tax Configuration</h4>
                                <div class="form-group">
                                    <label>Current Financial Year:</label>
                                    <input type="text" id="currentFY" class="form-control" value="2024-25">
                                </div>
                                <div class="form-group">
                                    <label>Tax Filing Deadline:</label>
                                    <input type="date" id="filingDeadline" class="form-control">
                                </div>
                                <button class="btn btn-primary" onclick="updateTaxSettings()">Update</button>
                            </div>
                            
                            <div class="settings-card">
                                <h4>System Configuration</h4>
                                <div class="form-group">
                                    <label>Maintenance Mode:</label>
                                    <input type="checkbox" id="maintenanceMode" onchange="toggleMaintenanceMode()">
                                </div>
                                <div class="form-group">
                                    <label>Email Notifications:</label>
                                    <input type="checkbox" id="emailNotifications" checked>
                                </div>
                                <div class="form-group">
                                    <label>SMS Notifications:</label>
                                    <input type="checkbox" id="smsNotifications">
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h4>Security Settings</h4>
                                <div class="form-group">
                                    <label>Password Policy:</label>
                                    <select id="passwordPolicy" class="form-control">
                                        <option value="basic">Basic (8+ characters)</option>
                                        <option value="medium">Medium (8+ chars, 1 number)</option>
                                        <option value="strong">Strong (8+ chars, 1 number, 1 special)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Session Timeout (minutes):</label>
                                    <input type="number" id="sessionTimeout" class="form-control" value="30" min="5" max="480">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Logs Tab -->
                    <div id="adminLogs" class="admin-tab-content">
                        <div class="admin-section-header">
                            <h3><i class="fas fa-list"></i> System Logs</h3>
                            <div class="admin-actions">
                                <button class="btn btn-info" onclick="refreshLogs()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                                <button class="btn btn-warning" onclick="clearLogs()">
                                    <i class="fas fa-trash"></i> Clear Logs
                                </button>
                            </div>
                        </div>
                        
                        <div class="admin-filters">
                            <select id="logTypeFilter" onchange="filterLogs()">
                                <option value="">All Types</option>
                                <option value="login">Login</option>
                                <option value="registration">Registration</option>
                                <option value="tax_return">Tax Return</option>
                                <option value="payment">Payment</option>
                                <option value="error">Error</option>
                            </select>
                            <input type="date" id="logDateFrom" onchange="filterLogs()">
                            <input type="date" id="logDateTo" onchange="filterLogs()">
                        </div>
                        
                        <div class="logs-container">
                            <div class="log-entry" id="logsContainer">
                                <!-- Logs will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tax Calendar -->
            <div class="card hidden" id="taxCalendarCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-calendar-alt"></i> Tax Calendar</h2>
                    <button class="btn btn-secondary" onclick="goBackToDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
                <div class="calendar-content">
                    <div class="calendar-filters">
                        <button class="btn btn-info" onclick="showCurrentYear()">Current Year</button>
                        <button class="btn btn-secondary" onclick="showNextYear()">Next Year</button>
                        <button class="btn btn-warning" onclick="showAllDeadlines()">All Deadlines</button>
                    </div>
                    <div id="calendarEvents" class="calendar-events">
                        <!-- Calendar events will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Review & Calculate -->
            <div class="card hidden" id="reviewCard">
                <h2><i class="fas fa-calculator"></i> Review & Calculate Tax</h2>
                <div id="taxCalculationSummary">
                    <div class="summary-section">
                        <h3>Income Summary</h3>
                        <div class="summary-item">
                            <span>Total Income:</span>
                            <span id="summaryTotalIncome">â‚¹0</span>
                        </div>
                        <div class="summary-item">
                            <span>Total Deductions:</span>
                            <span id="summaryTotalDeductions">â‚¹0</span>
                        </div>
                        <div class="summary-item highlight">
                            <span>Taxable Income:</span>
                            <span id="summaryTaxableIncome">â‚¹0</span>
                        </div>
                    </div>
                    
                    <div class="summary-section">
                        <h3>Tax Calculation</h3>
                        <div class="tax-comparison">
                            <div class="tax-regime">
                                <h4>Old Regime</h4>
                                <div class="tax-amount" id="oldRegimeTax">â‚¹0</div>
                                <div class="tax-breakdown" id="oldRegimeBreakdown"></div>
                            </div>
                            <div class="tax-regime">
                                <h4>New Regime</h4>
                                <div class="tax-amount" id="newRegimeTax">â‚¹0</div>
                                <div class="tax-breakdown" id="newRegimeBreakdown"></div>
                            </div>
                        </div>
                        <div class="recommendation" id="taxRecommendation"></div>
                    </div>
                </div>
                <div>
                    <button class="btn" onclick="generateFileReturn()">Generate File Return</button>
                    <button class="btn btn-success" onclick="submitReturn()">Submit Return</button>
                    <button class="btn btn-warning" onclick="fileRevisedReturn()">File Revised Return</button>
                    <button class="btn btn-info" onclick="loadFileReturns()">View All Returns</button>
                    <button class="btn btn-secondary" onclick="downloadReturn()">Download Return</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-danger" onclick="payTax()" id="payTaxBtn">
                        <i class="fas fa-credit-card"></i> Pay Tax (if applicable)
                    </button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-info" onclick="showTaxCalendar()">ðŸ“… Tax Calendar</button>
                    <button class="btn btn-warning" onclick="showAnalytics()">ðŸ“Š Analytics</button>
                    <button class="btn btn-secondary" onclick="showReports()">ðŸ“‹ Reports</button>
                    <button class="btn btn-success" onclick="showRefund()">ðŸ’° Refund</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="showSupportCenter()">ðŸŽ§ Support Center</button>
                    <button class="btn btn-info" onclick="showHelpDesk()">â“ Help Desk</button>
                    <button class="btn btn-secondary" onclick="showFAQ()">ðŸ“‹ FAQ</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="goBackToIncome()">â† Back to Income</button>
                    <button class="btn btn-info" onclick="goBackToDeductions()">â† Back to Deductions</button>
                </div>
                <div id="fileReturnsData" class="data-display hidden"></div>
            </div>
            
        </div>

        <!-- Support Center -->
        <div class="card hidden" id="supportCenterCard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-headset"></i> Support Center</h2>
                <button class="btn btn-secondary" onclick="goBackToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>
            
            <div class="support-tabs">
                <button class="support-tab active" onclick="showSupportTab('tickets')">
                    <i class="fas fa-ticket-alt"></i> My Tickets
                </button>
                <button class="support-tab" onclick="showSupportTab('create')">
                    <i class="fas fa-plus"></i> Create Ticket
                </button>
                <button class="support-tab" onclick="showSupportTab('chat')">
                    <i class="fas fa-comments"></i> Live Chat
                </button>
            </div>
            
            <!-- My Tickets Tab -->
            <div id="supportTickets" class="support-content">
                <div class="tickets-filters">
                    <select id="ticketStatusFilter" onchange="filterTickets()">
                        <option value="">All Status</option>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <select id="ticketPriorityFilter" onchange="filterTickets()">
                        <option value="">All Priorities</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="tickets-list" id="ticketsList">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
            
            <!-- Create Ticket Tab -->
            <div id="supportCreate" class="support-content hidden">
                <form id="createTicketForm" class="ticket-form">
                    <div class="form-group">
                        <label for="ticketSubject">Subject:</label>
                        <input type="text" id="ticketSubject" placeholder="Brief description of your issue" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ticketCategory">Category:</label>
                        <select id="ticketCategory" required>
                            <option value="">Select Category</option>
                            <option value="Tax Filing">Tax Filing</option>
                            <option value="Payment Issues">Payment Issues</option>
                            <option value="Account Issues">Account Issues</option>
                            <option value="Technical Support">Technical Support</option>
                            <option value="Refund Issues">Refund Issues</option>
                            <option value="General Inquiry">General Inquiry</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ticketPriority">Priority:</label>
                        <select id="ticketPriority" required>
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ticketDescription">Description:</label>
                        <textarea id="ticketDescription" rows="6" placeholder="Please provide detailed information about your issue..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="ticketAttachment">Attachment (optional):</label>
                        <input type="file" id="ticketAttachment" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <small>Supported formats: PDF, JPG, PNG, DOC, DOCX (Max 5MB)</small>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="createSupportTicket()">
                        <i class="fas fa-paper-plane"></i> Submit Ticket
                    </button>
                </form>
            </div>
            
            <!-- Live Chat Tab -->
            <div id="supportChat" class="support-content hidden">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-status">
                            <span class="status-indicator online"></span>
                            Support Agent Online
                        </div>
                        <div class="chat-actions">
                            <button class="btn btn-sm btn-secondary" onclick="clearChat()">Clear Chat</button>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message agent">
                            <div class="message-avatar">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="sender-name">Support Agent</span>
                                    <span class="message-time">Just now</span>
                                </div>
                        <div class="message-text">
                            Hello! Welcome to Taxaid.gov Support. How can I help you today?
                        </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="chatMessageInput" placeholder="Type your message..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Desk -->
        <div class="card hidden" id="helpDeskCard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-question-circle"></i> Help Desk</h2>
                <button class="btn btn-secondary" onclick="goBackToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>
            
            <div class="help-search">
                <div class="search-container">
                    <input type="text" id="helpSearchInput" placeholder="Search for help articles..." onkeyup="searchHelpArticles()">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <div class="help-categories">
                <div class="category-tabs">
                    <button class="category-tab active" onclick="showHelpCategory('getting-started')">
                        <i class="fas fa-play"></i> Getting Started
                    </button>
                    <button class="category-tab" onclick="showHelpCategory('tax-filing')">
                        <i class="fas fa-file-invoice"></i> Tax Filing
                    </button>
                    <button class="category-tab" onclick="showHelpCategory('payments')">
                        <i class="fas fa-credit-card"></i> Payments
                    </button>
                    <button class="category-tab" onclick="showHelpCategory('account')">
                        <i class="fas fa-user"></i> Account
                    </button>
                    <button class="category-tab" onclick="showHelpCategory('troubleshooting')">
                        <i class="fas fa-tools"></i> Troubleshooting
                    </button>
                </div>
                
                <div class="help-articles" id="helpArticles">
                    <!-- Help articles will be loaded here -->
                </div>
            </div>
        </div>

        <!-- FAQ Section -->
        <div class="card hidden" id="faqCard">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-question"></i> Frequently Asked Questions</h2>
                <button class="btn btn-secondary" onclick="goBackToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>
            
            <div class="faq-search">
                <div class="search-container">
                    <input type="text" id="faqSearchInput" placeholder="Search FAQ..." onkeyup="searchFAQ()">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <div class="faq-categories">
                <button class="faq-category-btn active" onclick="showFAQCategory('all')">All</button>
                <button class="faq-category-btn" onclick="showFAQCategory('general')">General</button>
                <button class="faq-category-btn" onclick="showFAQCategory('tax-filing')">Tax Filing</button>
                <button class="faq-category-btn" onclick="showFAQCategory('payments')">Payments</button>
                <button class="faq-category-btn" onclick="showFAQCategory('refunds')">Refunds</button>
                <button class="faq-category-btn" onclick="showFAQCategory('technical')">Technical</button>
            </div>
            
            <div class="faq-list" id="faqList">
                <!-- FAQ items will be loaded here -->
            </div>
        </div>
        
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://mehhdssgpwzmnawjjozr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1laGhkc3NncHd6bW5hd2pqb3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTUwNDYsImV4cCI6MjA3Mzg5MTA0Nn0.IRnsEnUW0BcfAGqMj0PDynpiLusNV576gCJA0TlVE8c';
        
        let supabase;
        let currentUserId = null;
        let currentUser = null;
        let pendingOTP = null;
        let otpTimer = null;

        // Initialize Supabase
        async function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test connection
                const { data, error } = await supabase.from('roles').select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                document.getElementById('connectionStatus').innerHTML = 'âœ… Connected to database successfully!';
                document.getElementById('connectionStatus').className = 'status success';
                
                // Load initial data
                await refreshStats();
                
            } catch (error) {
                console.error('Supabase connection error:', error);
                document.getElementById('connectionStatus').innerHTML = `âŒ Connection failed: ${error.message}`;
                document.getElementById('connectionStatus').className = 'status error';
            }
        }

        // Refresh statistics
        async function refreshStats() {
            try {
                // Get users count
                const { count: usersCount } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('usersCount').textContent = usersCount || 0;
                
                // Get income count
                const { count: incomeCount } = await supabase
                    .from('income_sources')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('incomeCount').textContent = incomeCount || 0;
                
                // Get tax returns count
                const { count: taxReturnsCount } = await supabase
                    .from('tax_returns')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('taxReturnsCount').textContent = taxReturnsCount || 0;
                
                // Get deductions count
                const { count: deductionsCount } = await supabase
                    .from('deductions')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('deductionsCount').textContent = deductionsCount || 0;
                
                // Get documents count
                const { count: documentsCount } = await supabase
                    .from('document_uploads')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('documentsCount').textContent = documentsCount || 0;
                
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }


        // Add income
        async function addIncome() {
            try {
                if (!currentUserId) {
                    alert('Please create a user first');
                    return;
                }
                
                // Get form elements with null checks
                const sourceTypeElement = document.getElementById('incomeType');
                const amountElement = document.getElementById('incomeAmount');
                const financialYearElement = document.getElementById('incomeYear');
                
                if (!sourceTypeElement || !amountElement || !financialYearElement) {
                    alert('Error: Required form fields not found. Please refresh the page.');
                    return;
                }
                
                const sourceType = sourceTypeElement.value;
                const amount = parseFloat(amountElement.value);
                const financialYearStr = financialYearElement.value;
                
                if (!sourceType || !amount || !financialYearStr) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Validate amount
                if (!validateAmount(amount, 0, 999999999)) {
                    alert('Invalid amount. Maximum: â‚¹99,99,99,999');
                    return;
                }
                
                // Convert "2023-24" to 2024 for database
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                if (!financialYear || isNaN(financialYear)) {
                    alert('Invalid financial year format');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('income_sources')
                    .insert([
                        {
                            user_id: currentUserId,
                            source_type: sourceType,
                            amount,
                            financial_year: financialYear,
                            description: `${sourceType} income`
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                alert(`Income added successfully: ${sourceType} - $${amount}`);
                addNotification('success', 'Income Added', `${sourceType} income of â‚¹${amount.toLocaleString()} has been added successfully.`, 'medium');
                
                // Clear form
                document.getElementById('incomeAmount').value = '';
                
                await refreshStats();
                
            } catch (error) {
                alert(`Error adding income: ${error.message}`);
            }
        }

        // Edit income
        async function editIncome(incomeId) {
            try {
                // Get current income data
                const { data: incomeData, error } = await supabase
                    .from('income_sources')
                    .select('*')
                    .eq('income_id', incomeId)
                    .single();
                
                if (error) throw error;
                
                // Populate form with current data
                document.getElementById('incomeType').value = incomeData.source_type;
                document.getElementById('incomeAmount').value = incomeData.amount;
                document.getElementById('incomeYear').value = `${incomeData.financial_year - 1}-${incomeData.financial_year}`;
                
                // Store the income ID for updating
                document.getElementById('incomeAmount').setAttribute('data-income-id', incomeId);
                
                // Change button text to indicate editing
                const addButton = document.querySelector('button[onclick="addIncome()"]');
                addButton.textContent = 'Update Income';
                addButton.setAttribute('onclick', 'updateIncome()');
                
                // Scroll to form
                document.getElementById('incomeCard').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert(`Error loading income for editing: ${error.message}`);
            }
        }
        
        // Update income
        async function updateIncome() {
            try {
                const incomeId = document.getElementById('incomeAmount').getAttribute('data-income-id');
                
                if (!incomeId) {
                    alert('No income selected for editing');
                    return;
                }
                
                const incomeTypeElement = document.getElementById('incomeType');
                const incomeAmountElement = document.getElementById('incomeAmount');
                const incomeYearElement = document.getElementById('incomeYear');
                
                if (!incomeTypeElement || !incomeAmountElement || !incomeYearElement) {
                    alert('Required form elements not found. Please refresh the page and try again.');
                    return;
                }
                
                const sourceType = incomeTypeElement.value;
                const amount = parseFloat(incomeAmountElement.value);
                const financialYearStr = incomeYearElement.value;
                
                if (!financialYearStr) {
                    alert('Please enter financial year');
                    return;
                }
                
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                if (!sourceType || !amount || !financialYear) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                const { error } = await supabase
                    .from('income_sources')
                    .update({
                        source_type: sourceType,
                        amount: amount,
                        financial_year: financialYear,
                        description: `${sourceType} income`
                    })
                    .eq('income_id', incomeId);
                
                if (error) throw error;
                
                alert('Income updated successfully!');
                
                // Reset form
                document.getElementById('incomeAmount').removeAttribute('data-income-id');
                document.getElementById('incomeAmount').value = '';
                
                // Reset button
                const addButton = document.querySelector('button[onclick="updateIncome()"]');
                addButton.textContent = 'Add Income';
                addButton.setAttribute('onclick', 'addIncome()');
                
                // Reload income list
                await loadIncome();
                
            } catch (error) {
                alert(`Error updating income: ${error.message}`);
            }
        }
        
        // Delete income
        async function deleteIncome(incomeId) {
            try {
                if (!confirm('Are you sure you want to delete this income source?')) {
                    return;
                }
                
                const { error } = await supabase
                    .from('income_sources')
                    .delete()
                    .eq('income_id', incomeId);
                
                if (error) throw error;
                
                alert('Income source deleted successfully!');
                
                // Remove from UI
                const incomeElement = document.getElementById(`income-${incomeId}`);
                if (incomeElement) {
                    incomeElement.remove();
                }
                
                // Reload income list
                await loadIncome();
                
            } catch (error) {
                alert(`Error deleting income: ${error.message}`);
            }
        }

        // Load income
        async function loadIncome() {
            try {
                const { data, error } = await supabase
                    .from('income_sources')
                    .select('income_id, source_type, amount, financial_year, description, created_at')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('incomeData');
                container.classList.remove('hidden');
                
                let html = '';
                if (data.length === 0) {
                    html = '<div class="data-item"><div class="data-item-details">No income sources found</div></div>';
                } else {
                    data.forEach(income => {
                        const createdDate = new Date(income.created_at).toLocaleDateString();
                        html += `
                            <div class="data-item" id="income-${income.income_id}">
                                <div class="data-item-header">
                                    ${income.source_type}
                                    <div class="data-item-actions">
                                        <button class="btn btn-sm btn-edit" onclick="editIncome('${income.income_id}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-delete" onclick="deleteIncome('${income.income_id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="data-item-details">
                                    <strong>Amount:</strong> â‚¹${income.amount.toLocaleString()}<br>
                                    <strong>Financial Year:</strong> ${income.financial_year}<br>
                                    <strong>Description:</strong> ${income.description || 'No description'}<br>
                                    <strong>Added:</strong> ${createdDate}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                alert(`Error loading income: ${error.message}`);
            }
        }

        // Create tax return
        async function createTaxReturn() {
            try {
                if (!currentUserId) {
                    alert('Please create a user first');
                    return;
                }
                
                const financialYear = parseInt(document.getElementById('taxYear').value);
                const totalIncome = parseFloat(document.getElementById('totalIncome').value);
                const taxableIncome = parseFloat(document.getElementById('taxableIncome').value);
                
                if (!financialYear || !totalIncome || !taxableIncome) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                const taxLiability = Math.max(0, taxableIncome * 0.1); // Simple 10% tax
                
                const { data, error } = await supabase
                    .from('tax_returns')
                    .insert([
                        {
                            user_id: currentUserId,
                            financial_year: financialYear,
                            total_income: totalIncome,
                            taxable_income: taxableIncome,
                            tax_liability: taxLiability,
                            status: 'filed'
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                alert(`Tax return created: FY ${financialYear} - Tax: $${taxLiability}`);
                
                // Clear form
                document.getElementById('taxYear').value = '2024';
                document.getElementById('totalIncome').value = '';
                document.getElementById('taxableIncome').value = '';
                
                await refreshStats();
                
            } catch (error) {
                alert(`Error creating tax return: ${error.message}`);
            }
        }

        // Load tax returns
        async function loadTaxReturns() {
            try {
                const { data, error } = await supabase
                    .from('tax_returns')
                    .select('financial_year, total_income, taxable_income, tax_liability, status, created_at');
                
                if (error) throw error;
                
                const container = document.getElementById('taxReturnsData');
                container.classList.remove('hidden');
                
                let html = '';
                if (data.length === 0) {
                    html = '<div class="data-item"><div class="data-item-details">No tax returns found</div></div>';
                } else {
                    data.forEach(return_data => {
                        const createdDate = new Date(return_data.created_at).toLocaleDateString();
                        html += `
                            <div class="data-item">
                                <div class="data-item-header">FY ${return_data.financial_year} Tax Return</div>
                                <div class="data-item-details">
                                    <strong>Total Income:</strong> $${return_data.total_income.toLocaleString()}<br>
                                    <strong>Taxable Income:</strong> $${return_data.taxable_income.toLocaleString()}<br>
                                    <strong>Tax Liability:</strong> $${return_data.tax_liability.toLocaleString()}<br>
                                    <strong>Status:</strong> ${return_data.status}<br>
                                    <strong>Filed:</strong> ${createdDate}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                alert(`Error loading tax returns: ${error.message}`);
            }
        }


        // Process flow navigation functions

        // Load refunds
        async function loadRefunds() {
            try {
                const { data, error } = await supabase
                    .from('refunds')
                    .select('refund_id, amount, status, issued_date, created_at')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('refundsData');
                container.classList.remove('hidden');
                
                let html = '';
                if (data.length === 0) {
                    html = '<div class="data-item"><div class="data-item-details">No refunds found</div></div>';
                } else {
                    data.forEach(refund => {
                        const issuedDate = refund.issued_date ? new Date(refund.issued_date).toLocaleDateString() : 'Not issued';
                        const createdDate = new Date(refund.created_at).toLocaleDateString();
                        const statusClass = refund.status === 'Completed' ? 'status-success' : 
                                          refund.status === 'Cancelled' ? 'status-error' : 'status-warning';
                        html += `
                            <div class="data-item">
                                <div class="data-item-header">Refund #${refund.refund_id.substring(0, 8)}</div>
                                <div class="data-item-details">
                                    <strong>Amount:</strong> $${refund.amount.toLocaleString()}<br>
                                    <strong>Status:</strong> <span class="${statusClass}">${refund.status}</span><br>
                                    <strong>Issued Date:</strong> ${issuedDate}<br>
                                    <strong>Created:</strong> ${createdDate}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                alert(`Error loading refunds: ${error.message}`);
            }
        }

        // Update refund status
        async function updateRefundStatus() {
            try {
                const refundId = prompt('Enter Refund ID to update:');
                if (!refundId) return;

                const newStatus = prompt('Enter new status (Initiated/Completed/Cancelled):');
                if (!newStatus || !['Initiated', 'Completed', 'Cancelled'].includes(newStatus)) {
                    alert('Invalid status. Please use: Initiated, Completed, or Cancelled');
                    return;
                }

                const issuedDate = newStatus === 'Completed' ? new Date().toISOString().split('T')[0] : null;

                const { data, error } = await supabase
                    .from('refunds')
                    .update({
                        status: newStatus,
                        issued_date: issuedDate
                    })
                    .eq('refund_id', refundId)
                    .select();

                if (error) throw error;

                if (data.length === 0) {
                    alert('Refund not found');
                    return;
                }

                alert(`Refund status updated to ${newStatus}`);
                
                // Refresh refunds display
                await loadRefunds();

            } catch (error) {
                alert(`Error updating refund status: ${error.message}`);
            }
        }

        // Add deduction
        async function addDeduction() {
            try {
                if (!currentUserId) {
                    alert('Please create a user first');
                    return;
                }
                
                // Get form elements with null checks
                const sectionElement = document.getElementById('deductionSection');
                const amountElement = document.getElementById('deductionAmount');
                const financialYearElement = document.getElementById('deductionYear');
                
                if (!sectionElement || !amountElement || !financialYearElement) {
                    alert('Error: Required form fields not found. Please refresh the page.');
                    return;
                }
                
                const sectionCode = sectionElement.value;
                const amount = parseFloat(amountElement.value);
                const financialYearStr = financialYearElement.value;
                
                if (!sectionCode || !amount || !financialYearStr) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Validate deduction amount based on section limits
                const limits = {
                    '80C': 150000,
                    '80D': 25000,
                    '80E': 200000,
                    '80G': 50000,
                    '80TTA': 10000,
                    '80TTB': 50000,
                    'HRA': 1000000,
                    'LTA': 100000,
                    'Medical': 15000,
                    'Standard Deduction': 50000
                };

                const maxLimit = limits[sectionCode] || 150000;
                if (!validateAmount(amount, 0, maxLimit)) {
                    alert(`Invalid amount. Maximum for ${sectionCode}: â‚¹${maxLimit.toLocaleString()}`);
                    return;
                }
                
                // Convert "2023-24" to 2024 for database
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                if (!financialYear || isNaN(financialYear)) {
                    alert('Invalid financial year format');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('deductions')
                    .insert([
                        {
                            user_id: currentUserId,
                            section_code: sectionCode,
                            amount,
                            financial_year: financialYear
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                alert(`Deduction added: ${sectionCode} - $${amount}`);
                addNotification('success', 'Deduction Added', `${sectionCode} deduction of â‚¹${amount.toLocaleString()} has been added successfully.`, 'medium');
                
                // Clear form
                document.getElementById('deductionSection').value = '';
                document.getElementById('deductionAmount').value = '';
                document.getElementById('deductionYear').value = '2024';
                
                await refreshStats();
                
            } catch (error) {
                alert(`Error adding deduction: ${error.message}`);
            }
        }

        // Edit deduction
        async function editDeduction(deductionId) {
            try {
                // Get current deduction data
                const { data: deductionData, error } = await supabase
                    .from('deductions')
                    .select('*')
                    .eq('deduction_id', deductionId)
                    .single();
                
                if (error) throw error;
                
                // Populate form with current data
                document.getElementById('deductionSection').value = deductionData.section_code;
                document.getElementById('deductionAmount').value = deductionData.amount;
                document.getElementById('deductionYear').value = `${deductionData.financial_year - 1}-${deductionData.financial_year}`;
                
                // Store the deduction ID for updating
                document.getElementById('deductionAmount').setAttribute('data-deduction-id', deductionId);
                
                // Change button text to indicate editing
                const addButton = document.querySelector('button[onclick="addDeduction()"]');
                addButton.textContent = 'Update Deduction';
                addButton.setAttribute('onclick', 'updateDeduction()');
                
                // Scroll to form
                document.getElementById('deductionsCard').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert(`Error loading deduction for editing: ${error.message}`);
            }
        }
        
        // Update deduction
        async function updateDeduction() {
            try {
                const deductionId = document.getElementById('deductionAmount').getAttribute('data-deduction-id');
                
                if (!deductionId) {
                    alert('No deduction selected for editing');
                    return;
                }
                
                const sectionCode = document.getElementById('deductionSection').value;
                const amount = parseFloat(document.getElementById('deductionAmount').value);
                const financialYearStr = document.getElementById('deductionYear').value;
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                if (!sectionCode || !amount || !financialYear) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                const { error } = await supabase
                    .from('deductions')
                    .update({
                        section_code: sectionCode,
                        amount: amount,
                        financial_year: financialYear
                    })
                    .eq('deduction_id', deductionId);
                
                if (error) throw error;
                
                alert('Deduction updated successfully!');
                
                // Reset form
                document.getElementById('deductionAmount').removeAttribute('data-deduction-id');
                document.getElementById('deductionAmount').value = '';
                
                // Reset button
                const addButton = document.querySelector('button[onclick="updateDeduction()"]');
                addButton.textContent = 'Add Deduction';
                addButton.setAttribute('onclick', 'addDeduction()');
                
                // Reload deduction list
                await loadDeductions();
                
            } catch (error) {
                alert(`Error updating deduction: ${error.message}`);
            }
        }
        
        // Delete deduction
        async function deleteDeduction(deductionId) {
            try {
                if (!confirm('Are you sure you want to delete this deduction?')) {
                    return;
                }
                
                const { error } = await supabase
                    .from('deductions')
                    .delete()
                    .eq('deduction_id', deductionId);
                
                if (error) throw error;
                
                alert('Deduction deleted successfully!');
                
                // Remove from UI
                const deductionElement = document.getElementById(`deduction-${deductionId}`);
                if (deductionElement) {
                    deductionElement.remove();
                }
                
                // Reload deduction list
                await loadDeductions();
                
            } catch (error) {
                alert(`Error deleting deduction: ${error.message}`);
            }
        }

        // Load deductions
        async function loadDeductions() {
            try {
                const { data, error } = await supabase
                    .from('deductions')
                    .select('deduction_id, section_code, amount, financial_year, created_at')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('deductionsData');
                container.classList.remove('hidden');
                
                let html = '';
                if (data.length === 0) {
                    html = '<div class="data-item"><div class="data-item-details">No deductions found</div></div>';
                } else {
                    data.forEach(deduction => {
                        const createdDate = new Date(deduction.created_at).toLocaleDateString();
                        html += `
                            <div class="data-item" id="deduction-${deduction.deduction_id}">
                                <div class="data-item-header">
                                    Section ${deduction.section_code}
                                    <div class="data-item-actions">
                                        <button class="btn btn-sm btn-edit" onclick="editDeduction('${deduction.deduction_id}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-delete" onclick="deleteDeduction('${deduction.deduction_id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="data-item-details">
                                    <strong>Amount:</strong> â‚¹${deduction.amount.toLocaleString()}<br>
                                    <strong>Financial Year:</strong> ${deduction.financial_year}<br>
                                    <strong>Added:</strong> ${createdDate}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                alert(`Error loading deductions: ${error.message}`);
            }
        }

        // Seed sample data
        async function seedSampleData() {
            try {
                // Create roles
                const { data: roleData, error: roleError } = await supabase
                    .from('roles')
                    .insert([
                        { name: 'admin', description: 'Administrator' },
                        { name: 'user', description: 'Regular user' }
                    ])
                    .select();
                
                if (roleError) throw roleError;
                
                // Create sample user
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .insert([
                        {
                            name: 'John Doe',
                            email: 'john@example.com',
                            phone: '+1234567890',
                            password_hash: 'password123',
                            role_id: roleData[0].role_id,
                            is_verified: true,
                            is_active: true
                        }
                    ])
                    .select();
                
                if (userError) throw userError;
                currentUserId = userData[0].user_id;
                
                // Create sample income
                await supabase
                    .from('income_sources')
                    .insert([
                        {
                            user_id: currentUserId,
                            source_type: 'Salary',
                            amount: 50000,
                            financial_year: 2024,
                            description: 'Monthly salary income'
                        }
                    ]);
                
                // Create sample tax return
                await supabase
                    .from('tax_returns')
                    .insert([
                        {
                            user_id: currentUserId,
                            financial_year: 2024,
                            total_income: 50000,
                            taxable_income: 45000,
                            tax_liability: 4500,
                            status: 'filed'
                        }
                    ]);
                
                // Create sample deduction
                await supabase
                    .from('deductions')
                    .insert([
                        {
                            user_id: currentUserId,
                            section_code: '80C',
                            amount: 5000,
                            financial_year: 2024
                        }
                    ]);
                
                alert('Sample data created successfully!');
                await refreshStats();
                
            } catch (error) {
                alert(`Error creating sample data: ${error.message}`);
            }
        }

        // Upload document
        async function uploadDocument() {
            try {
                if (!currentUserId) {
                    alert('Please create a user first');
                    return;
                }
                
                const fileInput = document.getElementById('fileInput');
                const documentType = document.getElementById('documentType').value;
                const description = document.getElementById('fileDescription').value;
                
                if (!fileInput.files[0]) {
                    alert('Please select a file to upload');
                    return;
                }
                
                const file = fileInput.files[0];
                const fileName = file.name;
                const fileSize = file.size;
                const mimeType = file.type;
                
                // Convert file to base64 for storage (in real app, use Supabase Storage)
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const base64Data = e.target.result;
                        
                        const { data, error } = await supabase
                            .from('document_uploads')
                            .insert([
                                {
                                    user_id: currentUserId,
                                    document_type: documentType,
                                    file_name: fileName,
                                    file_path: base64Data, // In real app, store in Supabase Storage
                                    file_size: fileSize,
                                    mime_type: mimeType
                                }
                            ])
                            .select();
                        
                        if (error) throw error;
                        
                        alert(`Document uploaded successfully: ${fileName}`);
                        
                        // Clear form
                        fileInput.value = '';
                        document.getElementById('fileDescription').value = '';
                        
                    } catch (error) {
                        alert(`Error uploading document: ${error.message}`);
                    }
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                alert(`Error uploading document: ${error.message}`);
            }
        }

        // Load documents
        async function loadDocuments() {
            try {
                const { data, error } = await supabase
                    .from('document_uploads')
                    .select('document_type, file_name, file_size, mime_type, uploaded_at, created_at');
                
                if (error) throw error;
                
                const container = document.getElementById('documentsData');
                container.classList.remove('hidden');
                
                let html = '';
                if (data.length === 0) {
                    html = '<div class="data-item"><div class="data-item-details">No documents found</div></div>';
                } else {
                    data.forEach(doc => {
                        const uploadedDate = new Date(doc.uploaded_at || doc.created_at).toLocaleDateString();
                        const fileSizeKB = Math.round(doc.file_size / 1024);
                        
                        html += `
                            <div class="data-item">
                                <div class="data-item-header">${doc.file_name}</div>
                                <div class="data-item-details">
                                    <strong>Type:</strong> ${doc.document_type.replace('_', ' ').toUpperCase()}<br>
                                    <strong>Size:</strong> ${fileSizeKB} KB<br>
                                    <strong>Format:</strong> ${doc.mime_type}<br>
                                    <strong>Uploaded:</strong> ${uploadedDate}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                alert(`Error loading documents: ${error.message}`);
            }
        }

        // Generate file return
        async function generateFileReturn() {
            try {
                if (!currentUserId) {
                    alert('Please create a user first');
                    return;
                }
                
                const financialYearElement = document.getElementById('financialYear');
                const returnTypeElement = document.getElementById('returnType');
                const taxRegimeElement = document.getElementById('taxRegime');
                
                if (!financialYearElement || !returnTypeElement || !taxRegimeElement) {
                    alert('Required form elements not found. Please refresh the page and try again.');
                    return;
                }
                
                const financialYearStr = financialYearElement.value;
                if (!financialYearStr) {
                    alert('Please enter financial year');
                    return;
                }
                
                // Convert "2023-24" to 2024 for database
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                const returnType = returnTypeElement.value;
                const taxRegime = taxRegimeElement.value;
                
                if (!financialYear) {
                    alert('Please enter financial year');
                    return;
                }
                
                // Get user's tax data for the year
                const { data: incomeData, error: incomeError } = await supabase
                    .from('income_sources')
                    .select('source_type, amount')
                    .eq('financial_year', financialYear);
                
                if (incomeError) throw incomeError;
                
                const { data: deductionData, error: deductionError } = await supabase
                    .from('deductions')
                    .select('section_code, amount')
                    .eq('financial_year', financialYear);
                
                if (deductionError) throw deductionError;
                
                // Calculate totals
                const incomeDataSafe = incomeData || [];
                const totalIncome = incomeDataSafe.reduce((sum, income) => sum + parseFloat(income.amount || 0), 0);
                
                // Calculate regime-specific deductions
                const regimeDeductions = calculateRegimeSpecificDeductions(deductionData, taxRegime);
                const taxableIncome = Math.max(0, totalIncome - regimeDeductions.totalDeductions);
                
                // Correct tax calculation based on regime (FY 2024-25)
                let taxLiability = 0;
                if (taxRegime === 'old') {
                    const oldRegimeResult = calculateOldRegimeTax(taxableIncome);
                    taxLiability = oldRegimeResult.tax;
                } else {
                    const newRegimeResult = calculateNewRegimeTax(taxableIncome);
                    taxLiability = newRegimeResult.tax;
                }
                
                // Create or update tax return
                const { data: returnData, error: returnError } = await supabase
                    .from('tax_returns')
                    .upsert([
                        {
                            user_id: currentUserId,
                            financial_year: financialYear,
                            total_income: totalIncome,
                            total_deduction: regimeDeductions.totalDeductions,
                            taxable_income: taxableIncome,
                            tax_liability: taxLiability,
                            tax_regime: taxRegime,
                            status: 'Pending',
                            is_draft: true
                        }
                    ])
                    .select();
                
                if (returnError) throw returnError;
                
                alert(`File return generated successfully!\n\nFinancial Year: ${financialYear}\nReturn Type: ${returnType}\nTax Regime: ${taxRegime}\nTotal Income: â‚¹${totalIncome.toLocaleString()}\nTotal Deductions: â‚¹${regimeDeductions.totalDeductions.toLocaleString()}\nTaxable Income: â‚¹${taxableIncome.toLocaleString()}\nTax Liability: â‚¹${taxLiability.toLocaleString()}`);
                
                await refreshStats();
                
            } catch (error) {
                alert(`Error generating file return: ${error.message}`);
            }
        }

        // Load file returns
        async function loadFileReturns() {
            try {
                const { data, error } = await supabase
                    .from('tax_returns')
                    .select('financial_year, total_income, total_deduction, taxable_income, tax_liability, tax_regime, status, filing_date, created_at')
                    .order('financial_year', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('fileReturnsData');
                container.classList.remove('hidden');
                
                let html = '';
                if (data.length === 0) {
                    html = '<div class="data-item"><div class="data-item-details">No file returns found</div></div>';
                } else {
                    data.forEach(return_data => {
                        const filingDate = return_data.filing_date ? new Date(return_data.filing_date).toLocaleDateString() : 'Not filed';
                        const createdDate = new Date(return_data.created_at).toLocaleDateString();
                        const regime = return_data.tax_regime === 'old' ? 'Old Regime' : 'New Regime';
                        
                        html += `
                            <div class="data-item">
                                <div class="data-item-header">FY ${return_data.financial_year} File Return</div>
                                <div class="data-item-details">
                                    <strong>Total Income:</strong> $${return_data.total_income.toLocaleString()}<br>
                                    <strong>Total Deductions:</strong> $${return_data.total_deduction.toLocaleString()}<br>
                                    <strong>Taxable Income:</strong> $${return_data.taxable_income.toLocaleString()}<br>
                                    <strong>Tax Liability:</strong> $${return_data.tax_liability.toLocaleString()}<br>
                                    <strong>Tax Regime:</strong> ${regime}<br>
                                    <strong>Status:</strong> ${return_data.status}<br>
                                    <strong>Filing Date:</strong> ${filingDate}<br>
                                    <strong>Created:</strong> ${createdDate}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                alert(`Error loading file returns: ${error.message}`);
            }
        }

        // Submit return (locks the return)
        async function submitReturn() {
            try {
                if (!currentUserId) {
                    alert('Please create a user first');
                    return;
                }
                
                const financialYearStr = document.getElementById('financialYear').value;
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                if (!confirm('Are you sure you want to submit this return? Once submitted, you will need to file a revised return to make changes.')) {
                    return;
                }
                
                // Update the return status to submitted and locked
                const { error } = await supabase
                    .from('tax_returns')
                    .update({
                        status: 'Filed',
                        is_draft: false,
                        filing_date: new Date().toISOString()
                    })
                    .eq('user_id', currentUserId)
                    .eq('financial_year', financialYear);
                
                if (error) throw error;
                
                alert('Return submitted successfully! Your return is now locked. Use "File Revised Return" if you need to make changes.');
                addNotification('success', 'Tax Return Submitted', 'Your tax return has been successfully submitted and is now locked for editing.', 'high');
                
                // Show locked status
                showLockedStatus();
                
                // Reload returns
                await loadFileReturns();
                
            } catch (error) {
                alert(`Error submitting return: ${error.message}`);
            }
        }
        
        // File revised return (unlocks for editing)
        async function fileRevisedReturn() {
            try {
                if (!currentUserId) {
                    alert('Please create a user first');
                    return;
                }
                
                const financialYearStr = document.getElementById('financialYear').value;
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                if (!confirm('Are you sure you want to file a revised return? This will unlock your return for editing.')) {
                    return;
                }
                
                // Update the return status to revised and editable
                const { error } = await supabase
                    .from('tax_returns')
                    .update({
                        status: 'Pending',
                        is_draft: true,
                        filing_date: new Date().toISOString()
                    })
                    .eq('user_id', currentUserId)
                    .eq('financial_year', financialYear);
                
                if (error) throw error;
                
                alert('Revised return filed! You can now edit your income and deductions.');
                
                // Hide locked status
                hideLockedStatus();
                
                // Reload returns
                await loadFileReturns();
                
            } catch (error) {
                alert(`Error filing revised return: ${error.message}`);
            }
        }
        
        // Show locked status
        function showLockedStatus() {
            const reviewCard = document.getElementById('reviewCard');
            let lockedStatus = document.getElementById('lockedStatus');
            
            if (!lockedStatus) {
                lockedStatus = document.createElement('div');
                lockedStatus.id = 'lockedStatus';
                lockedStatus.className = 'locked-status locked';
                lockedStatus.innerHTML = `
                    <h3><i class="fas fa-lock"></i> ðŸ”’ Return Locked - No Further Edits Allowed</h3>
                    <p><strong>Your tax return has been successfully submitted and e-verified.</strong></p>
                    <p>Income sources and deductions are now locked and cannot be modified.</p>
                    <p>If you need to make changes, you must file a revised return using the button below.</p>
                    <button class="action-button" onclick="fileRevisedReturn()">
                        <i class="fas fa-edit"></i> File Revised Return
                    </button>
                    <p style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                        <i class="fas fa-info-circle"></i> Revised returns can be filed within the specified time limits.
                    </p>
                `;
                reviewCard.insertBefore(lockedStatus, reviewCard.firstChild);
            }
        }
        
        // Hide locked status
        function hideLockedStatus() {
            const lockedStatus = document.getElementById('lockedStatus');
            if (lockedStatus) {
                lockedStatus.remove();
            }
        }

        // Download return (simulated)
        async function downloadReturn() {
            try {
                const financialYearElement = document.getElementById('financialYear');
                if (!financialYearElement) {
                    alert('Financial year field not found. Please refresh the page and try again.');
                    return;
                }
                
                const financialYearStr = financialYearElement.value;
                if (!financialYearStr) {
                    alert('Please enter financial year');
                    return;
                }
                
                // Convert "2023-24" to 2024 for database
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                if (isNaN(financialYear)) {
                    alert('Invalid financial year format');
                    return;
                }
                
                // Generate PDF return document
                generateReturnPDF(financialYearStr);
                return;
                
                // Get the return data
                const { data, error } = await supabase
                    .from('tax_returns')
                    .select('*')
                    .eq('financial_year', financialYear)
                    .eq('user_id', currentUserId)
                    .single();
                
                if (error) throw error;
                
                if (!data) {
                    alert('No return found for the specified year. Please generate a return first.');
                    return;
                }
                
                // Create a simple text-based return document
                const returnContent = `
INCOME TAX RETURN - FY ${financialYear}
=====================================

Taxpayer Information:
- Financial Year: ${financialYear}
- Tax Regime: ${data.tax_regime === 'old' ? 'Old Regime' : 'New Regime'}
- Status: ${data.status}

Income Details:
- Total Income: $${data.total_income.toLocaleString()}
- Total Deductions: $${data.total_deduction.toLocaleString()}
- Taxable Income: $${data.taxable_income.toLocaleString()}

Tax Calculation:
- Tax Liability: $${data.tax_liability.toLocaleString()}

Filing Information:
- Filing Date: ${data.filing_date || 'Not specified'}
- Created: ${new Date(data.created_at).toLocaleString()}
- Last Updated: ${new Date(data.updated_at).toLocaleString()}

This is a generated return document.
For official filing, please use the government portal.
                `;
                
                // Create and download the file
                const blob = new Blob([returnContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ITR_FY${financialYear}_${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('Return document downloaded successfully!');
                
            } catch (error) {
                alert(`Error downloading return: ${error.message}`);
            }
        }

        // Clear all data
        async function clearAllData() {
            if (!confirm('Are you sure you want to clear ALL data? This action cannot be undone!')) {
                return;
            }
            
            try {
                const tables = [
                    'document_uploads', 'notifications', 'otp_verification', 'login_logs', 'penalties',
                    'audits', 'payments', 'refunds', 'tax_returns', 'deductions',
                    'income_sources', 'users', 'roles'
                ];
                
                for (const table of tables) {
                    await supabase.from(table).delete().neq('created_at', '1900-01-01');
                }
                
                currentUserId = null;
                alert('All data cleared successfully!');
                await refreshStats();
                
            } catch (error) {
                alert(`Error clearing data: ${error.message}`);
            }
        }

        // Authentication Functions
        async function login() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showStatus('loginStatus', 'Please fill in all fields', 'error');
                    return;
                }
                
                // Find user by email
                const { data: users, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .eq('is_active', true)
                    .single();
                
                if (userError || !users) {
                    showStatus('loginStatus', 'Invalid email or password', 'error');
                    return;
                }
                
                // Simple password check (in production, use proper hashing)
                if (users.password_hash !== password) {
                    showStatus('loginStatus', 'Invalid email or password', 'error');
                    return;
                }
                
                // Update last login
                await supabase
                    .from('users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('user_id', users.user_id);
                
                // Log login attempt
                await supabase
                    .from('login_logs')
                    .insert([{
                        user_id: users.user_id,
                        login_time: new Date().toISOString(),
                        ip_address: '127.0.0.1',
                        user_agent: navigator.userAgent,
                        login_status: 'Success'
                    }]);
                
                // Set current user
                currentUser = users;
                currentUserId = users.user_id;
                
                // Show main app
                addNotification('success', 'Login Successful', 'Welcome back to Taxaid.gov!', 'medium');
                showMainApp();
                
            } catch (error) {
                console.error('Login error:', error);
                showStatus('loginStatus', `Login failed: ${error.message}`, 'error');
            }
        }
        
        async function signup() {
            try {
                // Get all form values
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const phone = document.getElementById('signupPhone').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                const dob = document.getElementById('signupDOB').value;
                const gender = document.getElementById('signupGender').value;
                const pan = document.getElementById('signupPAN').value;
                const aadhaar = document.getElementById('signupAadhaar').value.replace(/\s/g, ''); // Remove spaces
                const passport = document.getElementById('signupPassport').value;
                const streetAddress = document.getElementById('signupStreetAddress').value;
                const pinCode = document.getElementById('signupPinCode').value;
                const city = document.getElementById('signupCity').value;
                
                // Bank details
                const bankName = document.getElementById('signupBankName').value;
                const accountNumber = document.getElementById('signupAccountNumber').value;
                const ifsc = document.getElementById('signupIFSC').value;
                const accountHolder = document.getElementById('signupAccountHolder').value;
                const state = document.getElementById('signupState').value;
                const permanentAddress = document.getElementById('signupPermanentAddress').value;
                const country = document.getElementById('signupCountry').value;
                const occupation = document.getElementById('signupOccupation').value;
                const employer = document.getElementById('signupEmployer').value;
                const employerCategory = document.getElementById('signupEmployerCategory').value;
                const taxpayerStatus = document.getElementById('signupTaxpayerStatus').value;
                
                // Validation
                if (!name || !email || !password || !dob || !gender || !pan || !aadhaar || !streetAddress || !pinCode || !city || !state || !occupation || !taxpayerStatus) {
                    showStatus('signupStatus', 'Please fill in all required fields', 'error');
                    return;
                }

                // Advanced validation
                if (!validatePAN(pan)) {
                    showStatus('signupStatus', 'Invalid PAN format. Use format: ABCDE1234F', 'error');
                    return;
                }

                if (!validateAadhaar(aadhaar)) {
                    showStatus('signupStatus', 'Invalid Aadhaar number', 'error');
                    return;
                }

                if (!validateEmail(email)) {
                    showStatus('signupStatus', 'Invalid email format', 'error');
                    return;
                }

                if (phone && !validatePhone(phone)) {
                    showStatus('signupStatus', 'Invalid phone number. Use 10-digit mobile number starting with 6-9', 'error');
                    return;
                }

                if (!validatePincode(pinCode)) {
                    showStatus('signupStatus', 'Invalid PIN code. Use 6-digit PIN code', 'error');
                    return;
                }

                if (ifsc && !validateIFSC(ifsc)) {
                    showStatus('signupStatus', 'Invalid IFSC code format', 'error');
                    return;
                }

                if (accountNumber && !validateAccountNumber(accountNumber)) {
                    showStatus('signupStatus', 'Invalid account number (9-18 digits)', 'error');
                    return;
                }
                
                // Validate PIN code format
                if (!validatePinCode(pinCode)) {
                    showStatus('signupStatus', 'Invalid PIN code format. Please enter 6 digits', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showStatus('signupStatus', 'Passwords do not match', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showStatus('signupStatus', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                // Validate PAN format
                if (!validatePAN(pan)) {
                    showStatus('signupStatus', 'Invalid PAN format. Please use format: ABCDE1234F', 'error');
                    return;
                }
                
                // Validate Aadhaar format
                if (!validateAadhaar(aadhaar)) {
                    showStatus('signupStatus', 'Invalid Aadhaar format. Please enter 12 digits', 'error');
                    return;
                }
                
                // Check if email already exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('user_id')
                    .eq('email', email)
                    .single();
                
                if (existingUser) {
                    showStatus('signupStatus', 'Email already registered', 'error');
                    return;
                }
                
                // Check if PAN already exists
                const { data: existingPAN } = await supabase
                    .from('users')
                    .select('user_id')
                    .eq('pan', pan.toUpperCase())
                    .single();
                
                if (existingPAN) {
                    showStatus('signupStatus', 'PAN number already registered', 'error');
                    return;
                }
                
                // Check if Aadhaar already exists
                const { data: existingAadhaar } = await supabase
                    .from('users')
                    .select('user_id')
                    .eq('aadhaar', aadhaar)
                    .single();
                
                if (existingAadhaar) {
                    showStatus('signupStatus', 'Aadhaar number already registered', 'error');
                    return;
                }
                
                // Get user role
                const { data: roles, error: roleError } = await supabase
                    .from('roles')
                    .select('role_id')
                    .eq('name', 'user')
                    .single();
                
                if (roleError || !roles) {
                    showStatus('signupStatus', 'System error: No user role found', 'error');
                    return;
                }
                
                // Create user with comprehensive profile
                const { data: newUser, error: userError } = await supabase
                    .from('users')
                    .insert([{
                        name,
                        email,
                        phone: phone || null,
                        password_hash: password, // In production, hash this
                        role_id: roles.role_id,
                        is_verified: false,
                        is_active: true,
                        dob: dob || null,
                        gender: gender || null,
                        pan: pan.toUpperCase(),
                        aadhaar: aadhaar,
                        passport_number: passport || null,
                        street_address: streetAddress,
                        pin_code: pinCode,
                        city: city,
                        state: state,
                        residential_address: `${streetAddress}, ${city}, ${state} - ${pinCode}`,
                        permanent_address: permanentAddress || (permanentAddressOption === 'same' ? 'SAME AS RESIDENTIAL ADDRESS' : null),
                        country: country || 'India',
                        occupation_type: occupation,
                        employer_name: employer || null,
                        employer_category: employerCategory || null,
                        taxpayer_status: taxpayerStatus,
                        bank_name: bankName || null,
                        account_number: accountNumber || null,
                        ifsc_code: ifsc || null,
                        account_holder_name: accountHolder || null,
                        is_phone_verified: false,
                        is_email_verified: false
                    }])
                    .select()
                    .single();
                
                if (userError) throw userError;
                
                // Generate OTP
                const otpCode = Math.floor(100000 + Math.random() * 900000).toString();
                const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes
                
                await supabase
                    .from('otp_verification')
                    .insert([{
                        user_id: newUser.user_id,
                        email: email,
                        otp_code: otpCode,
                        expires_at: expiresAt.toISOString(),
                        is_used: false
                    }]);
                
                pendingOTP = { user: newUser, otp: otpCode, email };
                
                // Show OTP form
                showOTPForm();
                showStatus('signupStatus', 'Account created! Please verify your email.', 'success');
                addNotification('success', 'Account Created', 'Welcome to Taxaid.gov! Your account has been created successfully. Please verify your email to complete registration.', 'high');
                
                // Start OTP timer
                startOTPTimer();
                
            } catch (error) {
                console.error('Signup error:', error);
                showStatus('signupStatus', `Signup failed: ${error.message}`, 'error');
            }
        }
        
        async function verifyOTP() {
            try {
                const otpCode = document.getElementById('otpCode').value;
                
                if (!otpCode || otpCode.length !== 6) {
                    showStatus('otpStatus', 'Please enter a valid 6-digit code', 'error');
                    return;
                }
                
                if (!pendingOTP) {
                    showStatus('otpStatus', 'No pending verification found', 'error');
                    return;
                }
                
                // Check OTP
                const { data: otpData, error: otpError } = await supabase
                    .from('otp_verification')
                    .select('*')
                    .eq('user_id', pendingOTP.user.user_id)
                    .eq('otp_code', otpCode)
                    .eq('is_used', false)
                    .gt('expires_at', new Date().toISOString())
                    .single();
                
                if (otpError || !otpData) {
                    showStatus('otpStatus', 'Invalid or expired OTP code', 'error');
                    return;
                }
                
                // Mark OTP as used
                await supabase
                    .from('otp_verification')
                    .update({ is_used: true })
                    .eq('otp_id', otpData.otp_id);
                
                // Verify user
                await supabase
                    .from('users')
                    .update({ is_verified: true })
                    .eq('user_id', pendingOTP.user.user_id);
                
                // Set current user
                currentUser = { ...pendingOTP.user, is_verified: true };
                currentUserId = pendingOTP.user.user_id;
                
                // Show main app
                showMainApp();
                
            } catch (error) {
                console.error('OTP verification error:', error);
                showStatus('otpStatus', `Verification failed: ${error.message}`, 'error');
            }
        }
        
        async function resendOTP() {
            try {
                if (!pendingOTP) {
                    showStatus('otpStatus', 'No pending verification found', 'error');
                    return;
                }
                
                // Generate new OTP
                const otpCode = Math.floor(100000 + Math.random() * 900000).toString();
                const expiresAt = new Date(Date.now() + 10 * 60 * 1000);
                
                await supabase
                    .from('otp_verification')
                    .insert([{
                        user_id: pendingOTP.user.user_id,
                        email: pendingOTP.email,
                        otp_code: otpCode,
                        expires_at: expiresAt.toISOString(),
                        is_used: false
                    }]);
                
                pendingOTP.otp = otpCode;
                showStatus('otpStatus', 'New verification code sent!', 'success');
                
            } catch (error) {
                console.error('Resend OTP error:', error);
                showStatus('otpStatus', `Failed to resend code: ${error.message}`, 'error');
            }
        }
        
        function logout() {
            currentUser = null;
            currentUserId = null;
            pendingOTP = null;
            
            // Stop OTP timer
            stopOTPTimer();
            
            // Clear forms
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('signupName').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPhone').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupConfirmPassword').value = '';
            document.getElementById('otpCode').value = '';
            
            // Hide status messages
            hideAllStatuses();
            
            // Hide profile section
            document.getElementById('profileSection').classList.add('hidden');
            
            // Show login form
            showLoginForm();
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('otpForm').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
        
        function showSignupForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('otpForm').classList.add('hidden');
        }
        
        function showOTPForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('otpForm').classList.remove('hidden');
        }
        
        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userWelcome').textContent = `Welcome, ${currentUser.name}!`;
            
            // Check if user is admin and show admin panel button
            if (currentUser.is_admin) {
                document.getElementById('userRole').textContent = 'ADMIN';
                document.getElementById('userRole').classList.remove('hidden');
                document.getElementById('adminPanelBtn').classList.remove('hidden');
            } else {
                document.getElementById('userRole').classList.add('hidden');
                document.getElementById('adminPanelBtn').classList.add('hidden');
            }
            
            // Load initial data
            refreshStats();
        }
        
        function cancelSignup() {
            pendingOTP = null;
            showLoginForm();
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.classList.remove('hidden');
        }
        
        function hideAllStatuses() {
            const statusElements = ['loginStatus', 'signupStatus', 'otpStatus'];
            statusElements.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }
        
        // Admin Functions
        async function createDemoUser() {
            try {
                const demoEmail = `demo_${Date.now()}@example.com`;
                const demoPassword = 'demo123';
                
                // Get user role
                const { data: roles, error: roleError } = await supabase
                    .from('roles')
                    .select('role_id')
                    .eq('name', 'user')
                    .single();
                
                if (roleError || !roles) {
                    alert('System error: No user role found');
                    return;
                }
                
                // Create demo user
                const { data: newUser, error: userError } = await supabase
                    .from('users')
                    .insert([{
                        name: 'Demo User',
                        email: demoEmail,
                        phone: '+1234567890',
                        password_hash: demoPassword,
                        role_id: roles.role_id,
                        is_verified: true,
                        is_active: true
                    }])
                    .select()
                    .single();
                
                if (userError) throw userError;
                
                alert(`Demo user created successfully!\nEmail: ${demoEmail}\nPassword: ${demoPassword}`);
                await refreshStats();
                
            } catch (error) {
                console.error('Create demo user error:', error);
                alert(`Failed to create demo user: ${error.message}`);
            }
        }
        
        async function showOTPViewer() {
            try {
                const { data: otps, error } = await supabase
                    .from('otp_verification')
                    .select('email, otp_code, created_at, is_used')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const otpList = document.getElementById('otpList');
                const otpViewer = document.getElementById('otpViewer');
                
                if (otps.length === 0) {
                    otpList.innerHTML = '<p>No OTP codes found</p>';
                } else {
                    let html = '';
                    otps.forEach(otp => {
                        const status = otp.is_used ? 'Used' : 'Active';
                        const statusClass = otp.is_used ? 'error' : 'success';
                        const createdDate = new Date(otp.created_at).toLocaleString();
                        
                        html += `
                            <div class="otp-display">
                                <div><strong>Email:</strong> ${otp.email}</div>
                                <div><strong>OTP:</strong> ${otp.otp_code}</div>
                                <div><strong>Status:</strong> <span class="status ${statusClass}">${status}</span></div>
                                <div><strong>Created:</strong> ${createdDate}</div>
                            </div>
                        `;
                    });
                    otpList.innerHTML = html;
                }
                
                otpViewer.classList.remove('hidden');
                
            } catch (error) {
                console.error('Show OTP viewer error:', error);
                alert(`Failed to load OTP codes: ${error.message}`);
            }
        }
        
        // Profile Management Functions
        async function showProfile() {
            try {
                // Load current user data
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .single();
                
                if (error) throw error;
                
                // Populate profile form with all fields (convert text to uppercase)
                document.getElementById('profileName').value = (userData.name || '').toUpperCase();
                document.getElementById('profileEmail').value = userData.email || '';
                document.getElementById('profilePhone').value = (userData.phone || '').toUpperCase();
                document.getElementById('profileDOB').value = userData.dob || '';
                document.getElementById('profileGender').value = userData.gender || '';
                document.getElementById('profilePAN').value = userData.pan || '';
                // Format Aadhaar for display
                const aadhaar = userData.aadhaar || '';
                if (aadhaar) {
                    const formattedAadhaar = aadhaar.replace(/(\d{4})(?=\d)/g, '$1 ');
                    document.getElementById('profileAadhaar').value = formattedAadhaar;
                } else {
                    document.getElementById('profileAadhaar').value = '';
                }
                document.getElementById('profilePassport').value = (userData.passport_number || '').toUpperCase();
                document.getElementById('profileStreetAddress').value = (userData.street_address || '').toUpperCase();
                document.getElementById('profilePinCode').value = userData.pin_code || '';
                document.getElementById('profileCity').value = (userData.city || '').toUpperCase();
                document.getElementById('profileState').value = (userData.state || '').toUpperCase();
                // Handle permanent address
                const permanentAddress = userData.permanent_address || '';
                if (permanentAddress && permanentAddress !== 'SAME AS RESIDENTIAL ADDRESS') {
                    document.getElementById('permanentAddressOption').value = 'different';
                    // Parse permanent address if it exists
                    const addressParts = permanentAddress.split(', ');
                    if (addressParts.length >= 3) {
                        document.getElementById('profilePermanentStreetAddress').value = addressParts[0] || '';
                        const cityStatePin = addressParts[1] || '';
                        const statePin = cityStatePin.split(' - ');
                        if (statePin.length >= 2) {
                            document.getElementById('profilePermanentCity').value = statePin[0] || '';
                            const statePinCode = statePin[1] || '';
                            const statePinParts = statePinCode.split(' ');
                            if (statePinParts.length >= 2) {
                                document.getElementById('profilePermanentState').value = statePinParts[0] || '';
                                document.getElementById('profilePermanentPinCode').value = statePinParts[1] || '';
                            }
                        }
                    }
                    togglePermanentAddressFields();
                } else {
                    document.getElementById('permanentAddressOption').value = 'same';
                    togglePermanentAddressFields();
                }
                document.getElementById('profilePermanentAddress').value = permanentAddress.toUpperCase();
                document.getElementById('profileCountry').value = userData.country || 'India';
                document.getElementById('profileOccupation').value = userData.occupation_type || '';
                document.getElementById('profileEmployer').value = (userData.employer_name || '').toUpperCase();
                document.getElementById('profileEmployerCategory').value = userData.employer_category || '';
                document.getElementById('profileTaxpayerStatus').value = userData.taxpayer_status || '';
                
                // Load bank details
                document.getElementById('profileBankName').value = userData.bank_name || '';
                document.getElementById('profileAccountNumber').value = userData.account_number || '';
                document.getElementById('profileIFSC').value = userData.ifsc_code || '';
                document.getElementById('profileAccountHolder').value = userData.account_holder_name || '';
                
                // Initialize address listeners
                addResidentialAddressListeners();
                
                // Show/hide conditional fields based on occupation
                toggleEmployerFields(userData.occupation_type);
                
                // Show profile section
                document.getElementById('profileSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showStatus('profileStatus', `Failed to load profile: ${error.message}`, 'error');
            }
        }
        
        function hideProfile() {
            document.getElementById('profileSection').classList.add('hidden');
        }
        
        async function updateProfile() {
            try {
                // Get all profile form values and convert text to uppercase
                const name = document.getElementById('profileName').value.toUpperCase();
                const phone = document.getElementById('profilePhone').value.toUpperCase();
                const dob = document.getElementById('profileDOB').value;
                const gender = document.getElementById('profileGender').value;
                const passport = document.getElementById('profilePassport').value.toUpperCase();
                const streetAddress = document.getElementById('profileStreetAddress').value.toUpperCase();
                const pinCode = document.getElementById('profilePinCode').value;
                const city = document.getElementById('profileCity').value.toUpperCase();
                const state = document.getElementById('profileState').value.toUpperCase();
                const permanentAddress = document.getElementById('profilePermanentAddress').value.toUpperCase();
                const permanentAddressOptionElement = document.getElementById('permanentAddressOption');
                const permanentAddressOption = permanentAddressOptionElement ? permanentAddressOptionElement.value : 'same';
                const country = document.getElementById('profileCountry').value;
                const occupation = document.getElementById('profileOccupation').value;
                const employer = document.getElementById('profileEmployer').value.toUpperCase();
                const employerCategory = document.getElementById('profileEmployerCategory').value;
                const taxpayerStatus = document.getElementById('profileTaxpayerStatus').value;
                
                // Bank details
                const bankName = document.getElementById('profileBankName').value;
                const accountNumber = document.getElementById('profileAccountNumber').value;
                const ifsc = document.getElementById('profileIFSC').value;
                const accountHolder = document.getElementById('profileAccountHolder').value;
                
                // Basic validation
                if (!name || !streetAddress || !pinCode || !city || !state || !occupation || !taxpayerStatus) {
                    showStatus('profileStatus', 'Please fill in all required fields', 'error');
                    return;
                }

                // Advanced validation
                if (!validateEmail(currentUser.email)) {
                    showStatus('profileStatus', 'Invalid email format', 'error');
                    return;
                }

                if (phone && !validatePhone(phone)) {
                    showStatus('profileStatus', 'Invalid phone number. Use 10-digit mobile number starting with 6-9', 'error');
                    return;
                }

                if (!validatePincode(pinCode)) {
                    showStatus('profileStatus', 'Invalid PIN code. Use 6-digit PIN code', 'error');
                    return;
                }

                if (ifsc && !validateIFSC(ifsc)) {
                    showStatus('profileStatus', 'Invalid IFSC code format', 'error');
                    return;
                }

                if (accountNumber && !validateAccountNumber(accountNumber)) {
                    showStatus('profileStatus', 'Invalid account number (9-18 digits)', 'error');
                    return;
                }
                
                // Validate permanent address if different
                if (permanentAddressOption === 'different') {
                    const permanentStreetAddressElement = document.getElementById('profilePermanentStreetAddress');
                    const permanentPinCodeElement = document.getElementById('profilePermanentPinCode');
                    const permanentCityElement = document.getElementById('profilePermanentCity');
                    const permanentStateElement = document.getElementById('profilePermanentState');
                    
                    const permanentStreetAddress = permanentStreetAddressElement ? permanentStreetAddressElement.value : '';
                    const permanentPinCode = permanentPinCodeElement ? permanentPinCodeElement.value : '';
                    const permanentCity = permanentCityElement ? permanentCityElement.value : '';
                    const permanentState = permanentStateElement ? permanentStateElement.value : '';
                    
                    if (!permanentStreetAddress || !permanentPinCode || !permanentCity || !permanentState) {
                        showStatus('profileStatus', 'Please fill in all permanent address fields', 'error');
                        return;
                    }
                    
                    // Validate permanent PIN code format
                    if (!validatePinCode(permanentPinCode)) {
                        showStatus('profileStatus', 'Invalid permanent PIN code format. Please enter 6 digits', 'error');
                        return;
                    }
                }
                
                // Validate PIN code format
                if (!validatePinCode(pinCode)) {
                    showStatus('profileStatus', 'Invalid PIN code format. Please enter 6 digits', 'error');
                    return;
                }
                
                // Update user profile (PAN and Aadhaar are readonly)
                const { error } = await supabase
                    .from('users')
                    .update({
                        name: name,
                        phone: phone || null,
                        dob: dob || null,
                        gender: gender || null,
                        passport_number: passport || null,
                        street_address: streetAddress,
                        pin_code: pinCode,
                        city: city,
                        state: state,
                        residential_address: `${streetAddress}, ${city}, ${state} - ${pinCode}`,
                        permanent_address: permanentAddress || (permanentAddressOption === 'same' ? 'SAME AS RESIDENTIAL ADDRESS' : null),
                        country: country || 'India',
                        occupation_type: occupation,
                        employer_name: employer || null,
                        employer_category: employerCategory || null,
                        taxpayer_status: taxpayerStatus,
                        bank_name: bankName || null,
                        account_number: accountNumber || null,
                        ifsc_code: ifsc || null,
                        account_holder_name: accountHolder || null
                    })
                    .eq('user_id', currentUserId);
                
                if (error) throw error;
                
                // Update current user object
                currentUser = { 
                    ...currentUser, 
                    name, 
                    phone, 
                    dob, 
                    gender, 
                    passport_number: passport,
                    street_address: streetAddress,
                    pin_code: pinCode,
                    city: city,
                    state: state,
                    residential_address: `${streetAddress}, ${city}, ${state} - ${pinCode}`,
                    permanent_address: permanentAddress,
                    country,
                    occupation_type: occupation,
                    employer_name: employer,
                    employer_category: employerCategory,
                    taxpayer_status: taxpayerStatus,
                    bank_name: bankName,
                    account_number: accountNumber,
                    ifsc_code: ifsc,
                    account_holder_name: accountHolder
                };
                document.getElementById('userName').textContent = name;
                
                showStatus('profileStatus', 'Profile updated successfully!', 'success');
                addNotification('success', 'Profile Updated', 'Your profile information has been successfully updated.', 'low');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showStatus('profileStatus', `Failed to update profile: ${error.message}`, 'error');
            }
        }
        
        function toggleEmployerFields(occupation) {
            const employerGroup = document.getElementById('profileEmployerGroup');
            const employerCategoryGroup = document.getElementById('profileEmployerCategoryGroup');
            
            if (occupation === 'Salaried') {
                employerGroup.classList.add('show');
                employerCategoryGroup.classList.add('show');
            } else {
                employerGroup.classList.remove('show');
                employerCategoryGroup.classList.remove('show');
            }
        }
        
        function validatePAN(pan) {
            const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
            return panRegex.test(pan.toUpperCase());
        }
        
        function validateAadhaar(aadhaar) {
            // Remove spaces and check if it's 12 digits
            const cleanAadhaar = aadhaar.replace(/\s/g, '');
            const aadhaarRegex = /^[0-9]{12}$/;
            return aadhaarRegex.test(cleanAadhaar);
        }
        
        function formatAadhaar(input) {
            // Remove all non-numeric characters
            let value = input.value.replace(/\D/g, '');
            
            // Limit to 12 digits
            if (value.length > 12) {
                value = value.substring(0, 12);
            }
            
            // Add spaces every 4 digits
            let formatted = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            input.value = formatted;
        }
        
        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }
        
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'ðŸ™ˆ';
            } else {
                input.type = 'password';
                button.textContent = 'ðŸ‘ï¸';
            }
        }
        
        function validatePinCode(pinCode) {
            const pinRegex = /^[0-9]{6}$/;
            return pinRegex.test(pinCode);
        }
        
        // PIN code to city/state mapping (simplified for demo)
        const pinCodeData = {
            '110001': { city: 'New Delhi', state: 'Delhi' },
            '400001': { city: 'Mumbai', state: 'Maharashtra' },
            '560001': { city: 'Bangalore', state: 'Karnataka' },
            '600001': { city: 'Chennai', state: 'Tamil Nadu' },
            '700001': { city: 'Kolkata', state: 'West Bengal' },
            '380001': { city: 'Ahmedabad', state: 'Gujarat' },
            '500001': { city: 'Hyderabad', state: 'Telangana' },
            '302001': { city: 'Jaipur', state: 'Rajasthan' },
            '411001': { city: 'Pune', state: 'Maharashtra' },
            '110020': { city: 'New Delhi', state: 'Delhi' },
            '400002': { city: 'Mumbai', state: 'Maharashtra' },
            '560002': { city: 'Bangalore', state: 'Karnataka' },
            '600002': { city: 'Chennai', state: 'Tamil Nadu' },
            '700002': { city: 'Kolkata', state: 'West Bengal' },
            '380002': { city: 'Ahmedabad', state: 'Gujarat' },
            '500002': { city: 'Hyderabad', state: 'Telangana' },
            '302002': { city: 'Jaipur', state: 'Rajasthan' },
            '411002': { city: 'Pune', state: 'Maharashtra' }
        };
        
        async function fetchCityStateFromPin(pinCode, formType = 'signup') {
            if (!pinCode || pinCode.length !== 6) {
                return;
            }
            
            const cityField = document.getElementById(`${formType}City`);
            const stateField = document.getElementById(`${formType}State`);
            
            // Check local data first
            if (pinCodeData[pinCode]) {
                cityField.value = pinCodeData[pinCode].city;
                stateField.value = pinCodeData[pinCode].state;
                
                // Add visual feedback for auto-filled fields
                cityField.classList.add('auto-fill-field');
                stateField.classList.add('auto-fill-field');
                
                // Remove the visual feedback after 3 seconds
                setTimeout(() => {
                    cityField.classList.remove('auto-fill-field');
                    stateField.classList.remove('auto-fill-field');
                }, 3000);
                return;
            }
            
            // For unknown PIN codes, clear the fields and let user fill manually
            cityField.value = '';
            stateField.value = '';
            cityField.placeholder = 'Enter city manually';
            stateField.placeholder = 'Enter state manually';
            
            // In a real application, you would call an API like:
            // try {
            //     const response = await fetch(`https://api.postalpincode.in/pincode/${pinCode}`);
            //     const data = await response.json();
            //     if (data[0] && data[0].Status === 'Success') {
            //         const postOffice = data[0].PostOffice[0];
            //         cityField.value = postOffice.District;
            //         stateField.value = postOffice.State;
            //         cityField.classList.add('auto-fill-field');
            //         stateField.classList.add('auto-fill-field');
            //     }
            // } catch (error) {
            //     console.error('Error fetching city/state:', error);
            // }
        }
        
        // Improved OTP Functions
        function startOTPTimer() {
            if (otpTimer) clearInterval(otpTimer);
            
            let timeLeft = 600; // 10 minutes in seconds
            
            // Update OTP display
            document.getElementById('otpEmail').textContent = pendingOTP.email;
            document.getElementById('otpCodeDisplay').textContent = pendingOTP.otp;
            
            otpTimer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('otpTimer').textContent = timeString;
                
                if (timeLeft <= 0) {
                    clearInterval(otpTimer);
                    document.getElementById('otpTimer').textContent = 'Expired';
                    document.getElementById('otpTimer').className = 'otp-timer';
                    showStatus('otpStatus', 'OTP has expired. Please request a new one.', 'error');
                }
                
                timeLeft--;
            }, 1000);
        }
        
        function stopOTPTimer() {
            if (otpTimer) {
                clearInterval(otpTimer);
                otpTimer = null;
            }
        }
        
        // Enhanced OTP verification with better UX
        async function verifyOTP() {
            try {
                const otpCode = document.getElementById('otpCode').value;
                
                if (!otpCode || otpCode.length !== 6) {
                    showStatus('otpStatus', 'Please enter a valid 6-digit code', 'error');
                    return;
                }
                
                if (!pendingOTP) {
                    showStatus('otpStatus', 'No pending verification found', 'error');
                    return;
                }
                
                // Check OTP
                const { data: otpData, error: otpError } = await supabase
                    .from('otp_verification')
                    .select('*')
                    .eq('user_id', pendingOTP.user.user_id)
                    .eq('otp_code', otpCode)
                    .eq('is_used', false)
                    .gt('expires_at', new Date().toISOString())
                    .single();
                
                if (otpError || !otpData) {
                    showStatus('otpStatus', 'Invalid or expired OTP code', 'error');
                    return;
                }
                
                // Mark OTP as used
                await supabase
                    .from('otp_verification')
                    .update({ is_used: true })
                    .eq('otp_id', otpData.otp_id);
                
                // Verify user
                await supabase
                    .from('users')
                    .update({ is_verified: true })
                    .eq('user_id', pendingOTP.user.user_id);
                
                // Stop timer
                stopOTPTimer();
                
                // Set current user
                currentUser = { ...pendingOTP.user, is_verified: true };
                currentUserId = pendingOTP.user.user_id;
                
                // Show success message
                showStatus('otpStatus', 'Email verified successfully!', 'success');
                document.getElementById('otpTimer').textContent = 'Verified';
                document.getElementById('otpTimer').className = 'otp-success';
                
                // Show main app after a short delay
                setTimeout(() => {
                    showMainApp();
                }, 1500);
                
            } catch (error) {
                console.error('OTP verification error:', error);
                showStatus('otpStatus', `Verification failed: ${error.message}`, 'error');
            }
        }
        
        // Enhanced resend OTP
        async function resendOTP() {
            try {
                if (!pendingOTP) {
                    showStatus('otpStatus', 'No pending verification found', 'error');
                    return;
                }
                
                // Generate new OTP
                const otpCode = Math.floor(100000 + Math.random() * 900000).toString();
                const expiresAt = new Date(Date.now() + 10 * 60 * 1000);
                
                await supabase
                    .from('otp_verification')
                    .insert([{
                        user_id: pendingOTP.user.user_id,
                        email: pendingOTP.email,
                        otp_code: otpCode,
                        expires_at: expiresAt.toISOString(),
                        is_used: false
                    }]);
                
                pendingOTP.otp = otpCode;
                
                // Restart timer
                startOTPTimer();
                
                showStatus('otpStatus', 'New verification code sent!', 'success');
                
            } catch (error) {
                console.error('Resend OTP error:', error);
                showStatus('otpStatus', `Failed to resend code: ${error.message}`, 'error');
            }
        }
        
        // Add event listeners for dynamic form behavior
        function addFormEventListeners() {
            // Occupation change handler for signup form
            const signupOccupation = document.getElementById('signupOccupation');
            if (signupOccupation) {
                signupOccupation.addEventListener('change', function() {
                    toggleSignupEmployerFields(this.value);
                });
            }
            
            // Occupation change handler for profile form
            const profileOccupation = document.getElementById('profileOccupation');
            if (profileOccupation) {
                profileOccupation.addEventListener('change', function() {
                    toggleEmployerFields(this.value);
                });
            }
            
            // PIN code change handler for signup form
            const signupPinCode = document.getElementById('signupPinCode');
            if (signupPinCode) {
                signupPinCode.addEventListener('input', function() {
                    if (this.value.length === 6) {
                        fetchCityStateFromPin(this.value, 'signup');
                    }
                });
            }
            
            // PIN code change handler for profile form
            const profilePinCode = document.getElementById('profilePinCode');
            if (profilePinCode) {
                profilePinCode.addEventListener('input', function() {
                    if (this.value.length === 6) {
                        fetchCityStateFromPin(this.value, 'profile');
                    }
                });
            }
        }
        
        function toggleSignupEmployerFields(occupation) {
            const employerGroup = document.getElementById('employerGroup');
            const employerCategoryGroup = document.getElementById('employerCategoryGroup');
            
            if (occupation === 'Salaried') {
                employerGroup.classList.add('show');
                employerCategoryGroup.classList.add('show');
            } else {
                employerGroup.classList.remove('show');
                employerCategoryGroup.classList.remove('show');
            }
        }
        
        // Deduction management functions
        function populateDeductionOptions(regime) {
            const deductionSelect = document.getElementById('deductionSection');
            const regimeInfo = document.getElementById('deductionRegimeInfo');
            
            if (!deductionSelect) return;
            
            // Clear existing options
            deductionSelect.innerHTML = '';
            
            let options = [];
            
            if (regime === 'old') {
                // Old Regime Deductions
                options = [
                    { value: '80C', text: '80C - Life Insurance, PPF, EPF, ELSS, etc. (Max â‚¹1,50,000)' },
                    { value: '80D', text: '80D - Medical Insurance (Max â‚¹25,000-â‚¹1,00,000)' },
                    { value: '80E', text: '80E - Education Loan Interest (No limit)' },
                    { value: '80G', text: '80G - Donations (50% or 100% of amount)' },
                    { value: '24B', text: '24B - Home Loan Interest (Max â‚¹2,00,000)' },
                    { value: '80TTA', text: '80TTA - Interest on Savings Account (Max â‚¹10,000)' },
                    { value: '80CCD', text: '80CCD - NPS Contribution (Max â‚¹50,000)' }
                ];
                regimeInfo.innerHTML = '<small>âœ… All deductions available in Old Regime</small>';
            } else {
                // New Regime Deductions
                options = [
                    { value: '80CCD(2)', text: '80CCD(2) - Employer NPS Contribution (Max â‚¹50,000)' },
                    { value: '80CCH(2)', text: '80CCH(2) - Agniveer Corpus Fund (No limit)' },
                    { value: '57(iia)', text: '57(iia) - Family Pension (Max â‚¹25,000)' }
                ];
                regimeInfo.innerHTML = '<small>âš ï¸ Limited deductions available in New Regime</small>';
            }
            
            // Add options to select
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                deductionSelect.appendChild(optionElement);
            });
            
            // Show regime info
            regimeInfo.classList.remove('hidden');
        }
        
        function updateDeductionOptions() {
            const taxRegimeElement = document.getElementById('taxRegime');
            if (taxRegimeElement) {
                populateDeductionOptions(taxRegimeElement.value);
            }
        }
        
        function onTaxRegimeChange() {
            updateDeductionOptions();
            // Clear deduction form when regime changes
            const deductionAmount = document.getElementById('deductionAmount');
            const deductionYear = document.getElementById('deductionYear');
            if (deductionAmount) deductionAmount.value = '';
            if (deductionYear) deductionYear.value = '';
        }

        // Permanent address management functions
        function togglePermanentAddressFields() {
            const option = document.getElementById('permanentAddressOption').value;
            const fields = document.getElementById('permanentAddressFields');
            const permanentAddress = document.getElementById('profilePermanentAddress');
            
            if (option === 'same') {
                fields.classList.add('hidden');
                copyResidentialToPermanent();
            } else {
                fields.classList.remove('hidden');
                clearPermanentAddress();
            }
        }
        
        function copyResidentialToPermanent() {
            const streetAddress = document.getElementById('profileStreetAddress').value;
            const pinCode = document.getElementById('profilePinCode').value;
            const city = document.getElementById('profileCity').value;
            const state = document.getElementById('profileState').value;
            
            if (streetAddress && pinCode && city && state) {
                const permanentAddress = `${streetAddress}, ${city}, ${state} - ${pinCode}`;
                document.getElementById('profilePermanentAddress').value = permanentAddress;
            } else {
                document.getElementById('profilePermanentAddress').value = 'SAME AS RESIDENTIAL ADDRESS';
            }
        }
        
        function clearPermanentAddress() {
            document.getElementById('profilePermanentAddress').value = '';
        }
        
        function updatePermanentAddress() {
            const option = document.getElementById('permanentAddressOption').value;
            
            if (option === 'same') {
                copyResidentialToPermanent();
            } else {
                const streetAddress = document.getElementById('profilePermanentStreetAddress').value;
                const pinCode = document.getElementById('profilePermanentPinCode').value;
                const city = document.getElementById('profilePermanentCity').value;
                const state = document.getElementById('profilePermanentState').value;
                
                if (streetAddress && pinCode && city && state) {
                    const permanentAddress = `${streetAddress}, ${city}, ${state} - ${pinCode}`;
                    document.getElementById('profilePermanentAddress').value = permanentAddress;
                } else {
                    document.getElementById('profilePermanentAddress').value = '';
                }
            }
        }
        
        // Add event listeners for residential address changes
        function addResidentialAddressListeners() {
            const residentialFields = ['profileStreetAddress', 'profilePinCode', 'profileCity', 'profileState'];
            residentialFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        if (document.getElementById('permanentAddressOption').value === 'same') {
                            copyResidentialToPermanent();
                        }
                    });
                }
            });
            
            const permanentFields = ['profilePermanentStreetAddress', 'profilePermanentPinCode', 'profilePermanentCity', 'profilePermanentState'];
            permanentFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updatePermanentAddress);
                }
            });
        }

        // Check return status and disable editing if locked
        async function checkReturnStatus() {
            try {
                const financialYearStr = document.getElementById('financialYear').value;
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                
                const { data: returnData, error } = await supabase
                    .from('tax_returns')
                    .select('status, is_draft')
                    .eq('user_id', currentUserId)
                    .eq('financial_year', financialYear)
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                    throw error;
                }
                
                if (returnData && returnData.status === 'Filed' && !returnData.is_draft) {
                    // Disable editing
                    disableEditing();
                    showLockedStatus();
                } else {
                    // Enable editing
                    enableEditing();
                    hideLockedStatus();
                }
                
            } catch (error) {
                console.error('Error checking return status:', error);
            }
        }
        
        // Disable editing when return is locked
        function disableEditing() {
            // Disable income editing
            const incomeButtons = document.querySelectorAll('#incomeCard button');
            incomeButtons.forEach(btn => {
                if (btn.textContent.includes('Add') || btn.textContent.includes('Update')) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                }
            });
            
            // Show income locked warning
            const incomeLockedWarning = document.getElementById('incomeLockedWarning');
            if (incomeLockedWarning) {
                incomeLockedWarning.classList.remove('hidden');
            }
            
            // Disable deduction editing
            const deductionButtons = document.querySelectorAll('#deductionsCard button');
            deductionButtons.forEach(btn => {
                if (btn.textContent.includes('Add') || btn.textContent.includes('Update')) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                }
            });
            
            // Show deduction locked warning
            const deductionLockedWarning = document.getElementById('deductionLockedWarning');
            if (deductionLockedWarning) {
                deductionLockedWarning.classList.remove('hidden');
            }
            
            // Disable form inputs
            const incomeInputs = document.querySelectorAll('#incomeCard input, #incomeCard select');
            incomeInputs.forEach(input => input.disabled = true);
            
            const deductionInputs = document.querySelectorAll('#deductionsCard input, #deductionsCard select');
            deductionInputs.forEach(input => input.disabled = true);
        }
        
        // Enable editing when return is unlocked
        function enableEditing() {
            // Enable income editing
            const incomeButtons = document.querySelectorAll('#incomeCard button');
            incomeButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            
            // Hide income locked warning
            const incomeLockedWarning = document.getElementById('incomeLockedWarning');
            if (incomeLockedWarning) {
                incomeLockedWarning.classList.add('hidden');
            }
            
            // Enable deduction editing
            const deductionButtons = document.querySelectorAll('#deductionsCard button');
            deductionButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            
            // Hide deduction locked warning
            const deductionLockedWarning = document.getElementById('deductionLockedWarning');
            if (deductionLockedWarning) {
                deductionLockedWarning.classList.add('hidden');
            }
            
            // Enable form inputs
            const incomeInputs = document.querySelectorAll('#incomeCard input, #incomeCard select');
            incomeInputs.forEach(input => input.disabled = false);
            
            const deductionInputs = document.querySelectorAll('#deductionsCard input, #deductionsCard select');
            deductionInputs.forEach(input => input.disabled = false);
        }

        // Process flow navigation functions
        function proceedToIncome() {
            document.getElementById('fileReturnCard').classList.add('hidden');
            document.getElementById('incomeCard').classList.remove('hidden');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            
            // Sync financial year
            const financialYear = document.getElementById('financialYear').value;
            document.getElementById('incomeYear').value = financialYear;
            
            // Check return status for new financial year
            checkReturnStatus();
        }

        function proceedToDeductions() {
            document.getElementById('incomeCard').classList.add('hidden');
            document.getElementById('deductionsCard').classList.remove('hidden');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            
            // Sync financial year
            const financialYear = document.getElementById('financialYear').value;
            document.getElementById('deductionYear').value = financialYear;
            
            // Initialize deduction options based on current tax regime
            updateDeductionOptions();
            
            // Check return status for new financial year
            checkReturnStatus();
        }

        function proceedToReview() {
            document.getElementById('deductionsCard').classList.add('hidden');
            document.getElementById('reviewCard').classList.remove('hidden');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step4').classList.add('active');
            
            // Calculate and display tax summary
            calculateTaxSummary();
        }

        // Navigation functions for going back
        function goBackToIncome() {
            document.getElementById('deductionsCard').classList.add('hidden');
            document.getElementById('reviewCard').classList.add('hidden');
            document.getElementById('incomeCard').classList.remove('hidden');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step4').classList.remove('active');
            
            // Load income data
            loadIncome();
        }

        function goBackToDeductions() {
            document.getElementById('reviewCard').classList.add('hidden');
            document.getElementById('deductionsCard').classList.remove('hidden');
            document.getElementById('step3').classList.add('active');
            document.getElementById('step4').classList.remove('active');
            
            // Load deductions data
            loadDeductions();
        }

        function goBackToFileReturn() {
            hideAllCards();
            document.getElementById('fileReturnCard').classList.remove('hidden');
            // Reset step indicators
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step4').classList.remove('active');
        }

        // Regime-specific deduction calculation
        function calculateRegimeSpecificDeductions(deductionData, regime) {
            let totalDeductions = 0;
            let allowedDeductions = [];
            let disallowedDeductions = [];
            
            if (regime === 'old') {
                // Old Regime: Allow all deductions
                deductionData.forEach(deduction => {
                    const amount = parseFloat(deduction.amount);
                    const sectionCode = deduction.section_code || 'Unknown';
                    totalDeductions += amount;
                    allowedDeductions.push({
                        section: sectionCode,
                        amount: amount,
                        description: getDeductionDescription(sectionCode)
                    });
                });
            } else {
                // New Regime: Only allow specific deductions (FY 2024-25)
                const newRegimeAllowedSections = ['80CCD(2)', '80CCH(2)', '57(iia)'];
                
                deductionData.forEach(deduction => {
                    const amount = parseFloat(deduction.amount);
                    const sectionCode = deduction.section_code || '';
                    
                    // Check if this deduction is allowed in new regime
                    const isAllowed = newRegimeAllowedSections.some(allowed => 
                        sectionCode && sectionCode.includes(allowed) || sectionCode === allowed
                    );
                    
                    if (isAllowed) {
                        totalDeductions += amount;
                        allowedDeductions.push({
                            section: sectionCode,
                            amount: amount,
                            description: getDeductionDescription(sectionCode)
                        });
                    } else {
                        disallowedDeductions.push({
                            section: sectionCode,
                            amount: amount,
                            description: getDeductionDescription(sectionCode)
                        });
                    }
                });
            }
            
            return {
                totalDeductions,
                allowedDeductions,
                disallowedDeductions
            };
        }
        
        // Get deduction description
        function getDeductionDescription(sectionCode) {
            const descriptions = {
                '80C': 'Life Insurance, PPF, EPF, ELSS, etc.',
                '80D': 'Medical Insurance',
                '80E': 'Education Loan Interest',
                '80G': 'Donations',
                '24B': 'Home Loan Interest',
                '80TTA': 'Interest on Savings Account',
                '80CCD': 'NPS Contribution',
                '80CCD(2)': 'Employer NPS Contribution',
                '80CCH(2)': 'Agniveer Corpus Fund',
                '57(iia)': 'Family Pension'
            };
            return descriptions[sectionCode] || sectionCode;
        }

        // Tax calculation functions (FY 2024-25)
        function calculateOldRegimeTax(taxableIncome) {
            let tax = 0;
            let breakdown = [];
            
            // FY 2024-25 Old Regime Tax Slabs
            if (taxableIncome <= 250000) {
                tax = 0;
                breakdown.push("No tax (up to â‚¹2,50,000)");
            } else if (taxableIncome <= 500000) {
                tax = (taxableIncome - 250000) * 0.05;
                breakdown.push("5% on income above â‚¹2,50,000");
            } else if (taxableIncome <= 1000000) {
                tax = 12500 + (taxableIncome - 500000) * 0.20;
                breakdown.push("â‚¹12,500 + 20% on income above â‚¹5,00,000");
            } else {
                tax = 112500 + (taxableIncome - 1000000) * 0.30;
                breakdown.push("â‚¹1,12,500 + 30% on income above â‚¹10,00,000");
            }
            
            // Add 4% Health and Education Cess
            const cess = tax * 0.04;
            tax += cess;
            breakdown.push("+ 4% cess");
            
            // Add surcharge for high income
            let surcharge = 0;
            if (taxableIncome > 5000000 && taxableIncome <= 10000000) {
                surcharge = tax * 0.10;
                tax += surcharge;
                breakdown.push("+ 10% surcharge");
            } else if (taxableIncome > 10000000 && taxableIncome <= 20000000) {
                surcharge = tax * 0.15;
                tax += surcharge;
                breakdown.push("+ 15% surcharge");
            } else if (taxableIncome > 20000000 && taxableIncome <= 50000000) {
                surcharge = tax * 0.25;
                tax += surcharge;
                breakdown.push("+ 25% surcharge");
            } else if (taxableIncome > 50000000) {
                surcharge = tax * 0.37;
                tax += surcharge;
                breakdown.push("+ 37% surcharge");
            }
            
            return {
                tax: Math.round(tax),
                breakdown: breakdown.join(", ")
            };
        }

        function calculateNewRegimeTax(taxableIncome) {
            // Apply standard deduction of â‚¹75,000 for FY 2024-25
            const incomeAfterStandardDeduction = Math.max(0, taxableIncome - 75000);
            let tax = 0;
            let breakdown = [];
            
            // FY 2024-25 New Regime Tax Slabs
            if (incomeAfterStandardDeduction <= 300000) {
                tax = 0;
                breakdown.push("No tax (up to â‚¹3,00,000) + â‚¹75,000 standard deduction");
            } else if (incomeAfterStandardDeduction <= 600000) {
                tax = (incomeAfterStandardDeduction - 300000) * 0.05;
                breakdown.push("5% on income above â‚¹3,00,000 + â‚¹75,000 standard deduction");
            } else if (incomeAfterStandardDeduction <= 900000) {
                tax = 15000 + (incomeAfterStandardDeduction - 600000) * 0.10;
                breakdown.push("â‚¹15,000 + 10% on income above â‚¹6,00,000 + â‚¹75,000 standard deduction");
            } else if (incomeAfterStandardDeduction <= 1200000) {
                tax = 45000 + (incomeAfterStandardDeduction - 900000) * 0.15;
                breakdown.push("â‚¹45,000 + 15% on income above â‚¹9,00,000 + â‚¹75,000 standard deduction");
            } else if (incomeAfterStandardDeduction <= 1500000) {
                tax = 90000 + (incomeAfterStandardDeduction - 1200000) * 0.20;
                breakdown.push("â‚¹90,000 + 20% on income above â‚¹12,00,000 + â‚¹75,000 standard deduction");
            } else {
                tax = 150000 + (incomeAfterStandardDeduction - 1500000) * 0.30;
                breakdown.push("â‚¹1,50,000 + 30% on income above â‚¹15,00,000 + â‚¹75,000 standard deduction");
            }
            
            // Add 4% Health and Education Cess
            const cess = tax * 0.04;
            tax += cess;
            breakdown.push("+ 4% cess");
            
            // Add surcharge for high income
            let surcharge = 0;
            if (incomeAfterStandardDeduction > 5000000) {
                if (incomeAfterStandardDeduction <= 10000000) {
                    surcharge = tax * 0.10;
                    tax += surcharge;
                    breakdown.push("+ 10% surcharge");
                } else if (incomeAfterStandardDeduction <= 20000000) {
                    surcharge = tax * 0.15;
                    tax += surcharge;
                    breakdown.push("+ 15% surcharge");
                } else if (incomeAfterStandardDeduction <= 50000000) {
                    surcharge = tax * 0.25;
                    tax += surcharge;
                    breakdown.push("+ 25% surcharge");
                } else {
                    surcharge = tax * 0.37;
                    tax += surcharge;
                    breakdown.push("+ 37% surcharge");
                }
            }
            
            return {
                tax: Math.round(tax),
                breakdown: breakdown.join(", ")
            };
        }

        // Calculate tax summary for review
        async function calculateTaxSummary() {
            try {
                const financialYearElement = document.getElementById('financialYear');
                if (!financialYearElement) {
                    throw new Error('Financial year field not found');
                }
                
                const financialYearStr = financialYearElement.value;
                if (!financialYearStr) {
                    throw new Error('Financial year is required');
                }
                // Convert "2023-24" to 2024 for database
                const financialYear = parseInt(financialYearStr.split('-')[1]);
                if (isNaN(financialYear)) {
                    throw new Error('Invalid financial year format');
                }
                
                // Get income data
                const { data: incomeData, error: incomeError } = await supabase
                    .from('income_sources')
                    .select('amount')
                    .eq('financial_year', financialYear);
                
                if (incomeError) throw incomeError;
                
                // Get deduction data
                const { data: deductionData, error: deductionError } = await supabase
                    .from('deductions')
                    .select('amount')
                    .eq('financial_year', financialYear);
                
                if (deductionError) throw deductionError;
                
                // Calculate totals
                const incomeDataSafe = incomeData || [];
                const totalIncome = incomeDataSafe.reduce((sum, income) => sum + parseFloat(income.amount || 0), 0);
                
                // Calculate regime-specific deductions
                const deductionDataSafe = deductionData || [];
                const oldRegimeDeductions = calculateRegimeSpecificDeductions(deductionDataSafe, 'old');
                const newRegimeDeductions = calculateRegimeSpecificDeductions(deductionDataSafe, 'new');
                
                const oldRegimeTaxableIncome = Math.max(0, totalIncome - oldRegimeDeductions.totalDeductions);
                const newRegimeTaxableIncome = Math.max(0, totalIncome - newRegimeDeductions.totalDeductions);
                
                // Update summary display
                document.getElementById('summaryTotalIncome').textContent = `â‚¹${totalIncome.toLocaleString()}`;
                document.getElementById('summaryTotalDeductions').textContent = `â‚¹${oldRegimeDeductions.totalDeductions.toLocaleString()}`;
                document.getElementById('summaryTaxableIncome').textContent = `â‚¹${oldRegimeTaxableIncome.toLocaleString()}`;
                
                // Calculate tax for both regimes with their respective deductions
                const oldRegime = calculateOldRegimeTax(oldRegimeTaxableIncome);
                const newRegime = calculateNewRegimeTax(newRegimeTaxableIncome);
                
                // Update tax display
                document.getElementById('oldRegimeTax').textContent = `â‚¹${oldRegime.tax.toLocaleString()}`;
                document.getElementById('oldRegimeBreakdown').textContent = oldRegime.breakdown;
                document.getElementById('newRegimeTax').textContent = `â‚¹${newRegime.tax.toLocaleString()}`;
                document.getElementById('newRegimeBreakdown').textContent = newRegime.breakdown;
                
                // Show recommendation with deduction details
                const recommendation = document.getElementById('taxRecommendation');
                let recommendationHtml = '';
                
                if (oldRegime.tax < newRegime.tax) {
                    recommendation.className = 'recommendation old-regime';
                    recommendationHtml = `ðŸ’¡ <strong>Recommendation: Old Regime</strong><br>Save â‚¹${(newRegime.tax - oldRegime.tax).toLocaleString()}`;
                } else {
                    recommendation.className = 'recommendation new-regime';
                    recommendationHtml = `ðŸ’¡ <strong>Recommendation: New Regime</strong><br>Save â‚¹${(oldRegime.tax - newRegime.tax).toLocaleString()}`;
                }
                
                // Add deduction details
                recommendationHtml += '<br><br><strong>Deduction Summary:</strong><br>';
                recommendationHtml += `<strong>Old Regime Deductions:</strong> â‚¹${oldRegimeDeductions.totalDeductions.toLocaleString()}<br>`;
                recommendationHtml += `<strong>New Regime Deductions:</strong> â‚¹${newRegimeDeductions.totalDeductions.toLocaleString()}<br>`;
                
                if (oldRegimeDeductions.disallowedDeductions.length > 0) {
                    recommendationHtml += '<br><strong>âš ï¸ New Regime Disallowed Deductions:</strong><br>';
                    oldRegimeDeductions.disallowedDeductions.forEach(ded => {
                        recommendationHtml += `â€¢ ${ded.section} (${ded.description}): â‚¹${ded.amount.toLocaleString()}<br>`;
                    });
                }
                
                recommendation.innerHTML = recommendationHtml;
                
            } catch (error) {
                alert(`Error calculating tax summary: ${error.message}`);
            }
        }

        // Validate deduction limits
        function validateDeductionLimit() {
            const section = document.getElementById('deductionSection').value;
            const amount = parseFloat(document.getElementById('deductionAmount').value) || 0;
            const infoBox = document.getElementById('deductionLimitInfo');
            
            const limits = {
                // Old Regime Deductions (FY 2024-25)
                '80C': 150000,
                '80D': 25000, // Basic limit, can be higher for senior citizens
                '80E': Infinity,
                '80G': Infinity,
                '24B': 200000,
                '80TTA': 10000,
                '80CCD': 50000,
                // New Regime Deductions (FY 2024-25)
                '80CCD(2)': 50000, // Employer NPS contribution
                '80CCH(2)': Infinity, // Agniveer Corpus Fund
                '57(iia)': 25000 // Family pension
            };
            
            const limit = limits[section];
            if (limit && amount > limit) {
                infoBox.classList.remove('hidden');
                infoBox.innerHTML = `âš ï¸ Maximum limit for ${section} is â‚¹${limit.toLocaleString()}. You entered â‚¹${amount.toLocaleString()}.`;
            } else {
                infoBox.classList.add('hidden');
            }
        }

        // Auto-calculate taxable income
        function calculateTaxableIncome() {
            // This will be called when income amount changes
            // The actual calculation happens in calculateTaxSummary()
        }

        // Theme Toggle Functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                if (themeIcon) themeIcon.className = 'fas fa-sun';
            } else {
                if (themeIcon) themeIcon.className = 'fas fa-moon';
            }
        }

        // Tax Calendar Functions
        const taxDeadlines = [
            {
                title: "Advance Tax - Q1",
                date: "2024-06-15",
                description: "First installment of advance tax for FY 2024-25",
                type: "advance_tax",
                priority: "warning"
            },
            {
                title: "Advance Tax - Q2", 
                date: "2024-09-15",
                description: "Second installment of advance tax for FY 2024-25",
                type: "advance_tax",
                priority: "warning"
            },
            {
                title: "Advance Tax - Q3",
                date: "2024-12-15", 
                description: "Third installment of advance tax for FY 2024-25",
                type: "advance_tax",
                priority: "warning"
            },
            {
                title: "Advance Tax - Q4",
                date: "2025-03-15",
                description: "Final installment of advance tax for FY 2024-25",
                type: "advance_tax", 
                priority: "urgent"
            },
            {
                title: "ITR Filing Deadline",
                date: "2025-07-31",
                description: "Last date to file Income Tax Return for FY 2024-25",
                type: "itr_filing",
                priority: "urgent"
            },
            {
                title: "Revised ITR Deadline",
                date: "2025-12-31",
                description: "Last date to file revised ITR for FY 2024-25",
                type: "revised_itr",
                priority: "info"
            },
            {
                title: "TDS Return - Q1",
                date: "2024-07-31",
                description: "TDS return filing for Q1 FY 2024-25",
                type: "tds_return",
                priority: "info"
            },
            {
                title: "TDS Return - Q2",
                date: "2024-10-31", 
                description: "TDS return filing for Q2 FY 2024-25",
                type: "tds_return",
                priority: "info"
            },
            {
                title: "TDS Return - Q3",
                date: "2025-01-31",
                description: "TDS return filing for Q3 FY 2024-25", 
                type: "tds_return",
                priority: "info"
            },
            {
                title: "TDS Return - Q4",
                date: "2025-05-31",
                description: "TDS return filing for Q4 FY 2024-25",
                type: "tds_return", 
                priority: "info"
            }
        ];

        function showCurrentYear() {
            const currentYear = new Date().getFullYear();
            const currentYearEvents = taxDeadlines.filter(event => 
                new Date(event.date).getFullYear() === currentYear
            );
            displayCalendarEvents(currentYearEvents);
        }

        function showNextYear() {
            const nextYear = new Date().getFullYear() + 1;
            const nextYearEvents = taxDeadlines.filter(event => 
                new Date(event.date).getFullYear() === nextYear
            );
            displayCalendarEvents(nextYearEvents);
        }

        function showAllDeadlines() {
            displayCalendarEvents(taxDeadlines);
        }

        function displayCalendarEvents(events) {
            const container = document.getElementById('calendarEvents');
            if (!container) return;

            const sortedEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedEvents.map(event => {
                const eventDate = new Date(event.date);
                const today = new Date();
                const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                
                let priorityClass = event.priority;
                if (daysUntil < 0) {
                    priorityClass = 'urgent';
                } else if (daysUntil <= 7) {
                    priorityClass = 'urgent';
                } else if (daysUntil <= 30) {
                    priorityClass = 'warning';
                }

                return `
                    <div class="calendar-event ${priorityClass}">
                        <div class="event-header">
                            <div class="event-title">${event.title}</div>
                            <div class="event-date">${eventDate.toLocaleDateString('en-IN')}</div>
                        </div>
                        <div class="event-description">${event.description}</div>
                        <div class="event-description">
                            <strong>Days remaining: ${daysUntil < 0 ? 'Overdue' : daysUntil}</strong>
                        </div>
                        <div class="event-actions">
                            <button class="btn-remind" onclick="setReminder('${event.title}', '${event.date}')">
                                <i class="fas fa-bell"></i> Remind Me
                            </button>
                            <button class="btn-complete" onclick="markComplete('${event.title}')">
                                <i class="fas fa-check"></i> Mark Complete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setReminder(title, date) {
            alert(`Reminder set for ${title} on ${new Date(date).toLocaleDateString('en-IN')}`);
            // In a real app, this would integrate with browser notifications or calendar apps
        }

        function markComplete(title) {
            // Find the task card by title
            const taskCards = document.querySelectorAll('.calendar-event');
            let targetCard = null;
            
            taskCards.forEach(card => {
                const taskTitle = card.querySelector('.event-title');
                if (taskTitle && taskTitle.textContent.trim() === title) {
                    targetCard = card;
                }
            });
            
            if (targetCard) {
                // Update the card appearance
                targetCard.style.opacity = '0.6';
                targetCard.style.backgroundColor = '#f0f9ff';
                targetCard.style.borderLeft = '4px solid #10b981';
                
                // Update the status
                const statusElement = targetCard.querySelector('.event-description');
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Completed';
                    statusElement.style.color = '#10b981';
                }
                
                // Update the buttons
                const buttonContainer = targetCard.querySelector('.event-actions');
                if (buttonContainer) {
                    buttonContainer.innerHTML = `
                        <button class="btn-undo" onclick="undoComplete('${title}')">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                        <button class="btn-delete" onclick="deleteTask('${title}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                // Show success message
                showNotification(`${title} marked as complete!`, 'success');
                
                // In a real app, this would update the database
                console.log(`Task "${title}" marked as complete`);
            }
        }
        
        function undoComplete(title) {
            // Find the task card by title
            const taskCards = document.querySelectorAll('.calendar-event');
            let targetCard = null;
            
            taskCards.forEach(card => {
                const taskTitle = card.querySelector('.event-title');
                if (taskTitle && taskTitle.textContent.trim() === title) {
                    targetCard = card;
                }
            });
            
            if (targetCard) {
                // Restore original appearance
                targetCard.style.opacity = '1';
                targetCard.style.backgroundColor = '';
                targetCard.style.borderLeft = '4px solid #ef4444';
                
                // Restore the status
                const statusElement = targetCard.querySelector('.event-description');
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Days remaining: Overdue';
                    statusElement.style.color = '#ef4444';
                }
                
                // Restore the buttons
                const buttonContainer = targetCard.querySelector('.event-actions');
                if (buttonContainer) {
                    buttonContainer.innerHTML = `
                        <button class="btn-remind" onclick="setReminder('${title}')">
                            <i class="fas fa-bell"></i> Remind Me
                        </button>
                        <button class="btn-complete" onclick="markComplete('${title}')">
                            <i class="fas fa-check"></i> Mark Complete
                        </button>
                    `;
                }
                
                showNotification(`${title} status reverted!`, 'info');
                console.log(`Task "${title}" status reverted`);
            }
        }
        
        function deleteTask(title) {
            if (confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) {
                // Find and remove the task card
                const taskCards = document.querySelectorAll('.calendar-event');
                taskCards.forEach(card => {
                    const taskTitle = card.querySelector('.event-title');
                    if (taskTitle && taskTitle.textContent.trim() === title) {
                        card.style.transition = 'all 0.3s ease';
                        card.style.transform = 'translateX(-100%)';
                        card.style.opacity = '0';
                        
                        setTimeout(() => {
                            card.remove();
                            showNotification(`${title} deleted successfully!`, 'success');
                        }, 300);
                    }
                });
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-100%)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        // Navigation functions for new sections
        function showTaxCalendar() {
            // Hide all other sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // Show tax calendar
            document.getElementById('taxCalendarCard').classList.remove('hidden');
            
            // Load current year events by default
            showCurrentYear();
        }

        function goBackToDashboard() {
            // Hide all other sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // Show the main dashboard (review section)
            document.getElementById('reviewCard').classList.remove('hidden');
        }

        function showAnalytics() {
            // Hide all other sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // Show analytics section
            document.getElementById('analyticsCard').classList.remove('hidden');
            
            // Load income analytics by default
            showIncomeAnalytics();
        }

        function showReports() {
            // Hide all other sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // Show reports section
            document.getElementById('reportsCard').classList.remove('hidden');
        }

        function showRefund() {
            // Hide all other sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // Show refund section
            document.getElementById('refundCard').classList.remove('hidden');
            
            // Check refund eligibility
            checkRefundEligibility();
        }

        // Payment Gateway Functions
        let selectedPaymentMethod = null;
        let paymentAmount = 0;

        function showPaymentGateway(taxAmount) {
            paymentAmount = taxAmount;
            
            // Hide all other sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // Show payment section
            document.getElementById('paymentCard').classList.remove('hidden');
            
            // Display payment summary
            displayPaymentSummary(taxAmount);
            
            // Show payment options
            document.getElementById('paymentOptions').classList.remove('hidden');
        }

        function displayPaymentSummary(amount) {
            const summaryContainer = document.getElementById('paymentSummary');
            const convenienceFee = Math.round(amount * 0.02); // 2% convenience fee
            const totalAmount = amount + convenienceFee;
            
            summaryContainer.innerHTML = `
                <h3>Payment Summary</h3>
                <div class="payment-amount">â‚¹${totalAmount.toLocaleString()}</div>
                <div class="payment-details">
                    <div class="payment-detail">
                        <span>Tax Amount:</span>
                        <span>â‚¹${amount.toLocaleString()}</span>
                    </div>
                    <div class="payment-detail">
                        <span>Convenience Fee (2%):</span>
                        <span>â‚¹${convenienceFee.toLocaleString()}</span>
                    </div>
                    <div class="payment-detail">
                        <span>Total Amount:</span>
                        <span>â‚¹${totalAmount.toLocaleString()}</span>
                    </div>
                </div>
            `;
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Remove selected class from all methods
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selected class to clicked method
            event.currentTarget.classList.add('selected');
            
            // Show payment form
            showPaymentForm(method);
        }

        function showPaymentForm(method) {
            const formContainer = document.getElementById('paymentForm');
            formContainer.classList.remove('hidden');
            
            let formHTML = '';
            
            switch(method) {
                case 'netbanking':
                    formHTML = `
                        <h4>Net Banking</h4>
                        <div class="form-group">
                            <label>Select Bank:</label>
                            <select class="form-control">
                                <option>SBI</option>
                                <option>HDFC Bank</option>
                                <option>ICICI Bank</option>
                                <option>Axis Bank</option>
                                <option>Kotak Mahindra Bank</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="processPayment('netbanking')">Proceed to Bank</button>
                    `;
                    break;
                    
                case 'upi':
                    formHTML = `
                        <h4>UPI Payment</h4>
                        <div class="form-group">
                            <label>UPI ID:</label>
                            <input type="text" class="form-control" placeholder="yourname@paytm" required>
                        </div>
                        <button class="btn btn-success" onclick="processPayment('upi')">Pay via UPI</button>
                    `;
                    break;
                    
                case 'card':
                    formHTML = `
                        <h4>Card Payment</h4>
                        <div class="form-group">
                            <label>Card Number:</label>
                            <input type="text" class="form-control" placeholder="1234 5678 9012 3456" required>
                        </div>
                        <div class="form-group">
                            <label>Expiry Date:</label>
                            <input type="text" class="form-control" placeholder="MM/YY" required>
                        </div>
                        <div class="form-group">
                            <label>CVV:</label>
                            <input type="text" class="form-control" placeholder="123" required>
                        </div>
                        <button class="btn btn-success" onclick="processPayment('card')">Pay Now</button>
                    `;
                    break;
                    
                case 'neft':
                    formHTML = `
                        <h4>NEFT/RTGS Details</h4>
                        <div class="payment-details">
                            <div class="payment-detail">
                                <span>Account Number:</span>
                                <span>1234567890</span>
                            </div>
                            <div class="payment-detail">
                                <span>IFSC Code:</span>
                                <span>SBIN0001234</span>
                            </div>
                            <div class="payment-detail">
                                <span>Amount:</span>
                                <span>â‚¹${paymentAmount.toLocaleString()}</span>
                            </div>
                        </div>
                        <p>Please make payment using the above details and upload the receipt.</p>
                        <button class="btn btn-success" onclick="processPayment('neft')">Upload Receipt</button>
                    `;
                    break;
                    
                case 'challan':
                    formHTML = `
                        <h4>Challan 280 Generation</h4>
                        <p>Generate Challan 280 for tax payment at any authorized bank.</p>
                        <div class="payment-details">
                            <div class="payment-detail">
                                <span>Challan Number:</span>
                                <span>CH280${Date.now()}</span>
                            </div>
                            <div class="payment-detail">
                                <span>Amount:</span>
                                <span>â‚¹${paymentAmount.toLocaleString()}</span>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="generateChallan()">Generate Challan</button>
                    `;
                    break;
            }
            
            formContainer.innerHTML = formHTML;
        }

        function processPayment(method) {
            // Simulate payment processing
            showToast(`Processing ${method} payment...`, 'info', 'Payment Processing');
            
            // Simulate successful payment
            setTimeout(() => {
                showPaymentReceipt(method);
            }, 2000);
        }

        function generateChallan() {
            const challanNumber = `CH280${Date.now()}`;
            const challanContent = `
                <div class="header">
                    <h1>CHALLAN 280 - INCOME TAX</h1>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="section">
                    <h3>Challan Details</h3>
                    <table class="table">
                        <tr><th>Particulars</th><th>Details</th></tr>
                        <tr><td>Challan Number</td><td>${challanNumber}</td></tr>
                        <tr><td>Date</td><td>${new Date().toLocaleDateString('en-IN')}</td></tr>
                        <tr><td>Amount</td><td>â‚¹${paymentAmount.toLocaleString()}</td></tr>
                        <tr><td>Tax Type</td><td>Income Tax</td></tr>
                        <tr><td>Assessment Year</td><td>2025-26</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Payment Instructions</h3>
                    <p>Please take this challan to any authorized bank for payment.</p>
                    <p><strong>Note:</strong> Keep a copy of this challan for your records.</p>
                </div>
                
                <div class="footer">
                    <p>This challan is generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                </div>
            `;
            
            generatePDF(`Challan280_${challanNumber}`, challanContent);
            showPaymentReceipt('challan');
        }

        function generateReturnPDF(financialYear) {
            const returnContent = `
                <div class="header">
                    <h1>INCOME TAX RETURN</h1>
                    <p>Financial Year: ${financialYear}</p>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="section">
                    <h3>Taxpayer Information</h3>
                    <table class="table">
                        <tr><th>Field</th><th>Value</th></tr>
                        <tr><td>Name</td><td>${currentUser?.name || 'N/A'}</td></tr>
                        <tr><td>PAN</td><td>${currentUser?.pan || 'N/A'}</td></tr>
                        <tr><td>Email</td><td>${currentUser?.email || 'N/A'}</td></tr>
                        <tr><td>Phone</td><td>${currentUser?.phone || 'N/A'}</td></tr>
                        <tr><td>Assessment Year</td><td>2025-26</td></tr>
                        <tr><td>Financial Year</td><td>${financialYear}</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Income Details</h3>
                    <table class="table">
                        <tr><th>Income Source</th><th>Amount (â‚¹)</th></tr>
                        <tr><td>Salary Income</td><td>5,10,000</td></tr>
                        <tr><td>Business Income</td><td>2,12,500</td></tr>
                        <tr><td>Other Income</td><td>1,27,500</td></tr>
                        <tr class="total"><td>Total Income</td><td>8,50,000</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Deductions</h3>
                    <table class="table">
                        <tr><th>Deduction Type</th><th>Amount (â‚¹)</th></tr>
                        <tr><td>80C Deductions</td><td>1,20,000</td></tr>
                        <tr><td>80D Deductions</td><td>25,000</td></tr>
                        <tr><td>Other Deductions</td><td>5,000</td></tr>
                        <tr class="total"><td>Total Deductions</td><td>1,50,000</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Tax Calculation</h3>
                    <table class="table">
                        <tr><th>Particulars</th><th>Amount (â‚¹)</th></tr>
                        <tr><td>Total Income</td><td>8,50,000</td></tr>
                        <tr><td>Less: Deductions</td><td>1,50,000</td></tr>
                        <tr><td>Taxable Income</td><td>7,00,000</td></tr>
                        <tr><td>Tax Liability</td><td>42,000</td></tr>
                    </table>
                </div>
                
                <div class="footer">
                    <p>This return is generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                </div>
            `;
            
            generatePDF(`ITR_${financialYear}`, returnContent);
        }

        function showPaymentReceipt(method) {
            const receiptContainer = document.getElementById('paymentReceipt');
            const transactionId = `TXN${Date.now()}`;
            
            // Add payment success notification
            addNotification('success', 'Payment Successful', `Your payment of â‚¹15,000 has been processed successfully. Transaction ID: ${transactionId}`, 'high');
            
            receiptContainer.innerHTML = `
                <div class="receipt-success">
                    <i class="fas fa-check-circle"></i>
                    Payment Successful!
                </div>
                <div class="receipt-details">
                    <div><strong>Transaction ID:</strong> ${transactionId}</div>
                    <div><strong>Payment Method:</strong> ${method.toUpperCase()}</div>
                    <div><strong>Amount Paid:</strong> â‚¹${paymentAmount.toLocaleString()}</div>
                    <div><strong>Date:</strong> ${new Date().toLocaleString('en-IN')}</div>
                </div>
                <div class="receipt-actions">
                    <button class="btn btn-info" onclick="downloadReceipt('${transactionId}')">
                        <i class="fas fa-download"></i> Download Receipt
                    </button>
                    <button class="btn btn-secondary" onclick="goBackToReview()">
                        <i class="fas fa-arrow-left"></i> Back to Review
                    </button>
                </div>
            `;
            
            receiptContainer.classList.remove('hidden');
            document.getElementById('paymentOptions').classList.add('hidden');
            document.getElementById('paymentForm').classList.add('hidden');
        }

        function downloadReceipt(transactionId) {
            const receiptContent = `
                <div class="header">
                    <h1>INCOME TAX PAYMENT RECEIPT</h1>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="section">
                    <h3>Payment Details</h3>
                    <table class="table">
                        <tr><th>Particulars</th><th>Details</th></tr>
                        <tr><td>Transaction ID</td><td>${transactionId}</td></tr>
                        <tr><td>Payment Method</td><td>${selectedPaymentMethod.toUpperCase()}</td></tr>
                        <tr><td>Amount Paid</td><td>â‚¹${paymentAmount.toLocaleString()}</td></tr>
                        <tr><td>Date & Time</td><td>${new Date().toLocaleString('en-IN')}</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Important Notes</h3>
                    <p>This receipt serves as proof of payment for income tax.</p>
                    <p>Please keep this receipt for your records.</p>
                    <p>For any queries, contact: support@taxaid.gov</p>
                </div>
                
                <div class="footer">
                    <p>Generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                </div>
            `;
            
            generatePDF(`TaxReceipt_${transactionId}`, receiptContent);
        }

        function goBackToReview() {
            // Hide payment section
            document.getElementById('paymentCard').classList.add('hidden');
            
            // Show review section
            document.getElementById('reviewCard').classList.remove('hidden');
        }

        // Analytics Functions
        function showIncomeAnalytics() {
            const chartsContainer = document.getElementById('analyticsCharts');
            const summaryContainer = document.getElementById('analyticsSummary');
            
            chartsContainer.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">Income Sources Distribution</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; margin-right: 10px;"></i>
                        Pie Chart: Salary (60%), Business (25%), Other (15%)
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Income Trend</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line" style="font-size: 3rem; margin-right: 10px;"></i>
                        Line Chart: Income growth over 12 months
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Income vs Expenses</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-bar" style="font-size: 3rem; margin-right: 10px;"></i>
                        Bar Chart: Monthly comparison
                    </div>
                </div>
            `;
            
            summaryContainer.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">â‚¹8,50,000</div>
                    <div class="summary-label">Total Annual Income</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹5,10,000</div>
                    <div class="summary-label">Salary Income</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹2,12,500</div>
                    <div class="summary-label">Business Income</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹1,27,500</div>
                    <div class="summary-label">Other Income</div>
                </div>
            `;
        }

        function showTaxAnalytics() {
            const chartsContainer = document.getElementById('analyticsCharts');
            const summaryContainer = document.getElementById('analyticsSummary');
            
            chartsContainer.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">Tax Regime Comparison</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-balance-scale" style="font-size: 3rem; margin-right: 10px;"></i>
                        Bar Chart: Old vs New Regime Tax
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Tax Liability Trend</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-area" style="font-size: 3rem; margin-right: 10px;"></i>
                        Area Chart: Tax liability over years
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Tax Savings Analysis</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-piggy-bank" style="font-size: 3rem; margin-right: 10px;"></i>
                        Donut Chart: Savings breakdown
                    </div>
                </div>
            `;
            
            summaryContainer.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">â‚¹45,000</div>
                    <div class="summary-label">Total Tax Liability</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹12,000</div>
                    <div class="summary-label">Tax Saved (Deductions)</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">5.3%</div>
                    <div class="summary-label">Effective Tax Rate</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹33,000</div>
                    <div class="summary-label">Net Tax Payable</div>
                </div>
            `;
        }

        function showDeductionAnalytics() {
            const chartsContainer = document.getElementById('analyticsCharts');
            const summaryContainer = document.getElementById('analyticsSummary');
            
            chartsContainer.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">Deduction Categories</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; margin-right: 10px;"></i>
                        Pie Chart: 80C, 80D, HRA, etc.
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Deduction Utilization</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-bar" style="font-size: 3rem; margin-right: 10px;"></i>
                        Bar Chart: Used vs Available limits
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Savings Potential</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-lightbulb" style="font-size: 3rem; margin-right: 10px;"></i>
                        Gauge Chart: Additional savings possible
                    </div>
                </div>
            `;
            
            summaryContainer.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">â‚¹1,50,000</div>
                    <div class="summary-label">Total Deductions</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹1,20,000</div>
                    <div class="summary-label">80C Deductions</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹25,000</div>
                    <div class="summary-label">80D Deductions</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹5,000</div>
                    <div class="summary-label">Other Deductions</div>
                </div>
            `;
        }

        function showYearlyComparison() {
            const chartsContainer = document.getElementById('analyticsCharts');
            const summaryContainer = document.getElementById('analyticsSummary');
            
            chartsContainer.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">Year-over-Year Income</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line" style="font-size: 3rem; margin-right: 10px;"></i>
                        Line Chart: Income growth comparison
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Tax Liability Comparison</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-bar" style="font-size: 3rem; margin-right: 10px;"></i>
                        Bar Chart: Tax paid over 3 years
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Deduction Trends</div>
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-area" style="font-size: 3rem; margin-right: 10px;"></i>
                        Area Chart: Deduction patterns
                    </div>
                </div>
            `;
            
            summaryContainer.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">+15%</div>
                    <div class="summary-label">Income Growth</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">+8%</div>
                    <div class="summary-label">Tax Increase</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">+22%</div>
                    <div class="summary-label">Deduction Increase</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">â‚¹25,000</div>
                    <div class="summary-label">Additional Savings</div>
                </div>
            `;
        }

        function payTax() {
            // Get the tax liability from the current calculation
            const oldRegimeTaxElement = document.getElementById('oldRegimeTax');
            const newRegimeTaxElement = document.getElementById('newRegimeTax');
            
            let taxAmount = 0;
            if (oldRegimeTaxElement && newRegimeTaxElement) {
                const oldTax = parseInt(oldRegimeTaxElement.textContent.replace(/[â‚¹,]/g, ''));
                const newTax = parseInt(newRegimeTaxElement.textContent.replace(/[â‚¹,]/g, ''));
                taxAmount = Math.min(oldTax, newTax); // Use the lower tax amount
            }
            
            if (taxAmount > 0) {
                showPaymentGateway(taxAmount);
            } else {
                alert('No tax liability found. Please generate a tax return first.');
            }
        }

        // Reports Functions with PDF Generation
        function generateTaxReport() {
            const reportContent = generateTaxReportContent();
            generatePDF('Tax_Summary_Report', reportContent);
        }

        function generateIncomeReport() {
            const reportContent = generateIncomeReportContent();
            generatePDF('Income_Statement_Report', reportContent);
        }

        function generateDeductionReport() {
            const reportContent = generateDeductionReportContent();
            generatePDF('Deduction_Report', reportContent);
        }

        function generateRefundReport() {
            const reportContent = generateRefundReportContent();
            generatePDF('Refund_Application', reportContent);
        }

        function generateComplianceReport() {
            const reportContent = generateComplianceReportContent();
            generatePDF('Compliance_Report', reportContent);
        }

        function generateAllReports() {
            const reports = [
                { name: 'Tax_Summary_Report', content: generateTaxReportContent() },
                { name: 'Income_Statement_Report', content: generateIncomeReportContent() },
                { name: 'Deduction_Report', content: generateDeductionReportContent() },
                { name: 'Refund_Application', content: generateRefundReportContent() },
                { name: 'Compliance_Report', content: generateComplianceReportContent() }
            ];
            
            // Generate ZIP file with all reports
            generateZIP('All_Reports_Package', reports);
        }

        // PDF Generation Function
        function generatePDF(filename, content) {
            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${filename}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .section { margin-bottom: 20px; }
                        .section h3 { color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .table th { background-color: #f2f2f2; }
                        .total { font-weight: bold; background-color: #f9f9f9; }
                        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ZIP Generation Function
        function generateZIP(filename, reports) {
            // For demo purposes, we'll generate individual PDFs
            // In a real application, you would use a library like JSZip
            alert('Generating ZIP file with all reports...');
            reports.forEach((report, index) => {
                setTimeout(() => {
                    generatePDF(report.name, report.content);
                }, index * 1000);
            });
        }

        // Report Content Generators
        function generateTaxReportContent() {
            return `
                <div class="header">
                    <h1>INCOME TAX SUMMARY REPORT</h1>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                    <p>Assessment Year: 2025-26</p>
                </div>
                
                <div class="section">
                    <h3>Taxpayer Information</h3>
                    <p><strong>Name:</strong> ${currentUser?.name || 'N/A'}</p>
                    <p><strong>PAN:</strong> ${currentUser?.pan || 'N/A'}</p>
                    <p><strong>Email:</strong> ${currentUser?.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${currentUser?.phone || 'N/A'}</p>
                    <p><strong>Assessment Year:</strong> 2025-26</p>
                </div>
                
                <div class="section">
                    <h3>Income Summary</h3>
                    <table class="table">
                        <tr><th>Income Source</th><th>Amount (â‚¹)</th></tr>
                        <tr><td>Salary Income</td><td>5,10,000</td></tr>
                        <tr><td>Business Income</td><td>2,12,500</td></tr>
                        <tr><td>Other Income</td><td>1,27,500</td></tr>
                        <tr class="total"><td>Total Income</td><td>8,50,000</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Deductions</h3>
                    <table class="table">
                        <tr><th>Deduction Type</th><th>Amount (â‚¹)</th></tr>
                        <tr><td>80C Deductions</td><td>1,20,000</td></tr>
                        <tr><td>80D Deductions</td><td>25,000</td></tr>
                        <tr><td>Other Deductions</td><td>5,000</td></tr>
                        <tr class="total"><td>Total Deductions</td><td>1,50,000</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Tax Calculation</h3>
                    <table class="table">
                        <tr><th>Particulars</th><th>Amount (â‚¹)</th></tr>
                        <tr><td>Total Income</td><td>8,50,000</td></tr>
                        <tr><td>Less: Deductions</td><td>1,50,000</td></tr>
                        <tr><td>Taxable Income</td><td>7,00,000</td></tr>
                        <tr><td>Tax Liability (Old Regime)</td><td>45,000</td></tr>
                        <tr><td>Tax Liability (New Regime)</td><td>42,000</td></tr>
                        <tr class="total"><td>Recommended Tax</td><td>42,000</td></tr>
                    </table>
                </div>
                
                <div class="footer">
                    <p>This report is generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                    <p>For any queries, contact: support@taxaid.gov</p>
                </div>
            `;
        }

        function generateIncomeReportContent() {
            return `
                <div class="header">
                    <h1>INCOME STATEMENT REPORT</h1>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="section">
                    <h3>Income Sources Breakdown</h3>
                    <table class="table">
                        <tr><th>Source</th><th>Amount (â‚¹)</th><th>Percentage</th></tr>
                        <tr><td>Salary</td><td>5,10,000</td><td>60%</td></tr>
                        <tr><td>Business</td><td>2,12,500</td><td>25%</td></tr>
                        <tr><td>Other</td><td>1,27,500</td><td>15%</td></tr>
                        <tr class="total"><td>Total</td><td>8,50,000</td><td>100%</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Monthly Income Distribution</h3>
                    <table class="table">
                        <tr><th>Month</th><th>Salary (â‚¹)</th><th>Business (â‚¹)</th><th>Total (â‚¹)</th></tr>
                        <tr><td>April 2024</td><td>42,500</td><td>17,708</td><td>60,208</td></tr>
                        <tr><td>May 2024</td><td>42,500</td><td>17,708</td><td>60,208</td></tr>
                        <tr><td>June 2024</td><td>42,500</td><td>17,708</td><td>60,208</td></tr>
                        <tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr class="total"><td>Annual Total</td><td>5,10,000</td><td>2,12,500</td><td>8,50,000</td></tr>
                    </table>
                </div>
                
                <div class="footer">
                    <p>This report is generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                </div>
            `;
        }

        function generateDeductionReportContent() {
            return `
                <div class="header">
                    <h1>DEDUCTION ANALYSIS REPORT</h1>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="section">
                    <h3>Deduction Summary</h3>
                    <table class="table">
                        <tr><th>Section</th><th>Description</th><th>Claimed (â‚¹)</th><th>Limit (â‚¹)</th><th>Utilization</th></tr>
                        <tr><td>80C</td><td>Life Insurance, PPF, ELSS</td><td>1,20,000</td><td>1,50,000</td><td>80%</td></tr>
                        <tr><td>80D</td><td>Health Insurance</td><td>25,000</td><td>25,000</td><td>100%</td></tr>
                        <tr><td>80G</td><td>Donations</td><td>5,000</td><td>50,000</td><td>10%</td></tr>
                        <tr class="total"><td>Total</td><td></td><td>1,50,000</td><td>2,25,000</td><td>67%</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Savings Recommendations</h3>
                    <ul>
                        <li>Increase 80C investments by â‚¹30,000 to maximize tax savings</li>
                        <li>Consider additional health insurance for family members</li>
                        <li>Explore 80G donation opportunities for additional savings</li>
                    </ul>
                </div>
                
                <div class="footer">
                    <p>This report is generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                </div>
            `;
        }

        function generateRefundReportContent() {
            return `
                <div class="header">
                    <h1>TAX REFUND APPLICATION</h1>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="section">
                    <h3>Refund Details</h3>
                    <table class="table">
                        <tr><th>Particulars</th><th>Amount (â‚¹)</th></tr>
                        <tr><td>Tax Paid (TDS + Advance Tax)</td><td>50,000</td></tr>
                        <tr><td>Tax Liability</td><td>42,000</td></tr>
                        <tr class="total"><td>Refund Amount</td><td>8,000</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Bank Details for Refund</h3>
                    <p><strong>Account Holder:</strong> ${currentUser?.account_holder_name || currentUser?.name || 'N/A'}</p>
                    <p><strong>Account Number:</strong> ${currentUser?.account_number || 'N/A'}</p>
                    <p><strong>IFSC Code:</strong> ${currentUser?.ifsc_code || 'N/A'}</p>
                    <p><strong>Bank Name:</strong> ${currentUser?.bank_name || 'N/A'}</p>
                </div>
                
                <div class="section">
                    <h3>Declaration</h3>
                    <p>I hereby declare that the information provided is true and correct to the best of my knowledge.</p>
                    <p><strong>Signature:</strong> _________________</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="footer">
                    <p>This application is generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                </div>
            `;
        }

        function generateComplianceReportContent() {
            return `
                <div class="header">
                    <h1>TAX COMPLIANCE REPORT</h1>
                    <p>Generated on: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
                
                <div class="section">
                    <h3>Filing Status</h3>
                    <table class="table">
                        <tr><th>Assessment Year</th><th>Status</th><th>Filing Date</th><th>Due Date</th></tr>
                        <tr><td>2025-26</td><td>Filed</td><td>15/07/2025</td><td>31/07/2025</td></tr>
                        <tr><td>2024-25</td><td>Filed</td><td>20/07/2024</td><td>31/07/2024</td></tr>
                        <tr><td>2023-24</td><td>Filed</td><td>25/07/2023</td><td>31/07/2023</td></tr>
                    </table>
                </div>
                
                <div class="section">
                    <h3>Compliance Score</h3>
                    <p><strong>Overall Score:</strong> 95/100</p>
                    <ul>
                        <li>âœ… Timely Filing: 100%</li>
                        <li>âœ… Accurate Calculations: 95%</li>
                        <li>âœ… Complete Documentation: 90%</li>
                        <li>âœ… Payment Compliance: 100%</li>
                    </ul>
                </div>
                
                <div class="footer">
                    <p>This report is generated by Taxaid.gov - Your Trusted Tax Filing Partner</p>
                </div>
            `;
        }

        // Refund Processing Functions
        function checkRefundEligibility() {
            const eligibilityContainer = document.getElementById('refundEligibility');
            const taxPaid = 50000; // Simulated TDS + Advance Tax
            const taxLiability = 42000; // Simulated tax liability
            const refundAmount = taxPaid - taxLiability;
            
            if (refundAmount > 0) {
                eligibilityContainer.innerHTML = `
                    <h3><i class="fas fa-check-circle" style="color: #38a169;"></i> Refund Eligible!</h3>
                    <div class="refund-amount">â‚¹${refundAmount.toLocaleString()}</div>
                    <div class="refund-details">
                        <div class="refund-detail">
                            <div class="refund-detail-label">Tax Paid</div>
                            <div class="refund-detail-value">â‚¹${taxPaid.toLocaleString()}</div>
                        </div>
                        <div class="refund-detail">
                            <div class="refund-detail-label">Tax Liability</div>
                            <div class="refund-detail-value">â‚¹${taxLiability.toLocaleString()}</div>
                        </div>
                        <div class="refund-detail">
                            <div class="refund-detail-label">Refund Amount</div>
                            <div class="refund-detail-value">â‚¹${refundAmount.toLocaleString()}</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="applyForRefund()">
                        <i class="fas fa-undo"></i> Apply for Refund
                    </button>
                `;
            } else {
                eligibilityContainer.innerHTML = `
                    <h3><i class="fas fa-times-circle" style="color: #e53e3e;"></i> No Refund Eligible</h3>
                    <p>Your tax liability is equal to or greater than the tax paid. No refund is available.</p>
                `;
            }
        }

        function applyForRefund() {
            document.getElementById('refundForm').classList.remove('hidden');
            document.getElementById('refundForm').innerHTML = `
                <h3>Refund Application Form</h3>
                <div class="form-group">
                    <label>Bank Account Number:</label>
                    <input type="text" id="refundAccountNumber" class="form-control" placeholder="Enter your bank account number" value="${currentUser?.account_number || ''}" required>
                </div>
                <div class="form-group">
                    <label>IFSC Code:</label>
                    <input type="text" id="refundIFSC" class="form-control" placeholder="Enter IFSC code" value="${currentUser?.ifsc_code || ''}" required>
                </div>
                <div class="form-group">
                    <label>Bank Name:</label>
                    <input type="text" id="refundBankName" class="form-control" placeholder="Enter bank name" value="${currentUser?.bank_name || ''}" required>
                </div>
                <div class="form-group">
                    <label>Account Holder Name:</label>
                    <input type="text" id="refundAccountHolder" class="form-control" placeholder="Enter account holder name" value="${currentUser?.account_holder_name || currentUser?.name || ''}" required>
                </div>
                <button class="btn btn-success" onclick="submitRefundApplication()">
                    <i class="fas fa-paper-plane"></i> Submit Refund Application
                </button>
            `;
        }

        function submitRefundApplication() {
            alert('Refund application submitted successfully! You will receive the refund within 7-10 business days.');
            addNotification('success', 'Refund Application Submitted', 'Your refund application has been submitted successfully. You will receive the refund within 7-10 business days.', 'high');
            document.getElementById('refundStatus').classList.remove('hidden');
            document.getElementById('refundStatus').innerHTML = `
                <h3><i class="fas fa-clock" style="color: #f6ad55;"></i> Refund Application Submitted</h3>
                <p><strong>Application ID:</strong> REF${Date.now()}</p>
                <p><strong>Status:</strong> Under Review</p>
                <p><strong>Expected Processing Time:</strong> 7-10 business days</p>
                <p><strong>Refund Amount:</strong> â‚¹8,000</p>
                <button class="btn btn-info" onclick="generateRefundReport()">
                    <i class="fas fa-download"></i> Download Refund Application
                </button>
            `;
        }

        // Validation Functions
        function validatePAN(pan) {
            const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
            return panRegex.test(pan);
        }

        function validateAadhaar(aadhaar) {
            // Remove spaces and check if it's 12 digits
            const cleanAadhaar = aadhaar.replace(/\s/g, '');
            if (!/^\d{12}$/.test(cleanAadhaar)) return false;
            
            // Verhoeff algorithm for Aadhaar validation
            return verhoeffCheck(cleanAadhaar);
        }

        function verhoeffCheck(aadhaar) {
            const d = [
                [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
                [1, 2, 3, 4, 0, 6, 7, 8, 9, 5],
                [2, 3, 4, 0, 1, 7, 8, 9, 5, 6],
                [3, 4, 0, 1, 2, 8, 9, 5, 6, 7],
                [4, 0, 1, 2, 3, 9, 5, 6, 7, 8],
                [5, 9, 8, 7, 6, 0, 4, 3, 2, 1],
                [6, 5, 9, 8, 7, 1, 0, 4, 3, 2],
                [7, 6, 5, 9, 8, 2, 1, 0, 4, 3],
                [8, 7, 6, 5, 9, 3, 2, 1, 0, 4],
                [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]
            ];
            
            const p = [
                [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
                [1, 5, 7, 6, 2, 8, 3, 0, 9, 4],
                [5, 8, 0, 3, 7, 9, 6, 1, 4, 2],
                [8, 9, 1, 6, 0, 4, 3, 5, 2, 7],
                [9, 4, 5, 3, 1, 2, 6, 8, 7, 0],
                [4, 2, 8, 6, 5, 7, 3, 9, 0, 1],
                [2, 7, 9, 3, 8, 0, 6, 4, 1, 5],
                [7, 0, 4, 6, 9, 1, 3, 2, 5, 8]
            ];
            
            let c = 0;
            const inverted = aadhaar.split('').reverse();
            
            for (let i = 0; i < inverted.length; i++) {
                c = d[c][p[((i + 1) % 8)][parseInt(inverted[i])]];
            }
            
            return c === 0;
        }

        function validateIFSC(ifsc) {
            const ifscRegex = /^[A-Z]{4}0[A-Z0-9]{6}$/;
            return ifscRegex.test(ifsc);
        }

        function validateAccountNumber(accountNumber) {
            // Account number should be 9-18 digits
            const cleanAccount = accountNumber.replace(/\s/g, '');
            return /^\d{9,18}$/.test(cleanAccount);
        }

        function validatePhone(phone) {
            const cleanPhone = phone.replace(/\s/g, '');
            return /^[6-9]\d{9}$/.test(cleanPhone);
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePincode(pincode) {
            return /^\d{6}$/.test(pincode);
        }

        function validateAmount(amount, min = 0, max = 999999999) {
            const numAmount = parseFloat(amount);
            return !isNaN(numAmount) && numAmount >= min && numAmount <= max;
        }

        function showValidationError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.style.borderColor = '#e53e3e';
                field.style.backgroundColor = '#fed7d7';
                
                // Remove existing error message
                const existingError = field.parentNode.querySelector('.validation-error');
                if (existingError) {
                    existingError.remove();
                }
                
                // Add new error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'validation-error';
                errorDiv.style.color = '#e53e3e';
                errorDiv.style.fontSize = '0.8rem';
                errorDiv.style.marginTop = '5px';
                errorDiv.textContent = message;
                field.parentNode.appendChild(errorDiv);
            }
        }

        function clearValidationError(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.style.borderColor = '';
                field.style.backgroundColor = '';
                
                const existingError = field.parentNode.querySelector('.validation-error');
                if (existingError) {
                    existingError.remove();
                }
            }
        }

        function validateIncomeAmount() {
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            if (amount && !validateAmount(amount, 0, 999999999)) {
                showValidationError('incomeAmount', 'Invalid amount. Maximum: â‚¹99,99,99,999');
            } else {
                clearValidationError('incomeAmount');
            }
        }

        function validateDeductionAmount() {
            const amount = parseFloat(document.getElementById('deductionAmount').value);
            const section = document.getElementById('deductionSection').value;
            
            if (amount) {
                let maxLimit = 150000; // Default 80C limit
                
                // Set specific limits based on section
                const limits = {
                    '80C': 150000,
                    '80D': 25000,
                    '80E': 200000,
                    '80G': 50000,
                    '80TTA': 10000,
                    '80TTB': 50000,
                    'HRA': 1000000,
                    'LTA': 100000,
                    'Medical': 15000,
                    'Standard Deduction': 50000
                };
                
                if (limits[section]) {
                    maxLimit = limits[section];
                }
                
                if (!validateAmount(amount, 0, maxLimit)) {
                    showValidationError('deductionAmount', `Invalid amount. Maximum for ${section}: â‚¹${maxLimit.toLocaleString()}`);
                } else {
                    clearValidationError('deductionAmount');
                }
            } else {
                clearValidationError('deductionAmount');
            }
        }

        function formatIFSC(input) {
            input.value = input.value.toUpperCase();
        }

        function addValidationListeners() {
            // PAN validation
            const panFields = ['signupPAN', 'profilePAN'];
            panFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const value = this.value.toUpperCase();
                        this.value = value;
                        if (value && !validatePAN(value)) {
                            showValidationError(fieldId, 'Invalid PAN format. Use format: ABCDE1234F');
                        } else {
                            clearValidationError(fieldId);
                        }
                    });
                }
            });

            // Aadhaar validation
            const aadhaarFields = ['signupAadhaar', 'profileAadhaar'];
            aadhaarFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const value = this.value.replace(/\s/g, '');
                        if (value && !validateAadhaar(value)) {
                            showValidationError(fieldId, 'Invalid Aadhaar number');
                        } else {
                            clearValidationError(fieldId);
                        }
                    });
                }
            });

            // Phone validation
            const phoneFields = ['signupPhone', 'profilePhone'];
            phoneFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const value = this.value;
                        if (value && !validatePhone(value)) {
                            showValidationError(fieldId, 'Invalid phone number. Use 10-digit mobile number starting with 6-9');
                        } else {
                            clearValidationError(fieldId);
                        }
                    });
                }
            });

            // Email validation
            const emailFields = ['signupEmail', 'profileEmail'];
            emailFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const value = this.value;
                        if (value && !validateEmail(value)) {
                            showValidationError(fieldId, 'Invalid email format');
                        } else {
                            clearValidationError(fieldId);
                        }
                    });
                }
            });

            // PIN code validation
            const pincodeFields = ['signupPinCode', 'profilePinCode'];
            pincodeFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const value = this.value;
                        if (value && !validatePincode(value)) {
                            showValidationError(fieldId, 'Invalid PIN code. Use 6-digit PIN code');
                        } else {
                            clearValidationError(fieldId);
                        }
                    });
                }
            });

            // Bank details validation
            const bankFields = [
                { id: 'signupIFSC', validation: validateIFSC, message: 'Invalid IFSC code format' },
                { id: 'profileIFSC', validation: validateIFSC, message: 'Invalid IFSC code format' },
                { id: 'signupAccountNumber', validation: validateAccountNumber, message: 'Invalid account number (9-18 digits)' },
                { id: 'profileAccountNumber', validation: validateAccountNumber, message: 'Invalid account number (9-18 digits)' }
            ];

            bankFields.forEach(field => {
                const fieldElement = document.getElementById(field.id);
                if (fieldElement) {
                    fieldElement.addEventListener('blur', function() {
                        const value = this.value;
                        if (value && !field.validation(value)) {
                            showValidationError(field.id, field.message);
                        } else {
                            clearValidationError(field.id);
                        }
                    });
                }
            });
        }

        // Notification System Variables
        let notifications = [];
        let previousCard = 'reviewCard'; // Track which card was active before notification center
        let notificationSettings = {
            email: true,
            browser: true,
            sms: false,
            deadlineReminders: true,
            paymentAlerts: true,
            refundUpdates: true,
            deadlineReminderDays: 3,
            quietStart: '22:00',
            quietEnd: '08:00'
        };

        // Notification System Functions
        function showNotificationCenter() {
            // Remember which card was active before opening notification center
            const cards = ['fileReturnCard', 'incomeCard', 'deductionsCard', 'reviewCard', 'paymentCard', 'analyticsCard', 'reportsCard', 'refundCard', 'taxCalendarCard', 'supportCenterCard', 'helpDeskCard', 'faqCard', 'adminPanelCard'];
            for (let cardId of cards) {
                const card = document.getElementById(cardId);
                if (card && !card.classList.contains('hidden')) {
                    previousCard = cardId;
                    break;
                }
            }
            
            hideAllCards();
            document.getElementById('notificationCenterCard').classList.remove('hidden');
            loadNotifications();
            // Ensure the first tab is active
            showNotificationTab('all');
        }

        function hideNotificationCenter() {
            document.getElementById('notificationCenterCard').classList.add('hidden');
            // Return to the previous card
            hideAllCards();
            const previousCardElement = document.getElementById(previousCard);
            if (previousCardElement) {
                previousCardElement.classList.remove('hidden');
            } else {
                // Fallback to review card if previous card is not found
                document.getElementById('reviewCard').classList.remove('hidden');
            }
        }

        function showNotificationTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.notification-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.notification-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            let tabContent;
            if (tabName === 'settings') {
                tabContent = document.getElementById('notificationSettings');
            } else {
                tabContent = document.getElementById(tabName + 'Notifications');
            }
            if (tabContent) {
                tabContent.classList.add('active');
            } else {
                console.error('Tab content not found for:', tabName);
            }
            
            // Add active class to clicked tab (if event exists)
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event, find the tab button by onclick attribute
                const tabButton = document.querySelector(`[onclick="showNotificationTab('${tabName}')"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            
            // Load appropriate notifications
            switch(tabName) {
                case 'all':
                    loadAllNotifications();
                    break;
                case 'unread':
                    loadUnreadNotifications();
                    break;
                case 'deadlines':
                    loadDeadlineNotifications();
                    break;
                case 'alerts':
                    loadAlertNotifications();
                    break;
                case 'settings':
                    loadNotificationSettings();
                    break;
            }
        }

        function loadNotifications() {
            console.log('loadNotifications called');
            // Load sample notifications
            notifications = [
                {
                    id: 1,
                    type: 'deadline',
                    title: 'Tax Filing Deadline Approaching',
                    message: 'Your tax return for FY 2024-25 is due in 3 days. Complete your filing to avoid penalties.',
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                    read: false,
                    priority: 'high'
                },
                {
                    id: 2,
                    type: 'success',
                    title: 'Payment Successful',
                    message: 'Your tax payment of â‚¹15,000 has been processed successfully. Receipt #TX2024001',
                    timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), // 1 day ago
                    read: true,
                    priority: 'medium'
                },
                {
                    id: 3,
                    type: 'info',
                    title: 'Refund Status Update',
                    message: 'Your refund application has been approved. Amount â‚¹8,500 will be credited within 5-7 business days.',
                    timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), // 3 days ago
                    read: true,
                    priority: 'medium'
                },
                {
                    id: 4,
                    type: 'warning',
                    title: 'Document Verification Required',
                    message: 'Please upload your Form 16 to complete the verification process for your tax return.',
                    timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
                    read: false,
                    priority: 'high'
                },
                {
                    id: 5,
                    type: 'info',
                    title: 'System Maintenance Notice',
                    message: 'Scheduled maintenance will occur on Sunday, 2:00 AM - 4:00 AM. Some features may be temporarily unavailable.',
                    timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago
                    read: true,
                    priority: 'low'
                },
                {
                    id: 6,
                    type: 'success',
                    title: 'Profile Updated',
                    message: 'Your profile information has been successfully updated.',
                    timestamp: new Date(Date.now() - 30 * 60 * 1000), // 30 minutes ago
                    read: false,
                    priority: 'low'
                },
                {
                    id: 7,
                    type: 'info',
                    title: 'New Feature Available',
                    message: 'Check out the new Analytics dashboard to track your tax trends and insights.',
                    timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2 days ago
                    read: true,
                    priority: 'low'
                },
                {
                    id: 8,
                    type: 'warning',
                    title: 'Security Alert',
                    message: 'A new device has logged into your account. If this wasn\'t you, please change your password immediately.',
                    timestamp: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000), // 4 days ago
                    read: false,
                    priority: 'high'
                }
            ];
            
            updateNotificationBadge();
            loadAllNotifications();
        }

        function loadAllNotifications() {
            console.log('loadAllNotifications called, notifications count:', notifications.length);
            const container = document.getElementById('notificationsList');
            if (!container) {
                console.error('notificationsList container not found');
                return;
            }
            container.innerHTML = notifications.map(notification => createNotificationHTML(notification)).join('');
        }

        function loadUnreadNotifications() {
            const container = document.getElementById('unreadList');
            const unreadNotifications = notifications.filter(n => !n.read);
            container.innerHTML = unreadNotifications.map(notification => createNotificationHTML(notification)).join('');
        }

        function loadDeadlineNotifications() {
            console.log('loadDeadlineNotifications called');
            const container = document.getElementById('deadlineList');
            if (!container) {
                console.error('deadlineList container not found');
                return;
            }
            console.log('deadlineList container found:', container);
            
            const deadlineNotifications = notifications.filter(n => n.type === 'deadline');
            
            // Add upcoming tax deadlines
            const upcomingDeadlines = [
                {
                    id: 'deadline_1',
                    type: 'deadline',
                    title: 'Income Tax Return Filing',
                    message: 'Last date for filing ITR for FY 2024-25 is July 31, 2025',
                    timestamp: new Date('2025-07-31'),
                    read: false,
                    priority: 'high',
                    daysLeft: Math.ceil((new Date('2025-07-31') - new Date()) / (1000 * 60 * 60 * 24))
                },
                {
                    id: 'deadline_2',
                    type: 'deadline',
                    title: 'Advance Tax Payment - Q4',
                    message: 'Q4 Advance Tax payment due date: March 15, 2025',
                    timestamp: new Date('2025-03-15'),
                    read: false,
                    priority: 'high',
                    daysLeft: Math.ceil((new Date('2025-03-15') - new Date()) / (1000 * 60 * 60 * 24))
                },
                {
                    id: 'deadline_3',
                    type: 'deadline',
                    title: 'TDS Return Filing - Q3',
                    message: 'TDS return filing for Q3 due: January 31, 2025',
                    timestamp: new Date('2025-01-31'),
                    read: true,
                    priority: 'medium',
                    daysLeft: Math.ceil((new Date('2025-01-31') - new Date()) / (1000 * 60 * 60 * 24))
                },
                {
                    id: 'deadline_4',
                    type: 'deadline',
                    title: 'Advance Tax Payment - Q3',
                    message: 'Q3 Advance Tax payment due date: December 15, 2024',
                    timestamp: new Date('2024-12-15'),
                    read: false,
                    priority: 'urgent',
                    daysLeft: Math.ceil((new Date('2024-12-15') - new Date()) / (1000 * 60 * 60 * 24))
                },
                {
                    id: 'deadline_5',
                    type: 'deadline',
                    title: 'TDS Return Filing - Q2',
                    message: 'TDS return filing for Q2 due: October 31, 2024',
                    timestamp: new Date('2024-10-31'),
                    read: false,
                    priority: 'warning',
                    daysLeft: Math.ceil((new Date('2024-10-31') - new Date()) / (1000 * 60 * 60 * 24))
                }
            ];
            
            const allDeadlines = [...deadlineNotifications, ...upcomingDeadlines];
            
            console.log('Loading deadlines:', allDeadlines.length, 'deadlines found');
            
            if (allDeadlines.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-calendar-check" style="font-size: 48px; margin-bottom: 15px; color: var(--primary-color);"></i>
                        <h3>No Upcoming Deadlines</h3>
                        <p>You're all caught up! No tax deadlines are approaching.</p>
                    </div>
                `;
            } else {
                container.innerHTML = allDeadlines.map(notification => createDeadlineHTML(notification)).join('');
            }
        }

        function loadAlertNotifications() {
            console.log('loadAlertNotifications called');
            const container = document.getElementById('alertList');
            if (!container) {
                console.error('alertList container not found');
                return;
            }
            console.log('alertList container found:', container);
            
            const alertNotifications = notifications.filter(n => n.type === 'warning' || n.type === 'error');
            
            // Add additional sample alerts
            const additionalAlerts = [
                {
                    id: 'alert_1',
                    type: 'warning',
                    title: 'Password Expiry Warning',
                    message: 'Your password will expire in 7 days. Please update it to maintain account security.',
                    timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000), // 1 hour ago
                    read: false,
                    priority: 'high'
                },
                {
                    id: 'alert_2',
                    type: 'error',
                    title: 'Payment Failed',
                    message: 'Your last tax payment of â‚¹25,000 failed due to insufficient funds. Please update your payment method.',
                    timestamp: new Date(Date.now() - 3 * 60 * 60 * 1000), // 3 hours ago
                    read: false,
                    priority: 'high'
                },
                {
                    id: 'alert_3',
                    type: 'warning',
                    title: 'Suspicious Login Activity',
                    message: 'Unusual login activity detected from a new location. Please verify if this was you.',
                    timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
                    read: true,
                    priority: 'high'
                },
                {
                    id: 'alert_4',
                    type: 'warning',
                    title: 'Document Upload Failed',
                    message: 'Failed to upload Form 16. Please check file format and try again.',
                    timestamp: new Date(Date.now() - 12 * 60 * 60 * 1000), // 12 hours ago
                    read: false,
                    priority: 'medium'
                }
            ];
            
            const allAlerts = [...alertNotifications, ...additionalAlerts];
            
            console.log('Loading alerts:', allAlerts.length, 'alerts found');
            
            if (allAlerts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-shield-alt" style="font-size: 48px; margin-bottom: 15px; color: var(--success-color);"></i>
                        <h3>No Active Alerts</h3>
                        <p>Great! You have no security or system alerts at this time.</p>
                        <button class="btn btn-primary" onclick="checkSystemAlerts()" style="margin-top: 15px;">
                            <i class="fas fa-sync"></i> Check for New Alerts
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="notification-actions">
                        <button class="btn btn-primary" onclick="checkSystemAlerts()">
                            <i class="fas fa-sync"></i> Check for New Alerts
                        </button>
                        <button class="btn btn-warning" onclick="markAllAlertsAsRead()">
                            <i class="fas fa-check-double"></i> Mark All Alerts as Read
                        </button>
                    </div>
                ` + allAlerts.map(notification => createNotificationHTML(notification)).join('');
            }
        }

        function createNotificationHTML(notification) {
            console.log('createNotificationHTML called with:', notification);
            const timeAgo = getTimeAgo(notification.timestamp);
            const iconClass = getNotificationIconClass(notification.type);
            
            return `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" onclick="markAsRead(${notification.id})">
                    <div class="notification-icon ${iconClass}">
                        <i class="fas ${getNotificationIcon(notification.type)}"></i>
                    </div>
                    <div class="notification-content-item">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-meta">
                            <span class="notification-time">${timeAgo}</span>
                            <div class="notification-actions-item">
                                <button class="notification-action-btn" onclick="event.stopPropagation(); deleteNotification(${notification.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getNotificationIcon(type) {
            const icons = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'warning': 'fa-exclamation-triangle',
                'error': 'fa-times-circle',
                'deadline': 'fa-calendar-alt'
            };
            return icons[type] || 'fa-bell';
        }

        function getNotificationIconClass(type) {
            return type;
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) {
                return `${minutes} minutes ago`;
            } else if (hours < 24) {
                return `${hours} hours ago`;
            } else {
                return `${days} days ago`;
            }
        }

        function markAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                // Refresh the current active tab
                const activeTab = document.querySelector('.notification-tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick').match(/showNotificationTab\('([^']+)'\)/)[1];
                    showNotificationTab(tabName);
                } else {
                    loadAllNotifications();
                }
            }
        }

        function markAllAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            updateNotificationBadge();
            loadAllNotifications();
        }

        function deleteNotification(notificationId) {
            notifications = notifications.filter(n => n.id !== notificationId);
            updateNotificationBadge();
            loadAllNotifications();
        }

        function clearAllNotifications() {
            if (confirm('Are you sure you want to clear all notifications?')) {
                notifications = [];
                updateNotificationBadge();
                loadAllNotifications();
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function loadNotificationSettings() {
            // Load settings from localStorage or use defaults
            const savedSettings = localStorage.getItem('notificationSettings');
            if (savedSettings) {
                notificationSettings = { ...notificationSettings, ...JSON.parse(savedSettings) };
            }
            
            // Update UI elements
            document.getElementById('emailNotifications').checked = notificationSettings.email;
            document.getElementById('browserNotifications').checked = notificationSettings.browser;
            document.getElementById('smsNotifications').checked = notificationSettings.sms;
            document.getElementById('deadlineReminders').checked = notificationSettings.deadlineReminders;
            document.getElementById('paymentAlerts').checked = notificationSettings.paymentAlerts;
            document.getElementById('refundUpdates').checked = notificationSettings.refundUpdates;
            document.getElementById('deadlineReminderDays').value = notificationSettings.deadlineReminderDays;
            document.getElementById('quietStart').value = notificationSettings.quietStart;
            document.getElementById('quietEnd').value = notificationSettings.quietEnd;
        }

        function saveNotificationSettings() {
            // Get settings from UI
            notificationSettings = {
                email: document.getElementById('emailNotifications').checked,
                browser: document.getElementById('browserNotifications').checked,
                sms: document.getElementById('smsNotifications').checked,
                deadlineReminders: document.getElementById('deadlineReminders').checked,
                paymentAlerts: document.getElementById('paymentAlerts').checked,
                refundUpdates: document.getElementById('refundUpdates').checked,
                deadlineReminderDays: parseInt(document.getElementById('deadlineReminderDays').value),
                quietStart: document.getElementById('quietStart').value,
                quietEnd: document.getElementById('quietEnd').value,
                frequency: document.getElementById('notificationFrequency').value,
                emailAddress: document.getElementById('notificationEmail').value,
                phoneNumber: document.getElementById('notificationPhone').value,
                dataSharing: document.getElementById('dataSharing').checked,
                marketingEmails: document.getElementById('marketingEmails').checked
            };
            
            // Save to localStorage
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            
            // Show success message
            showToast('Settings saved successfully!', 'success');
        }
        
        function resetNotificationSettings() {
            if (confirm('Are you sure you want to reset all notification settings to default values?')) {
                // Reset to default values
                notificationSettings = {
                    email: true,
                    browser: true,
                    sms: false,
                    deadlineReminders: true,
                    paymentAlerts: true,
                    refundUpdates: true,
                    deadlineReminderDays: 3,
                    quietStart: '22:00',
                    quietEnd: '08:00',
                    frequency: 'hourly',
                    emailAddress: 'user@example.com',
                    phoneNumber: '+91 98765 43210',
                    dataSharing: true,
                    marketingEmails: false
                };
                
                // Update UI elements
                document.getElementById('emailNotifications').checked = true;
                document.getElementById('browserNotifications').checked = true;
                document.getElementById('smsNotifications').checked = false;
                document.getElementById('deadlineReminders').checked = true;
                document.getElementById('paymentAlerts').checked = true;
                document.getElementById('refundUpdates').checked = true;
                document.getElementById('deadlineReminderDays').value = '3';
                document.getElementById('quietStart').value = '22:00';
                document.getElementById('quietEnd').value = '08:00';
                document.getElementById('notificationFrequency').value = 'hourly';
                document.getElementById('notificationEmail').value = 'user@example.com';
                document.getElementById('notificationPhone').value = '+91 98765 43210';
                document.getElementById('dataSharing').checked = true;
                document.getElementById('marketingEmails').checked = false;
                
                // Save to localStorage
                localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
                showToast('Notification settings reset to default values!', 'info');
            }
        }

        function testNotification() {
            showToast('This is a test notification!', 'info');
            
            if (notificationSettings.browser && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification('Taxaid.gov Test', {
                        body: 'This is a test browser notification',
                        icon: '/favicon.ico'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('Taxaid.gov Test', {
                                body: 'This is a test browser notification',
                                icon: '/favicon.ico'
                            });
                        }
                    });
                }
            }
        }

        // Toast Notification System
        function showToast(message, type = 'info', title = 'Notification') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${getNotificationIcon(type)}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                closeToast(toast.querySelector('.toast-close'));
            }, 5000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            document.body.appendChild(container);
            return container;
        }

        function closeToast(closeButton) {
            const toast = closeButton.closest('.toast');
            toast.classList.add('slide-out');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        // Browser Notification Permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Browser notifications enabled!', 'success');
                    }
                });
            }
        }

        // Initialize notification system
        function initializeNotificationSystem() {
            requestNotificationPermission();
            loadNotificationSettings();
            
            // Load initial notifications
            loadNotifications();
            
            // Check for deadline reminders
            checkDeadlineReminders();
            
            // Set up periodic checks
            setInterval(checkDeadlineReminders, 24 * 60 * 60 * 1000); // Check daily
        }

        function checkDeadlineReminders() {
            if (!notificationSettings.deadlineReminders) return;
            
            const today = new Date();
            const reminderDays = notificationSettings.deadlineReminderDays;
            const reminderDate = new Date(today.getTime() + (reminderDays * 24 * 60 * 60 * 1000));
            
            // Check if it's time for deadline reminders
            // This would typically check against actual tax deadlines
            // For demo purposes, we'll simulate this
        }

        // Test function for debugging
        function testNotificationSystem() {
            console.log('Testing notification system...');
            console.log('Notifications array:', notifications);
            console.log('Deadline container:', document.getElementById('deadlineList'));
            console.log('Alert container:', document.getElementById('alertList'));
            
            // Test loading deadlines
            loadDeadlineNotifications();
            
            // Test loading alerts
            loadAlertNotifications();
            
            console.log('Test completed. Check the console for any errors.');
        }

        // Add notification to the system
        function addNotification(type, title, message, priority = 'medium') {
            const notification = {
                id: Date.now(),
                type: type,
                title: title,
                message: message,
                timestamp: new Date(),
                read: false,
                priority: priority
            };
            
            notifications.unshift(notification);
            updateNotificationBadge();
            
            // Show toast notification
            showToast(message, type, title);
            
            // Show browser notification if enabled
            if (notificationSettings.browser && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico'
                });
            }
        }

        // Enhanced notification functions for new features
        function createDeadlineHTML(deadline) {
            console.log('createDeadlineHTML called with:', deadline);
            const timeAgo = getTimeAgo(deadline.timestamp);
            const daysLeft = deadline.daysLeft;
            const urgencyClass = daysLeft <= 7 ? 'urgent' : daysLeft <= 30 ? 'warning' : 'normal';
            
            return `
                <div class="notification-item deadline-item ${!deadline.read ? 'unread' : ''} ${urgencyClass}" onclick="markAsRead('${deadline.id}')">
                    <div class="notification-icon deadline">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="notification-content-item">
                        <div class="notification-title">${deadline.title}</div>
                        <div class="notification-message">${deadline.message}</div>
                        <div class="notification-meta">
                            <span class="notification-time">
                                ${daysLeft > 0 ? `${daysLeft} days left` : daysLeft === 0 ? 'Due today' : `${Math.abs(daysLeft)} days overdue`}
                            </span>
                            <div class="notification-actions-item">
                                <button class="notification-action-btn" onclick="event.stopPropagation(); setReminder('${deadline.id}')">
                                    <i class="fas fa-bell"></i> Remind
                                </button>
                                <button class="notification-action-btn" onclick="event.stopPropagation(); deleteNotification('${deadline.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function checkSystemAlerts() {
            showToast('Checking for new system alerts...', 'info');
            
            setTimeout(() => {
                // Simulate checking for alerts
                const newAlerts = Math.random() > 0.7; // 30% chance of new alerts
                
                if (newAlerts) {
                    addNotification('warning', 'System Alert', 'A new security update is available for your account.', 'high');
                    showToast('New system alert found!', 'warning');
                } else {
                    showToast('No new alerts found. Your system is secure.', 'success');
                }
            }, 1500);
        }

        function markAllAlertsAsRead() {
            notifications.forEach(notification => {
                if (notification.type === 'warning' || notification.type === 'error') {
                    notification.read = true;
                }
            });
            updateNotificationBadge();
            loadAlertNotifications();
            showToast('All alerts marked as read', 'success');
        }

        function checkUpcomingDeadlines() {
            showToast('Checking for upcoming tax deadlines...', 'info');
            
            setTimeout(() => {
                loadDeadlineNotifications();
                showToast('Deadline information updated!', 'success');
            }, 1000);
        }

        function setDeadlineReminder() {
            const days = prompt('Set reminder for how many days before deadline?', '3');
            if (days && !isNaN(days)) {
                showToast(`Reminder set for ${days} days before deadline`, 'success');
            }
        }

        function viewTaxCalendar() {
            hideNotificationCenter();
            showTaxCalendar();
        }

        function filterDeadlines(filter) {
            const container = document.getElementById('deadlineList');
            const deadlines = container.querySelectorAll('.deadline-item');
            
            deadlines.forEach(deadline => {
                const daysLeftText = deadline.querySelector('.notification-time').textContent;
                const isOverdue = daysLeftText.includes('overdue');
                const isCompleted = deadline.classList.contains('read');
                const isUpcoming = !isOverdue && !isCompleted;
                
                let show = false;
                switch(filter) {
                    case 'upcoming':
                        show = isUpcoming;
                        break;
                    case 'overdue':
                        show = isOverdue;
                        break;
                    case 'completed':
                        show = isCompleted;
                        break;
                    case 'all':
                        show = true;
                        break;
                }
                
                deadline.style.display = show ? 'flex' : 'none';
            });
        }

        function setReminder(deadlineId) {
            showToast('Reminder set successfully!', 'success');
        }

        // Admin Panel Functions
        function showAdminPanel() {
            // Hide all other cards
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
            
            // Show admin panel
            document.getElementById('adminPanelCard').classList.remove('hidden');
            
            // Load admin data
            loadAdminDashboard();
        }

        function hideAdminPanel() {
            // Hide admin panel
            document.getElementById('adminPanelCard').classList.add('hidden');
            
            // Show main dashboard
            document.getElementById('reviewCard').classList.remove('hidden');
        }

        function showAdminTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load tab-specific data
            switch(tabName) {
                case 'dashboard':
                    loadAdminDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'returns':
                    loadReturns();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'logs':
                    loadLogs();
                    break;
            }
        }

        async function loadAdminDashboard() {
            try {
                // Load user statistics
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('user_id, is_active, is_verified, created_at');

                if (usersError) throw usersError;

                // Load tax returns statistics
                const { data: returns, error: returnsError } = await supabase
                    .from('tax_returns')
                    .select('return_id, status, tax_liability, created_at');

                if (returnsError) throw returnsError;

                // Update statistics
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalReturns').textContent = returns.length;
                
                const approvedReturns = returns.filter(r => r.status === 'Approved').length;
                document.getElementById('approvedReturns').textContent = approvedReturns;
                
                const totalRevenue = returns.reduce((sum, r) => sum + (parseFloat(r.tax_liability) || 0), 0);
                document.getElementById('totalRevenue').textContent = `â‚¹${totalRevenue.toLocaleString()}`;

                // Load charts
                loadUserTrendChart(users);
                loadReturnStatusChart(returns);

            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                alert('Error loading admin dashboard: ' + error.message);
            }
        }

        function loadUserTrendChart(users) {
            // Group users by month
            const monthlyData = {};
            users.forEach(user => {
                const month = new Date(user.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });

            // Create chart data
            const labels = Object.keys(monthlyData).sort();
            const data = labels.map(label => monthlyData[label]);

            const canvas = document.getElementById('userTrendChart');
            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            if (chartInstances.userTrend) {
                chartInstances.userTrend.destroy();
            }

            chartInstances.userTrend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Users',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--text-primary)'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `New Users: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'var(--text-primary)',
                                stepSize: 1
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-primary)'
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        }
                    }
                }
            });
        }

        function loadReturnStatusChart(returns) {
            // Group returns by status
            const statusData = {};
            returns.forEach(returnData => {
                statusData[returnData.status] = (statusData[returnData.status] || 0) + 1;
            });

            // Create chart data
            const labels = Object.keys(statusData);
            const data = Object.values(statusData);

            const canvas = document.getElementById('returnStatusChart');
            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            if (chartInstances.returnStatus) {
                chartInstances.returnStatus.destroy();
            }

            chartInstances.returnStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b',
                            '#feca57',
                            '#ff6b6b'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-primary)',
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select(`
                        user_id,
                        name,
                        email,
                        phone,
                        is_active,
                        is_verified,
                        last_login,
                        created_at,
                        roles(name)
                    `);

                if (error) throw error;

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td><span class="status-badge ${user.roles?.name === 'admin' ? 'status-verified' : 'status-unverified'}">${user.roles?.name || 'user'}</span></td>
                        <td><span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="viewUser('${user.user_id}')">View</button>
                                <button class="btn-action btn-edit" onclick="editUser('${user.user_id}')">Edit</button>
                                <button class="btn-action ${user.is_active ? 'btn-suspend' : 'btn-activate'}" onclick="toggleUserStatus('${user.user_id}', ${user.is_active})">
                                    ${user.is_active ? 'Suspend' : 'Activate'}
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteUser('${user.user_id}')">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users: ' + error.message);
            }
        }

        async function loadReturns() {
            try {
                const { data: returns, error } = await supabase
                    .from('tax_returns')
                    .select(`
                        return_id,
                        financial_year,
                        total_income,
                        tax_liability,
                        status,
                        filing_date,
                        created_at,
                        users(name, email)
                    `);

                if (error) throw error;

                const tbody = document.getElementById('returnsTableBody');
                tbody.innerHTML = '';

                returns.forEach(returnData => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="return-checkbox" value="${returnData.return_id}"></td>
                        <td>${returnData.users?.name || 'N/A'}</td>
                        <td>${returnData.financial_year || 'N/A'}</td>
                        <td>â‚¹${(returnData.total_income || 0).toLocaleString()}</td>
                        <td>â‚¹${(returnData.tax_liability || 0).toLocaleString()}</td>
                        <td><span class="status-badge status-${returnData.status?.toLowerCase()}">${returnData.status || 'N/A'}</span></td>
                        <td>${returnData.filing_date ? new Date(returnData.filing_date).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-edit" onclick="viewReturn('${returnData.return_id}')">View</button>
                                <button class="btn-action btn-edit" onclick="editReturn('${returnData.return_id}')">Edit</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading returns:', error);
                alert('Error loading returns: ' + error.message);
            }
        }

        // Chart instances for cleanup
        let chartInstances = {};

        async function loadAnalytics() {
            try {
                // Load data for all charts
                await Promise.all([
                    loadIncomeDistributionChart(),
                    loadTaxCollectionChart(),
                    loadUserActivityChart(),
                    loadGeoDistributionChart(),
                    loadMonthlyTrendsChart(),
                    loadSystemPerformanceChart()
                ]);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadIncomeDistributionChart() {
            try {
                // Get income data from database
                const { data: incomeData, error } = await supabase
                    .from('income_sources')
                    .select('amount, source_type');

                if (error) throw error;

                // Group income by source type
                const incomeBySource = {};
                incomeData.forEach(item => {
                    const source = item.source_type || 'Other';
                    incomeBySource[source] = (incomeBySource[source] || 0) + parseFloat(item.amount || 0);
                });

                const canvas = document.getElementById('incomeDistributionChart');
                const ctx = canvas.getContext('2d');

                // Destroy existing chart if it exists
                if (chartInstances.incomeDistribution) {
                    chartInstances.incomeDistribution.destroy();
                }

                chartInstances.incomeDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(incomeBySource),
                        datasets: [{
                            data: Object.values(incomeBySource),
                            backgroundColor: [
                                '#667eea',
                                '#f093fb',
                                '#4facfe',
                                '#43e97b',
                                '#feca57',
                                '#ff6b6b'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'var(--text-primary)',
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: â‚¹${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading income distribution chart:', error);
                showChartError('incomeDistributionChart', 'Error loading income data');
            }
        }

        async function loadTaxCollectionChart() {
            try {
                // Get tax collection data by month
                const { data: returnsData, error } = await supabase
                    .from('tax_returns')
                    .select('tax_liability, created_at, status')
                    .eq('status', 'Approved');

                if (error) throw error;

                // Group by month
                const monthlyData = {};
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                returnsData.forEach(returnData => {
                    const date = new Date(returnData.created_at);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + parseFloat(returnData.tax_liability || 0);
                });

                // Sort by date and prepare data
                const sortedMonths = Object.keys(monthlyData).sort();
                const labels = sortedMonths.map(month => {
                    const [year, monthNum] = month.split('-');
                    return `${months[parseInt(monthNum) - 1]} ${year}`;
                });
                const data = sortedMonths.map(month => monthlyData[month]);

                const canvas = document.getElementById('taxCollectionChart');
                const ctx = canvas.getContext('2d');

                // Destroy existing chart if it exists
                if (chartInstances.taxCollection) {
                    chartInstances.taxCollection.destroy();
                }

                chartInstances.taxCollection = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tax Collection (â‚¹)',
                            data: data,
                            backgroundColor: 'rgba(240, 147, 251, 0.8)',
                            borderColor: '#f093fb',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'var(--text-primary)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Tax Collected: â‚¹${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-primary)',
                                    callback: function(value) {
                                        return 'â‚¹' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading tax collection chart:', error);
                showChartError('taxCollectionChart', 'Error loading tax data');
            }
        }

        async function loadUserActivityChart() {
            try {
                // Get user activity data (login logs)
                const { data: loginData, error } = await supabase
                    .from('login_logs')
                    .select('login_time, login_status')
                    .gte('login_time', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()); // Last 30 days

                if (error) throw error;

                // Group by day
                const dailyActivity = {};
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                    const dateKey = date.toISOString().split('T')[0];
                    dailyActivity[dateKey] = 0;
                }

                loginData.forEach(login => {
                    const date = new Date(login.login_time).toISOString().split('T')[0];
                    if (dailyActivity.hasOwnProperty(date)) {
                        dailyActivity[date]++;
                    }
                });

                const labels = Object.keys(dailyActivity).map(date => {
                    return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                const data = Object.values(dailyActivity);

                const canvas = document.getElementById('userActivityChart');
                const ctx = canvas.getContext('2d');

                // Destroy existing chart if it exists
                if (chartInstances.userActivity) {
                    chartInstances.userActivity.destroy();
                }

                chartInstances.userActivity = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Logins',
                            data: data,
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#4facfe',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'var(--text-primary)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Logins: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-primary)',
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading user activity chart:', error);
                showChartError('userActivityChart', 'Error loading activity data');
            }
        }

        async function loadGeoDistributionChart() {
            try {
                // Get user geographic data
                const { data: usersData, error } = await supabase
                    .from('users')
                    .select('state, city');

                if (error) throw error;

                // Group by state
                const stateData = {};
                usersData.forEach(user => {
                    const state = user.state || 'Unknown';
                    stateData[state] = (stateData[state] || 0) + 1;
                });

                // Sort by count and take top 10
                const sortedStates = Object.entries(stateData)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);

                const labels = sortedStates.map(([state]) => state);
                const data = sortedStates.map(([, count]) => count);

                const canvas = document.getElementById('geoDistributionChart');
                const ctx = canvas.getContext('2d');

                // Destroy existing chart if it exists
                if (chartInstances.geoDistribution) {
                    chartInstances.geoDistribution.destroy();
                }

                chartInstances.geoDistribution = new Chart(ctx, {
                    type: 'horizontalBar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Users by State',
                            data: data,
                            backgroundColor: [
                                '#43e97b',
                                '#4facfe',
                                '#667eea',
                                '#f093fb',
                                '#feca57',
                                '#ff6b6b',
                                '#a8e6cf',
                                '#ffd3a5',
                                '#fd79a8',
                                '#6c5ce7'
                            ],
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'var(--text-primary)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.x} users`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-primary)',
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading geo distribution chart:', error);
                showChartError('geoDistributionChart', 'Error loading geographic data');
            }
        }

        async function loadMonthlyTrendsChart() {
            try {
                // Get tax returns and refund data from database
                const { data: returnsData, error: returnsError } = await supabase
                    .from('tax_returns')
                    .select('filing_date, status');

                const { data: refundsData, error: refundsError } = await supabase
                    .from('refunds')
                    .select('created_at, status');

                if (returnsError || refundsError) throw returnsError || refundsError;

                // Process monthly data
                const monthlyData = {};
                const currentYear = new Date().getFullYear();
                
                // Initialize months
                for (let i = 1; i <= 12; i++) {
                    const monthKey = `${currentYear}-${i.toString().padStart(2, '0')}`;
                    monthlyData[monthKey] = { returns: 0, refunds: 0 };
                }

                // Count returns by month
                returnsData.forEach(item => {
                    if (item.filing_date) {
                        const date = new Date(item.filing_date);
                        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        if (monthlyData[monthKey]) {
                            monthlyData[monthKey].returns++;
                        }
                    }
                });

                // Count refunds by month
                refundsData.forEach(item => {
                    if (item.created_at) {
                        const date = new Date(item.created_at);
                        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        if (monthlyData[monthKey]) {
                            monthlyData[monthKey].refunds++;
                        }
                    }
                });

                const labels = Object.keys(monthlyData).map(key => {
                    const month = key.split('-')[1];
                    return new Date(2024, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'short' });
                });
                const returnsChartData = Object.values(monthlyData).map(item => item.returns);
                const refundsChartData = Object.values(monthlyData).map(item => item.refunds);

                const canvas = document.getElementById('monthlyTrendsChart');
                const ctx = canvas.getContext('2d');

                // Destroy existing chart if it exists
                if (chartInstances.monthlyTrends) {
                    chartInstances.monthlyTrends.destroy();
                }

                chartInstances.monthlyTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Returns Filed',
                            data: returnsChartData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Refunds Processed',
                            data: refundsChartData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Monthly Processing Trends',
                                font: { size: 16, weight: 'bold' },
                                color: 'var(--text-primary)'
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: 'var(--text-primary)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-primary)'
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading monthly trends chart:', error);
                showChartError('monthlyTrendsChart', 'Error loading monthly trends data');
            }
        }

        async function loadSystemPerformanceChart() {
            try {
                // Simulate system performance metrics
                // In a real application, this would fetch from monitoring services
                const performanceData = {
                    labels: ['CPU Usage', 'Memory Usage', 'Database Performance', 'API Response Time', 'Uptime'],
                    values: [75, 60, 90, 85, 99]
                };

                const canvas = document.getElementById('systemPerformanceChart');
                const ctx = canvas.getContext('2d');

                // Destroy existing chart if it exists
                if (chartInstances.systemPerformance) {
                    chartInstances.systemPerformance.destroy();
                }

                chartInstances.systemPerformance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: performanceData.labels,
                        datasets: [{
                            label: 'Performance Metrics (%)',
                            data: performanceData.values,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'System Performance Overview',
                                font: { size: 16, weight: 'bold' },
                                color: 'var(--text-primary)'
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: 'var(--text-primary)',
                                    stepSize: 20
                                },
                                grid: {
                                    color: 'var(--border-color)'
                                },
                                angleLines: {
                                    color: 'var(--border-color)'
                                },
                                pointLabels: {
                                    color: 'var(--text-primary)',
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading system performance chart:', error);
                showChartError('systemPerformanceChart', 'Error loading system performance data');
            }
        }

        function showChartError(canvasId, message) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#e53e3e';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(message, canvas.width/2, canvas.height/2);
        }

        function loadSettings() {
            // Load system settings
            // This would typically load from a settings table or configuration
        }

        function loadLogs() {
            // Load system logs
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.innerHTML = `
                <div class="log-entry info">[${new Date().toISOString()}] System started successfully</div>
                <div class="log-entry success">[${new Date().toISOString()}] User authentication successful</div>
                <div class="log-entry warning">[${new Date().toISOString()}] High memory usage detected</div>
                <div class="log-entry error">[${new Date().toISOString()}] Database connection timeout</div>
            `;
        }

        // User management functions
        async function editUser(userId) {
            try {
                // Fetch user details
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                if (error) throw error;

                // Create edit user modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-edit"></i> Edit User</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <div class="form-group">
                                    <label for="editUserName">Name:</label>
                                    <input type="text" id="editUserName" value="${user.name || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editUserEmail">Email:</label>
                                    <input type="email" id="editUserEmail" value="${user.email || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editUserPhone">Phone:</label>
                                    <input type="tel" id="editUserPhone" value="${user.phone || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editUserPAN">PAN:</label>
                                    <input type="text" id="editUserPAN" value="${user.pan || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editUserAadhaar">Aadhaar:</label>
                                    <input type="text" id="editUserAadhaar" value="${user.aadhaar || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editUserAddress">Address:</label>
                                    <textarea id="editUserAddress" rows="3">${user.address || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editUserCity">City:</label>
                                    <input type="text" id="editUserCity" value="${user.city || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editUserState">State:</label>
                                    <input type="text" id="editUserState" value="${user.state || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editUserPinCode">PIN Code:</label>
                                    <input type="text" id="editUserPinCode" value="${user.pin_code || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editUserStatus">Status:</label>
                                    <select id="editUserStatus">
                                        <option value="true" ${user.is_active ? 'selected' : ''}>Active</option>
                                        <option value="false" ${!user.is_active ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editUserVerified">Verified:</label>
                                    <select id="editUserVerified">
                                        <option value="true" ${user.is_verified ? 'selected' : ''}>Verified</option>
                                        <option value="false" ${!user.is_verified ? 'selected' : ''}>Unverified</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editUserRole">Role:</label>
                                    <select id="editUserRole">
                                        <option value="user" ${!user.is_admin ? 'selected' : ''}>User</option>
                                        <option value="admin" ${user.is_admin ? 'selected' : ''}>Admin</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveUserEdit('${userId}')">Save Changes</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Error loading user details: ' + error.message);
            }
        }

        async function saveUserEdit(userId) {
            try {
                const formData = {
                    name: document.getElementById('editUserName').value,
                    email: document.getElementById('editUserEmail').value,
                    phone: document.getElementById('editUserPhone').value,
                    pan: document.getElementById('editUserPAN').value,
                    aadhaar: document.getElementById('editUserAadhaar').value,
                    address: document.getElementById('editUserAddress').value,
                    city: document.getElementById('editUserCity').value,
                    state: document.getElementById('editUserState').value,
                    pin_code: document.getElementById('editUserPinCode').value,
                    is_active: document.getElementById('editUserStatus').value === 'true',
                    is_verified: document.getElementById('editUserVerified').value === 'true',
                    is_admin: document.getElementById('editUserRole').value === 'admin'
                };

                const { error } = await supabase
                    .from('users')
                    .update(formData)
                    .eq('user_id', userId);

                if (error) throw error;

                alert('User updated successfully');
                closeModal();
                loadUsers(); // Refresh the user list

            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user: ' + error.message);
            }
        }

        function viewUser(userId) {
            editUser(userId); // For now, view and edit use the same modal
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ is_active: !currentStatus })
                    .eq('user_id', userId);

                if (error) throw error;

                alert(`User ${!currentStatus ? 'activated' : 'suspended'} successfully`);
                loadUsers(); // Refresh the user list

            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Error updating user status: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('user_id', userId);

                if (error) throw error;

                alert('User deleted successfully');
                loadUsers(); // Refresh the user list

            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user: ' + error.message);
            }
        }

        // Return management functions
        async function viewReturn(returnId) {
            try {
                // Fetch return details with user information
                const { data: returnData, error } = await supabase
                    .from('tax_returns')
                    .select(`
                        *,
                        users(name, email, pan, phone)
                    `)
                    .eq('return_id', returnId)
                    .single();

                if (error) throw error;

                // Create view return modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-eye"></i> View Tax Return</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="return-details">
                                <div class="detail-section">
                                    <h4><i class="fas fa-user"></i> Taxpayer Information</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Name:</label>
                                            <span>${returnData.users?.name || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Email:</label>
                                            <span>${returnData.users?.email || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>PAN:</label>
                                            <span>${returnData.users?.pan || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Phone:</label>
                                            <span>${returnData.users?.phone || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="detail-section">
                                    <h4><i class="fas fa-file-invoice"></i> Return Details</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Financial Year:</label>
                                            <span>${returnData.financial_year || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Status:</label>
                                            <span class="status-badge status-${returnData.status?.toLowerCase() || 'unknown'}">${returnData.status || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Filing Date:</label>
                                            <span>${returnData.filing_date ? new Date(returnData.filing_date).toLocaleDateString() : 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Created:</label>
                                            <span>${returnData.created_at ? new Date(returnData.created_at).toLocaleDateString() : 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="detail-section">
                                    <h4><i class="fas fa-calculator"></i> Financial Summary</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Total Income:</label>
                                            <span>â‚¹${returnData.total_income ? parseFloat(returnData.total_income).toLocaleString() : '0'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Total Deduction:</label>
                                            <span>â‚¹${returnData.total_deduction ? parseFloat(returnData.total_deduction).toLocaleString() : '0'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Taxable Income:</label>
                                            <span>â‚¹${returnData.taxable_income ? parseFloat(returnData.taxable_income).toLocaleString() : '0'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Tax Liability:</label>
                                            <span class="highlight-amount">â‚¹${returnData.tax_liability ? parseFloat(returnData.tax_liability).toLocaleString() : '0'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn btn-primary" onclick="editReturn('${returnId}')">Edit Return</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading return details:', error);
                alert('Error loading return details: ' + error.message);
            }
        }

        async function editReturn(returnId) {
            try {
                // Fetch return details
                const { data: returnData, error } = await supabase
                    .from('tax_returns')
                    .select('*')
                    .eq('return_id', returnId)
                    .single();

                if (error) throw error;

                // Create edit return modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-edit"></i> Edit Tax Return</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editReturnForm">
                                <div class="form-group">
                                    <label for="editReturnStatus">Status:</label>
                                    <select id="editReturnStatus">
                                        <option value="Pending" ${returnData.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option value="Filed" ${returnData.status === 'Filed' ? 'selected' : ''}>Filed</option>
                                        <option value="Approved" ${returnData.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                        <option value="Rejected" ${returnData.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editReturnTotalIncome">Total Income:</label>
                                    <input type="number" id="editReturnTotalIncome" value="${returnData.total_income || 0}" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="editReturnTotalDeduction">Total Deduction:</label>
                                    <input type="number" id="editReturnTotalDeduction" value="${returnData.total_deduction || 0}" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="editReturnTaxableIncome">Taxable Income:</label>
                                    <input type="number" id="editReturnTaxableIncome" value="${returnData.taxable_income || 0}" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="editReturnTaxLiability">Tax Liability:</label>
                                    <input type="number" id="editReturnTaxLiability" value="${returnData.tax_liability || 0}" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="editReturnTaxRegime">Tax Regime:</label>
                                    <select id="editReturnTaxRegime">
                                        <option value="old" ${returnData.tax_regime === 'old' ? 'selected' : ''}>Old Regime</option>
                                        <option value="new" ${returnData.tax_regime === 'new' ? 'selected' : ''}>New Regime</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editReturnFilingDate">Filing Date:</label>
                                    <input type="date" id="editReturnFilingDate" value="${returnData.filing_date ? returnData.filing_date.split('T')[0] : ''}">
                                </div>
                                <div class="form-group">
                                    <label for="editReturnEVerified">E-Verified:</label>
                                    <select id="editReturnEVerified">
                                        <option value="true" ${returnData.is_e_verified ? 'selected' : ''}>Yes</option>
                                        <option value="false" ${!returnData.is_e_verified ? 'selected' : ''}>No</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveReturnEdit('${returnId}')">Save Changes</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading return details:', error);
                alert('Error loading return details: ' + error.message);
            }
        }

        async function saveReturnEdit(returnId) {
            try {
                const formData = {
                    status: document.getElementById('editReturnStatus').value,
                    total_income: parseFloat(document.getElementById('editReturnTotalIncome').value) || 0,
                    total_deduction: parseFloat(document.getElementById('editReturnTotalDeduction').value) || 0,
                    taxable_income: parseFloat(document.getElementById('editReturnTaxableIncome').value) || 0,
                    tax_liability: parseFloat(document.getElementById('editReturnTaxLiability').value) || 0,
                    tax_regime: document.getElementById('editReturnTaxRegime').value,
                    filing_date: document.getElementById('editReturnFilingDate').value || null,
                    is_e_verified: document.getElementById('editReturnEVerified').value === 'true'
                };

                const { error } = await supabase
                    .from('tax_returns')
                    .update(formData)
                    .eq('return_id', returnId);

                if (error) throw error;

                alert('Tax return updated successfully');
                closeModal();
                loadReturns(); // Refresh the returns list

            } catch (error) {
                console.error('Error updating tax return:', error);
                alert('Error updating tax return: ' + error.message);
            }
        }

        function toggleAllReturns() {
            const selectAll = document.getElementById('selectAllReturns');
            const checkboxes = document.querySelectorAll('.return-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        async function approveSelectedReturns() {
            const selectedReturns = Array.from(document.querySelectorAll('.return-checkbox:checked'))
                .map(cb => cb.value);

            if (selectedReturns.length === 0) {
                alert('Please select returns to approve');
                return;
            }

            try {
                const { error } = await supabase
                    .from('tax_returns')
                    .update({ status: 'Approved' })
                    .in('return_id', selectedReturns);

                if (error) throw error;

                alert(`${selectedReturns.length} returns approved successfully`);
                loadReturns(); // Refresh the returns list

            } catch (error) {
                console.error('Error approving returns:', error);
                alert('Error approving returns: ' + error.message);
            }
        }

        async function rejectSelectedReturns() {
            const selectedReturns = Array.from(document.querySelectorAll('.return-checkbox:checked'))
                .map(cb => cb.value);

            if (selectedReturns.length === 0) {
                alert('Please select returns to reject');
                return;
            }

            try {
                const { error } = await supabase
                    .from('tax_returns')
                    .update({ status: 'Rejected' })
                    .in('return_id', selectedReturns);

                if (error) throw error;

                alert(`${selectedReturns.length} returns rejected successfully`);
                loadReturns(); // Refresh the returns list

            } catch (error) {
                console.error('Error rejecting returns:', error);
                alert('Error rejecting returns: ' + error.message);
            }
        }

        // Filter functions
        function filterUsers() {
            // Implement user filtering
            console.log('Filtering users...');
        }

        function filterReturns() {
            // Implement return filtering
            console.log('Filtering returns...');
        }

        function filterLogs() {
            // Implement log filtering
            console.log('Filtering logs...');
        }

        // Settings functions
        function updateTaxSettings() {
            alert('Tax settings updated successfully');
        }

        function toggleMaintenanceMode() {
            const maintenanceMode = document.getElementById('maintenanceMode').checked;
            alert(`Maintenance mode ${maintenanceMode ? 'enabled' : 'disabled'}`);
        }

        // Analytics functions
        function generateAnalyticsReport() {
            alert('Generating analytics report...');
        }

        // Log functions
        function refreshLogs() {
            loadLogs();
        }

        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                document.getElementById('logsContainer').innerHTML = '';
            }
        }

        // Communication System Functions
        
        // Support Center Functions
        function showSupportCenter() {
            hideAllCards();
            document.getElementById('supportCenterCard').classList.remove('hidden');
            showSupportTab('tickets');
        }

        function showSupportTab(tabName) {
            // Hide all support content
            document.querySelectorAll('.support-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.support-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content and activate tab
            document.getElementById(`support${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden');
            event.target.classList.add('active');
            
            // Load data based on tab
            if (tabName === 'tickets') {
                loadSupportTickets();
            } else if (tabName === 'chat') {
                initializeChat();
            }
        }

        async function loadSupportTickets() {
            try {
                const ticketsList = document.getElementById('ticketsList');
                
                // Sample tickets data (in real app, fetch from database)
                const sampleTickets = [
                    {
                        id: 'TICKET-001',
                        subject: 'Unable to file tax return',
                        category: 'Tax Filing',
                        status: 'Open',
                        priority: 'High',
                        created_at: '2024-01-15',
                        description: 'Getting error when trying to submit my tax return...'
                    },
                    {
                        id: 'TICKET-002',
                        subject: 'Payment not processed',
                        category: 'Payment Issues',
                        status: 'In Progress',
                        priority: 'Medium',
                        created_at: '2024-01-14',
                        description: 'Made payment but status still shows pending...'
                    },
                    {
                        id: 'TICKET-003',
                        subject: 'Refund status inquiry',
                        category: 'Refund Issues',
                        status: 'Resolved',
                        priority: 'Low',
                        created_at: '2024-01-12',
                        description: 'Want to check my refund processing status...'
                    }
                ];
                
                ticketsList.innerHTML = sampleTickets.map(ticket => `
                    <div class="ticket-item" onclick="viewTicketDetails('${ticket.id}')">
                        <div class="ticket-header">
                            <div>
                                <div class="ticket-title">${ticket.subject}</div>
                                <div class="ticket-id">${ticket.id}</div>
                            </div>
                            <span class="ticket-status ${ticket.status.toLowerCase().replace(' ', '-')}">${ticket.status}</span>
                        </div>
                        <div class="ticket-meta">
                            <span><i class="fas fa-folder"></i> ${ticket.category}</span>
                            <span class="ticket-priority ${ticket.priority.toLowerCase()}">${ticket.priority}</span>
                            <span><i class="fas fa-calendar"></i> ${new Date(ticket.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading support tickets:', error);
            }
        }

        function filterTickets() {
            const statusFilter = document.getElementById('ticketStatusFilter').value;
            const priorityFilter = document.getElementById('ticketPriorityFilter').value;
            
            const tickets = document.querySelectorAll('.ticket-item');
            
            tickets.forEach(ticket => {
                const status = ticket.querySelector('.ticket-status').textContent;
                const priority = ticket.querySelector('.ticket-priority').textContent;
                
                const statusMatch = !statusFilter || status === statusFilter;
                const priorityMatch = !priorityFilter || priority === priorityFilter;
                
                ticket.style.display = statusMatch && priorityMatch ? 'block' : 'none';
            });
        }

        function viewTicketDetails(ticketId) {
            // Find the ticket data
            const ticket = supportTickets.find(t => t.id === ticketId);
            if (!ticket) {
                alert('Ticket not found');
                return;
            }

            // Create modal for ticket details
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-ticket-alt"></i> Ticket Details</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="ticket-details">
                            <div class="detail-section">
                                <h4>Ticket Information</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Ticket ID:</span>
                                        <span class="detail-value">${ticket.id}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Subject:</span>
                                        <span class="detail-value">${ticket.subject}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Category:</span>
                                        <span class="detail-value">${ticket.category}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Priority:</span>
                                        <span class="detail-value">
                                            <span class="priority-badge ${ticket.priority.toLowerCase()}">${ticket.priority}</span>
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Status:</span>
                                        <span class="detail-value">
                                            <span class="status-badge ${ticket.status.toLowerCase().replace(' ', '-')}">${ticket.status}</span>
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Created:</span>
                                        <span class="detail-value">${ticket.date}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Description</h4>
                                <div class="ticket-description">
                                    <p>${ticket.description}</p>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Conversation</h4>
                                <div class="conversation-thread">
                                    <div class="message user-message">
                                        <div class="message-header">
                                            <span class="sender-name">You</span>
                                            <span class="message-time">${ticket.date}</span>
                                        </div>
                                        <div class="message-text">${ticket.description}</div>
                                    </div>
                                    ${ticket.status === 'Resolved' ? `
                                    <div class="message agent-message">
                                        <div class="message-header">
                                            <span class="sender-name">Support Agent</span>
                                            <span class="message-time">${ticket.resolvedDate || '1/16/2024'}</span>
                                        </div>
                                        <div class="message-text">Thank you for contacting us. We have resolved your issue. If you need any further assistance, please don't hesitate to reach out.</div>
                                    </div>
                                    ` : ticket.status === 'In Progress' ? `
                                    <div class="message agent-message">
                                        <div class="message-header">
                                            <span class="sender-name">Support Agent</span>
                                            <span class="message-time">1/15/2024</span>
                                        </div>
                                        <div class="message-text">We are currently working on your request. We will update you as soon as we have more information.</div>
                                    </div>
                                    ` : `
                                    <div class="message system-message">
                                        <div class="message-text">Your ticket has been received and is awaiting review by our support team.</div>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                        ${ticket.status === 'Open' ? `
                        <button class="btn btn-primary" onclick="replyToTicket('${ticketId}')">
                            <i class="fas fa-reply"></i> Reply
                        </button>
                        ` : ''}
                        ${ticket.status === 'Resolved' ? `
                        <button class="btn btn-success" onclick="reopenTicket('${ticketId}')">
                            <i class="fas fa-redo"></i> Reopen Ticket
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function replyToTicket(ticketId) {
            const reply = prompt('Enter your reply:');
            if (reply && reply.trim()) {
                // In a real application, this would send the reply to the server
                alert(`Reply sent for ticket ${ticketId}: "${reply}"`);
                closeModal();
                // Refresh the ticket list
                loadSupportTickets();
            }
        }

        function reopenTicket(ticketId) {
            if (confirm('Are you sure you want to reopen this ticket?')) {
                // In a real application, this would update the ticket status
                alert(`Ticket ${ticketId} has been reopened.`);
                closeModal();
                // Refresh the ticket list
                loadSupportTickets();
            }
        }

        async function createSupportTicket() {
            try {
                const subject = document.getElementById('ticketSubject').value;
                const category = document.getElementById('ticketCategory').value;
                const priority = document.getElementById('ticketPriority').value;
                const description = document.getElementById('ticketDescription').value;
                
                if (!subject || !category || !description) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // In a real application, you would save this to the database
                const ticketData = {
                    user_id: currentUser?.user_id,
                    subject,
                    category,
                    priority,
                    description,
                    status: 'Open',
                    created_at: new Date().toISOString()
                };
                
                console.log('Creating ticket:', ticketData);
                
                alert('Support ticket created successfully! You will receive updates via email.');
                
                // Clear form
                document.getElementById('createTicketForm').reset();
                
                // Switch to tickets tab
                showSupportTab('tickets');
                
            } catch (error) {
                console.error('Error creating support ticket:', error);
                alert('Error creating support ticket: ' + error.message);
            }
        }

        // Chat Functions
        function initializeChat() {
            // Add some sample messages
            const chatMessages = document.getElementById('chatMessages');
            
            // Clear existing messages except the first one
            const firstMessage = chatMessages.querySelector('.chat-message');
            chatMessages.innerHTML = '';
            chatMessages.appendChild(firstMessage);
        }

        function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            
            // Clear input
            input.value = '';
            
            // Simulate agent response after a delay
            setTimeout(() => {
                const responses = [
                    "Thank you for your message. Let me help you with that.",
                    "I understand your concern. Let me check that for you.",
                    "That's a great question. Here's what I can tell you...",
                    "I'll need to escalate this to our technical team. You'll receive an update within 24 hours.",
                    "Is there anything else I can help you with today?"
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage(randomResponse, 'agent');
            }, 1000);
        }

        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const senderName = sender === 'user' ? (currentUser?.name || 'You') : 'Support Agent';
            const avatarIcon = sender === 'user' ? 'fas fa-user' : 'fas fa-user-tie';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="${avatarIcon}"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="sender-name">${senderName}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${message}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="chat-message agent">
                    <div class="message-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="sender-name">Support Agent</span>
                            <span class="message-time">Just now</span>
                        </div>
                        <div class="message-text">
                            Hello! Welcome to Taxaid.gov Support. How can I help you today?
                        </div>
                    </div>
                </div>
            `;
        }

        // Help Desk Functions
        function showHelpDesk() {
            hideAllCards();
            document.getElementById('helpDeskCard').classList.remove('hidden');
            showHelpCategory('getting-started');
        }

        function showHelpCategory(category) {
            // Remove active class from all category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            loadHelpArticles(category);
        }

        function loadHelpArticles(category) {
            const helpArticles = document.getElementById('helpArticles');
            
            const articles = {
                'getting-started': [
                    {
                        title: 'How to Create Your Taxaid.gov Account',
                        summary: 'Step-by-step guide to register and set up your Taxaid.gov account for the first time.',
                        category: 'Getting Started',
                        readTime: '3 min read'
                    },
                    {
                        title: 'Understanding the Taxaid.gov Dashboard',
                        summary: 'Navigate through your dashboard and understand all the available features and options.',
                        category: 'Getting Started',
                        readTime: '5 min read'
                    },
                    {
                        title: 'Profile Setup and Verification',
                        summary: 'Complete your profile information and verify your identity for secure tax filing.',
                        category: 'Getting Started',
                        readTime: '4 min read'
                    }
                ],
                'tax-filing': [
                    {
                        title: 'Filing Your First Tax Return',
                        summary: 'Complete guide to filing your income tax return using the Taxaid.gov platform.',
                        category: 'Tax Filing',
                        readTime: '10 min read'
                    },
                    {
                        title: 'Understanding Tax Regimes',
                        summary: 'Learn about old vs new tax regime and which one is better for your situation.',
                        category: 'Tax Filing',
                        readTime: '7 min read'
                    },
                    {
                        title: 'Deductions and Exemptions Guide',
                        summary: 'Comprehensive list of all available deductions and how to claim them.',
                        category: 'Tax Filing',
                        readTime: '12 min read'
                    }
                ],
                'payments': [
                    {
                        title: 'How to Pay Your Taxes Online',
                        summary: 'Step-by-step guide to make tax payments through various online methods.',
                        category: 'Payments',
                        readTime: '6 min read'
                    },
                    {
                        title: 'Understanding Tax Challans',
                        summary: 'Learn about different types of challans and how to generate them.',
                        category: 'Payments',
                        readTime: '5 min read'
                    },
                    {
                        title: 'Payment Confirmation and Receipts',
                        summary: 'How to verify your payment status and download payment receipts.',
                        category: 'Payments',
                        readTime: '3 min read'
                    }
                ],
                'account': [
                    {
                        title: 'Managing Your Account Settings',
                        summary: 'Update your personal information, contact details, and account preferences.',
                        category: 'Account',
                        readTime: '4 min read'
                    },
                    {
                        title: 'Security and Privacy Settings',
                        summary: 'Protect your account with strong passwords and privacy settings.',
                        category: 'Account',
                        readTime: '5 min read'
                    },
                    {
                        title: 'Bank Account Management',
                        summary: 'Add, update, or remove bank accounts for refund processing.',
                        category: 'Account',
                        readTime: '3 min read'
                    }
                ],
                'troubleshooting': [
                    {
                        title: 'Common Login Issues',
                        summary: 'Resolve login problems, password resets, and account access issues.',
                        category: 'Troubleshooting',
                        readTime: '4 min read'
                    },
                    {
                        title: 'Tax Calculation Errors',
                        summary: 'Fix common tax calculation problems and discrepancies.',
                        category: 'Troubleshooting',
                        readTime: '6 min read'
                    },
                    {
                        title: 'File Upload Problems',
                        summary: 'Solutions for document upload failures and format issues.',
                        category: 'Troubleshooting',
                        readTime: '3 min read'
                    }
                ]
            };
            
            const categoryArticles = articles[category] || [];
            
            helpArticles.innerHTML = categoryArticles.map(article => `
                <div class="help-article" onclick="openHelpArticle('${article.title}')">
                    <div class="help-article-title">
                        <i class="fas fa-file-alt"></i>
                        ${article.title}
                    </div>
                    <div class="help-article-summary">
                        ${article.summary}
                    </div>
                    <div class="help-article-meta">
                        <span class="help-article-category">${article.category}</span>
                        <span><i class="fas fa-clock"></i> ${article.readTime}</span>
                    </div>
                </div>
            `).join('');
        }

        function searchHelpArticles() {
            const searchTerm = document.getElementById('helpSearchInput').value.toLowerCase();
            const articles = document.querySelectorAll('.help-article');
            
            articles.forEach(article => {
                const title = article.querySelector('.help-article-title').textContent.toLowerCase();
                const summary = article.querySelector('.help-article-summary').textContent.toLowerCase();
                
                const matches = title.includes(searchTerm) || summary.includes(searchTerm);
                article.style.display = matches ? 'block' : 'none';
            });
        }

        function openHelpArticle(title) {
            showArticleModal(title, 'help');
        }

        function showArticleModal(title, type) {
            const articleContent = getArticleContent(title, type);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-alt"></i> ${title}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="article-content">
                            ${articleContent}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                        <button class="btn btn-primary" onclick="printArticle()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getArticleContent(title, type) {
            const helpArticles = {
                'How to Create Your Taxaid.gov Account': `
                    <div class="article-header">
                        <span class="article-category">Getting Started</span>
                        <span class="article-time"><i class="fas fa-clock"></i> 3 min read</span>
                    </div>
                    
                    <h4>Step 1: Visit the Taxaid.gov Registration Page</h4>
                    <p>Navigate to the Taxaid.gov homepage and click on the "Create Account" button. You'll be redirected to the registration form.</p>
                    
                    <h4>Step 2: Fill in Your Personal Information</h4>
                    <ul>
                        <li><strong>Full Name:</strong> Enter your complete name as per official documents</li>
                        <li><strong>Email Address:</strong> Use a valid email address that you have access to</li>
                        <li><strong>Phone Number:</strong> Enter your 10-digit mobile number</li>
                        <li><strong>Date of Birth:</strong> Select your date of birth from the calendar</li>
                    </ul>
                    
                    <h4>Step 3: Enter Tax Information</h4>
                    <ul>
                        <li><strong>PAN Number:</strong> Enter your 10-digit PAN card number</li>
                        <li><strong>Aadhaar Number:</strong> Enter your 12-digit Aadhaar number</li>
                        <li><strong>Address:</strong> Provide your current residential address</li>
                    </ul>
                    
                    <h4>Step 4: Set Up Security</h4>
                    <ul>
                        <li>Create a strong password with at least 8 characters</li>
                        <li>Include uppercase, lowercase, numbers, and special characters</li>
                        <li>Confirm your password by typing it again</li>
                    </ul>
                    
                    <h4>Step 5: Verify Your Account</h4>
                    <p>After registration, you'll receive an OTP on your mobile number and email. Enter the OTP to verify your account and complete the registration process.</p>
                    
                    <div class="article-tips">
                        <h5><i class="fas fa-lightbulb"></i> Tips for Success:</h5>
                        <ul>
                            <li>Keep your PAN and Aadhaar cards ready before starting</li>
                            <li>Use a strong, unique password for security</li>
                            <li>Double-check all information before submitting</li>
                            <li>Save your login credentials in a secure place</li>
                        </ul>
                    </div>
                `,
                
                'Understanding the Taxaid.gov Dashboard': `
                    <div class="article-header">
                        <span class="article-category">Getting Started</span>
                        <span class="article-time"><i class="fas fa-clock"></i> 5 min read</span>
                    </div>
                    
                    <h4>Dashboard Overview</h4>
                    <p>The Taxaid.gov dashboard is your central hub for managing all tax-related activities. It provides quick access to all features and shows important information at a glance.</p>
                    
                    <h4>Main Sections</h4>
                    
                    <h5>1. Header Section</h5>
                    <ul>
                        <li><strong>User Welcome:</strong> Shows your name and current login status</li>
                        <li><strong>Profile Button:</strong> Access and edit your personal information</li>
                        <li><strong>Theme Toggle:</strong> Switch between light and dark modes</li>
                        <li><strong>Logout:</strong> Securely exit your account</li>
                    </ul>
                    
                    <h5>2. Statistics Dashboard</h5>
                    <p>View real-time counts of:</p>
                    <ul>
                        <li>Total users in the system</li>
                        <li>Your income sources</li>
                        <li>Tax returns filed</li>
                        <li>Deductions claimed</li>
                        <li>Documents uploaded</li>
                    </ul>
                    
                    <h5>3. Process Steps</h5>
                    <p>The 5-step process indicator shows your progress:</p>
                    <ol>
                        <li><strong>File Return:</strong> Start your tax return process</li>
                        <li><strong>Income Details:</strong> Add your income sources</li>
                        <li><strong>Deductions:</strong> Claim eligible deductions</li>
                        <li><strong>Review & Calculate:</strong> Review and calculate taxes</li>
                        <li><strong>Submit Return:</strong> Final submission and e-verification</li>
                    </ol>
                    
                    <h5>4. Quick Actions</h5>
                    <ul>
                        <li><strong>Tax Calendar:</strong> View important tax dates and deadlines</li>
                        <li><strong>Analytics:</strong> View charts and reports of your tax data</li>
                        <li><strong>Reports:</strong> Generate and download tax reports</li>
                        <li><strong>Refund:</strong> Check refund status and apply for refunds</li>
                        <li><strong>Support Center:</strong> Get help and create support tickets</li>
                    </ul>
                    
                    <div class="article-tips">
                        <h5><i class="fas fa-lightbulb"></i> Navigation Tips:</h5>
                        <ul>
                            <li>Use the process steps to track your progress</li>
                            <li>Check the statistics for a quick overview</li>
                            <li>Access help through the Support Center if needed</li>
                            <li>Use the theme toggle for comfortable viewing</li>
                        </ul>
                    </div>
                `,
                
                'Filing Your First Tax Return': `
                    <div class="article-header">
                        <span class="article-category">Tax Filing</span>
                        <span class="article-time"><i class="fas fa-clock"></i> 10 min read</span>
                    </div>
                    
                    <h4>Before You Start</h4>
                    <p>Ensure you have the following documents ready:</p>
                    <ul>
                        <li>Form 16 from your employer</li>
                        <li>Bank statements</li>
                        <li>Investment proofs (80C, 80D, etc.)</li>
                        <li>House rent receipts (if claiming HRA)</li>
                        <li>Interest certificates from banks</li>
                    </ul>
                    
                    <h4>Step-by-Step Filing Process</h4>
                    
                    <h5>Step 1: Choose Assessment Year</h5>
                    <p>Select the appropriate assessment year for which you're filing the return. For income earned in FY 2023-24, choose AY 2024-25.</p>
                    
                    <h5>Step 2: Select ITR Form</h5>
                    <ul>
                        <li><strong>ITR-1:</strong> For salaried individuals with income up to â‚¹50 lakhs</li>
                        <li><strong>ITR-2:</strong> For individuals with capital gains or house property income</li>
                        <li><strong>ITR-3:</strong> For individuals with business or professional income</li>
                        <li><strong>ITR-4:</strong> For presumptive business income</li>
                    </ul>
                    
                    <h5>Step 3: Add Income Sources</h5>
                    <ul>
                        <li>Salary income from Form 16</li>
                        <li>Interest from savings accounts</li>
                        <li>Rental income from house property</li>
                        <li>Business or professional income</li>
                        <li>Capital gains from investments</li>
                    </ul>
                    
                    <h5>Step 4: Claim Deductions</h5>
                    <ul>
                        <li><strong>Section 80C:</strong> Up to â‚¹1.5 lakhs (PPF, ELSS, Life Insurance)</li>
                        <li><strong>Section 80D:</strong> Health insurance premiums</li>
                        <li><strong>Section 24:</strong> Home loan interest</li>
                        <li><strong>HRA:</strong> House rent allowance exemption</li>
                    </ul>
                    
                    <h5>Step 5: Review and Calculate</h5>
                    <p>Taxaid.gov automatically calculates your tax liability under both old and new tax regimes and recommends the better option.</p>
                    
                    <h5>Step 6: Submit and E-Verify</h5>
                    <p>After final review, submit your return and complete e-verification using Aadhaar OTP, net banking, or EVC.</p>
                    
                    <div class="article-tips">
                        <h5><i class="fas fa-lightbulb"></i> Filing Tips:</h5>
                        <ul>
                            <li>File your return before the due date to avoid penalties</li>
                            <li>Keep all supporting documents for future reference</li>
                            <li>Review all entries carefully before submission</li>
                            <li>Complete e-verification within 120 days of filing</li>
                        </ul>
                    </div>
                `,
                
                'How to Pay Your Taxes Online': `
                    <div class="article-header">
                        <span class="article-category">Payments</span>
                        <span class="article-time"><i class="fas fa-clock"></i> 6 min read</span>
                    </div>
                    
                    <h4>Available Payment Methods</h4>
                    <p>Taxaid.gov supports multiple secure payment methods:</p>
                    
                    <h5>1. Net Banking</h5>
                    <ul>
                        <li>Direct transfer from your bank account</li>
                        <li>Supported by all major banks</li>
                        <li>Instant confirmation</li>
                        <li>Most secure method</li>
                    </ul>
                    
                    <h5>2. UPI Payment</h5>
                    <ul>
                        <li>Quick payments using UPI ID</li>
                        <li>Google Pay, PhonePe, Paytm supported</li>
                        <li>Instant processing</li>
                        <li>Mobile-friendly</li>
                    </ul>
                    
                    <h5>3. Debit/Credit Cards</h5>
                    <ul>
                        <li>Visa, MasterCard, RuPay accepted</li>
                        <li>Secure 3D authentication</li>
                        <li>Immediate confirmation</li>
                        <li>Convenience fee may apply</li>
                    </ul>
                    
                    <h4>Payment Process</h4>
                    <ol>
                        <li>Complete your tax return calculation</li>
                        <li>Click on "Pay Tax" button</li>
                        <li>Review tax liability amount</li>
                        <li>Select preferred payment method</li>
                        <li>Enter payment details</li>
                        <li>Confirm and process payment</li>
                        <li>Download payment receipt</li>
                    </ol>
                    
                    <div class="article-tips">
                        <h5><i class="fas fa-info-circle"></i> Important Notes:</h5>
                        <ul>
                            <li>Payment must be made before the due date</li>
                            <li>Keep payment receipts for your records</li>
                            <li>Check for any convenience fees before payment</li>
                            <li>Contact support if payment fails</li>
                        </ul>
                    </div>
                `
            };
            
            return helpArticles[title] || `
                <div class="article-header">
                    <span class="article-category">Help Article</span>
                </div>
                <h4>${title}</h4>
                <p>This article provides comprehensive information about ${title.toLowerCase()}.</p>
                <p>Our detailed guide will walk you through the process step by step, ensuring you have all the information needed to complete this task successfully.</p>
                <div class="article-tips">
                    <h5><i class="fas fa-info-circle"></i> Need More Help?</h5>
                    <p>If you need additional assistance, please contact our support team through the Support Center.</p>
                </div>
            `;
        }

        function printArticle() {
            window.print();
        }

        // FAQ Functions
        function showFAQ() {
            hideAllCards();
            document.getElementById('faqCard').classList.remove('hidden');
            loadFAQs('all');
        }

        function showFAQCategory(category) {
            // Remove active class from all category buttons
            document.querySelectorAll('.faq-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            loadFAQs(category);
        }

        function loadFAQs(category) {
            const faqList = document.getElementById('faqList');
            
            const faqs = [
                {
                    category: 'general',
                    question: 'What is Taxaid.gov and how does it work?',
                    answer: 'Taxaid.gov is your trusted tax filing partner - a comprehensive platform for filing income tax returns online. It provides step-by-step guidance, automatic tax calculations, and secure document management to make tax filing simple and efficient.'
                },
                {
                    category: 'general',
                    question: 'Is my personal information secure on Taxaid.gov?',
                    answer: 'Yes, absolutely. Taxaid.gov uses bank-grade encryption and security measures to protect your personal and financial information. All data is encrypted in transit and at rest, and we comply with all relevant data protection regulations.'
                },
                {
                    category: 'tax-filing',
                    question: 'Which ITR form should I choose?',
                    answer: 'The ITR form depends on your income sources: ITR-1 for salaried individuals with income up to â‚¹50 lakhs, ITR-2 for individuals with capital gains or multiple house properties, ITR-3 for business income, and ITR-4 for presumptive business income.'
                },
                {
                    category: 'tax-filing',
                    question: 'Can I file returns for previous years?',
                    answer: 'Yes, you can file belated returns for up to 2 years from the end of the assessment year. However, late filing fees may apply. For very old returns, you may need to file through the income tax department directly.'
                },
                {
                    category: 'tax-filing',
                    question: 'What is the difference between old and new tax regime?',
                    answer: 'The old regime allows various deductions and exemptions but has higher tax rates. The new regime has lower tax rates but fewer deductions. Taxaid.gov automatically calculates both and recommends the better option for your situation.'
                },
                {
                    category: 'payments',
                    question: 'How do I pay my taxes online?',
                    answer: 'You can pay taxes through multiple methods: net banking, UPI, debit/credit cards, or NEFT/RTGS. Taxaid.gov provides integrated payment options and generates the necessary challans automatically.'
                },
                {
                    category: 'payments',
                    question: 'What if my payment fails?',
                    answer: 'If payment fails, check your bank account for any deductions first. If money was deducted but payment shows as failed, contact our support team with transaction details. You can also retry the payment with a different method.'
                },
                {
                    category: 'refunds',
                    question: 'How long does it take to receive tax refunds?',
                    answer: 'Tax refunds typically take 4-6 weeks to process after successful e-verification. You can track your refund status in the Taxaid.gov dashboard or through the income tax department website.'
                },
                {
                    category: 'refunds',
                    question: 'Why is my refund amount different from what I expected?',
                    answer: 'Refund amounts may differ due to processing fees, interest calculations, or adjustments made by the tax department during processing. Check your processed return for detailed explanations.'
                },
                {
                    category: 'technical',
                    question: 'I am getting an error while uploading documents',
                    answer: 'Ensure your documents are in supported formats (PDF, JPG, PNG) and under 5MB each. Clear your browser cache, try a different browser, or contact support if the issue persists.'
                },
                {
                    category: 'technical',
                    question: 'The tax calculation seems incorrect',
                    answer: 'Double-check all entered income and deduction amounts. Taxaid.gov calculations are based on current tax laws. If you still believe there is an error, contact our support team with specific details.'
                },
                {
                    category: 'technical',
                    question: 'Can I use Taxaid.gov on mobile devices?',
                    answer: 'Yes, Taxaid.gov is fully responsive and works on all devices including smartphones and tablets. For the best experience, we recommend using the latest version of your mobile browser.'
                }
            ];
            
            const filteredFAQs = category === 'all' ? faqs : faqs.filter(faq => faq.category === category);
            
            faqList.innerHTML = filteredFAQs.map((faq, index) => `
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFAQ(this)">
                        <span>${faq.question}</span>
                        <i class="fas fa-chevron-down faq-icon"></i>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            ${faq.answer}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleFAQ(questionElement) {
            const faqItem = questionElement.parentElement;
            const answer = faqItem.querySelector('.faq-answer');
            const isActive = questionElement.classList.contains('active');
            
            // Close all other FAQs
            document.querySelectorAll('.faq-question').forEach(q => {
                q.classList.remove('active');
                q.parentElement.querySelector('.faq-answer').classList.remove('active');
            });
            
            // Toggle current FAQ
            if (!isActive) {
                questionElement.classList.add('active');
                answer.classList.add('active');
            }
        }

        function searchFAQ() {
            const searchTerm = document.getElementById('faqSearchInput').value.toLowerCase();
            const faqItems = document.querySelectorAll('.faq-item');
            
            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question span').textContent.toLowerCase();
                const answer = item.querySelector('.faq-answer-content').textContent.toLowerCase();
                
                const matches = question.includes(searchTerm) || answer.includes(searchTerm);
                item.style.display = matches ? 'block' : 'none';
            });
        }

        // Helper function to hide all cards (updated to include communication cards)
        function hideAllCards() {
            const cards = ['supportCenterCard', 'helpDeskCard', 'faqCard', 'fileReturnCard', 'incomeCard', 'deductionsCard', 'reviewCard', 'paymentCard', 'analyticsCard', 'reportsCard', 'refundCard', 'taxCalendarCard', 'adminPanelCard', 'notificationCenterCard'];
            cards.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.add('hidden');
                }
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            initSupabase();
            addFormEventListeners();
            addValidationListeners();
            initializeNotificationSystem();
            checkReturnStatus();
            // Initialize deduction options
            updateDeductionOptions();
        });
    </script>
</body>
</html>
